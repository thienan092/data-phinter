<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ph√¢n T√≠ch ƒê·ªông Th·ªã Tr∆∞·ªùng C√† Ph√™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/ag-grid-community@31.3.2/dist/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <style>
        :root {
            --header-height: 80px;
            --tab-height: 50px;
        }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            background-color: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }
       .main-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
       }
       .tab-content {
            display: none;
            overflow-y: auto;
            flex-grow: 1;
            padding: 1.5rem;
        }
       .tab-content.active {
            display: flex;
            flex-direction: column;
        }
       .tab-btn.active {
            border-color: #1d4ed8;
            color: #1d4ed8;
            background-color: #eff6ff;
        }
       .ag-theme-alpine {
            height: 100%;
            width: 100%;
            flex-grow: 1;
        }
       .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }
        .chart-container canvas {
            flex-grow: 1;
            max-height: 400px;
        }
        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: #ffffff;
        }
       .message {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            max-width: 85%;
            line-height: 1.5;
            white-space: pre-wrap; /* To respect newlines from AI */
        }
       .user-message {
            background-color: #dbeafe;
            align-self: flex-end;
            margin-left: auto;
        }
       .bot-message {
            background-color: #f3f4f6;
            align-self: flex-start;
        }
        .loading-message {
            align-self: flex-start;
            color: #6b7280;
            font-style: italic;
        }
       .ag-cell {
            word-break: break-word !important;
        }
        #task-queue-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 350px;
            max-height: 400px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease-in-out;
            transform: translate(0, 0); /* K√≠ch ho·∫°t tƒÉng t·ªëc GPU ƒë·ªÉ di chuy·ªÉn m∆∞·ª£t m√† */
        }
        #task-queue-header {
            cursor: grab; /* Thay ƒë·ªïi con tr·ªè chu·ªôt khi di qua header */
        }
        #task-queue-header:active {
            cursor: grabbing; /* Thay ƒë·ªïi con tr·ªè chu·ªôt khi ƒëang k√©o */
        }
        .progress-bar {
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar-fill {
            background-color: #3b82f6;
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
        }
    </style>
</head>
<body class="text-gray-800">

<div class="p-4 bg-white shadow-md z-20">
    <div class="flex flex-wrap justify-between items-center">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2 md:mb-0">Ph√¢n T√≠ch Th·ªã Tr∆∞·ªùng C√† Ph√™
        <button id="help-btn" class="ml-3 text-gray-400 hover:text-blue-600 transition-colors duration-200" title="H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </button>
        </h1>
        <div>
            <label for="datepicker" class="text-sm font-medium text-gray-700 mr-2">B·ªô l·ªçc Th·ªùi gian:</label>
            <input id="datepicker" class="border border-gray-300 rounded-md px-3 py-2 text-sm w-64"/>
        </div>
    </div>
</div>

<div class="px-6 bg-white/80 backdrop-blur-sm z-20">
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-6 overflow-x-auto" id="tab-container">
            <button class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="sstTab">D·ªØ Li·ªáu SST</button>
            <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="marketOverviewTab">T·ªïng quan Th·ªã tr∆∞·ªùng</button>
            <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="competitiveAnalysisTab">Ph√¢n t√≠ch C·∫°nh tranh</button>
            <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="logisticsTab">V·∫≠n h√†nh Logistics</button>
            <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="aiAnalysisTab">Ph√¢n t√≠ch AI</button>
        </nav>
    </div>
</div>

<main class="main-container">
    <div id="sstTab" class="tab-content active">
        <div class="mb-4 flex flex-wrap justify-between items-center">
            <div class="flex space-x-2">
                <button id="add-data-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                    Th√™m d·ªØ li·ªáu
                </button>
                <button id="to-csv-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                    üì§ T·∫°o file CSV
                </button>
                <input type="file" id="csv-file-input" class="hidden" accept=".csv">
            </div>
            <div class="flex space-x-2">
                <button id="add-all-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 hidden">
                    Th√™m t·∫•t c·∫£ thay ƒë·ªïi
                </button>
                <button id="check-price-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Ki·ªÉm tra c·∫≠p nh·∫≠t gi√°
                </button>
                 <button id="settings-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-lg shadow-md transition duration-300" title="Thi·∫øt l·∫≠p Hi·ªÉn th·ªã & Kh√≥a">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
            </div>
        </div>
        <div id="sstGrid" class="ag-theme-alpine"></div>
    </div>

    <div id="marketOverviewTab" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 w-full">
            <div class="chart-container lg:col-span-2">
                <h3 class="text-lg font-semibold mb-4 text-center">ƒê·ªãnh v·ªã Gi√° Trung b√¨nh theo Th∆∞∆°ng hi·ªáu (VND/kg)</h3>
                <canvas id="brandPriceChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="text-lg font-semibold mb-4 text-center">Ph√¢n b·ªï Ch·ªßng lo·∫°i C√† ph√™</h3>
                <canvas id="coffeeTypeChart"></canvas>
            </div>
        </div>
    </div>

    <div id="competitiveAnalysisTab" class="tab-content">
        <div class="grid grid-cols-1 gap-6 w-full">
            <div class="chart-container">
                <h3 class="text-lg font-semibold mb-4 text-center">B·∫£n ƒë·ªì ƒê·ªãnh v·ªã Th∆∞∆°ng hi·ªáu</h3>
                <canvas id="brandPositioningChart"></canvas>
            </div>
        </div>
    </div>

    <div id="logisticsTab" class="tab-content">
        <div class="mb-4 p-4 bg-white rounded-lg shadow">
            <label for="input-default-ship-fee" class="text-sm font-medium text-gray-700 mr-2">Ph√≠ ship m·∫∑c ƒë·ªãnh (VND):</label>
            <input type="number" id="input-default-ship-fee" value="30000" step="1000" class="p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
        </div>
        <div class="grid grid-cols-1 gap-6 w-full">
             <div class="chart-container">
                <h3 class="text-lg font-semibold mb-4 text-center">Ph√¢n t√≠ch Hi·ªáu qu·∫£ Ng∆∞·ª°ng Freeship</h3>
                <canvas id="freeshipChart"></canvas>
            </div>
        </div>
    </div>

    <div id="aiAnalysisTab" class="tab-content">
        <div id="chat-container">
            <div id="chat-messages" class="mb-4 flex flex-col space-y-4">
                 <div class="message bot-message">
                    <strong>Xin ch√†o!</strong> T√¥i l√† tr·ª£ l√Ω ph√¢n t√≠ch chi·∫øn l∆∞·ª£c. H√£y ƒë·∫∑t c√¢u h·ªèi v·ªÅ th·ªã tr∆∞·ªùng c√† ph√™ d·ª±a tr√™n d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã, ho·∫∑c ch·ªçn m·ªôt g·ª£i √Ω b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu.
                </div>
            </div>
            <div class="p-4 border-t border-gray-200">
                <p class="text-sm font-medium text-gray-600 mb-2">G·ª£i √Ω ph√¢n t√≠ch:</p>
                <div class="flex flex-wrap gap-2">
                    <button class="prompt-btn bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium py-1 px-3 rounded-full">Ph√¢n kh√∫c th·ªã tr∆∞·ªùng ƒëang c√≥ nh·ªØng ƒë·∫∑c ƒëi·ªÉm g√¨?</button>
                    <button class="prompt-btn bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium py-1 px-3 rounded-full">So s√°nh chi·∫øn l∆∞·ª£c logistics c·ªßa c√°c th∆∞∆°ng hi·ªáu.</button>
                    <button class="prompt-btn bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium py-1 px-3 rounded-full">Y·∫øu t·ªë n√†o quan tr·ªçng nh·∫•t v·ªõi kh√°ch h√†ng cao c·∫•p?</button>
                </div>
                <div class="flex mt-4">
                    <input type="text" id="chat-input" class="flex-grow border border-gray-300 rounded-l-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n...">
                    <button id="chat-submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-r-md hover:bg-blue-700">G·ª≠i</button>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="task-queue-container" class="hidden">
    <div id="task-queue-header" class="p-3 bg-gray-700 text-white font-semibold flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <button id="toggle-queue-btn" class="text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>
            <span>H√†ng ƒë·ª£i t√°c v·ª• (<span id="task-count">0</span>)</span>
        </div>
        <button id="clear-pending-tasks-btn" class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">L√†m Tr·ªëng</button>
    </div>
    <div id="task-queue-body" class="p-3 space-y-3 overflow-y-auto">
    </div>
</div>

<div id="settings-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 class="text-xl font-bold mb-4">Thi·∫øt l·∫≠p Hi·ªÉn th·ªã & Kh√≥a</h2>
        <p class="text-sm text-gray-600 mb-4">T√πy ch·ªânh c√°c c·ªôt ƒë∆∞·ª£c hi·ªÉn th·ªã v√† c√°c c·ªôt ƒë∆∞·ª£c s·ª≠ d·ª•ng l√†m kh√≥a ch·ªëng tr√πng l·∫∑p.</p>
        <div id="settings-list" class="space-y-2 mb-6 max-h-64 overflow-y-auto">
            <!-- Settings will be inserted here by JS -->
        </div>
        <div class="flex justify-end space-x-3">
            <button id="cancel-settings-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">H·ªßy</button>
            <button id="apply-settings-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">√Åp d·ª•ng</button>
        </div>
    </div>
</div>

<div id="api-key-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 class="text-xl font-bold mb-4">Thi·∫øt l·∫≠p Gemini API Key</h2>
        <p class="text-sm text-gray-600 mb-4">Vui l√≤ng cung c·∫•p kh√≥a API Gemini c·ªßa b·∫°n ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng ph√¢n t√≠ch AI. Kh√≥a s·∫Ω ƒë∆∞·ª£c l∆∞u tr·ªØ trong phi√™n l√†m vi·ªác c·ªßa tr√¨nh duy·ªát.</p>
        <div>
            <label for="gemini-api-key-input" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
            <input type="password" id="gemini-api-key-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
        </div>
        <div class="flex justify-end space-x-3 mt-6">
            <button id="cancel-api-key-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">H·ªßy</button>
            <button id="save-api-key-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">L∆∞u</button>
        </div>
    </div>
</div>

<div id="help-modal" class="modal-overlay hidden">
    <div class="modal-content relative max-w-2xl">
        <button id="close-help-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        
        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">H∆∞·ªõng d·∫´n S·ª≠ d·ª•ng</h2>
        
        <div class="text-sm text-gray-700 space-y-4 max-h-[70vh] overflow-y-auto pr-2">
            <p>H·ªá th·ªëng ph√¢n t√≠ch ƒë·ªông cho th·ªã tr∆∞·ªùng c√† ph√™ b√°n l·∫ª (b·∫£n portable).</p>
            
            <div>
                <h3 class="text-lg font-semibold mb-2 text-gray-900">C√°c Th√†nh ph·∫ßn Ch√≠nh</h3>
                <ul class="list-disc list-inside space-y-2 pl-2">
                    <li><strong>L·ªçc theo Th·ªùi gian:</strong> Cho ph√©p b·∫°n ch·ªçn m·ªôt kho·∫£ng th·ªùi gian ƒë·ªÉ ph√¢n t√≠ch. To√†n b·ªô d·ªØ li·ªáu v√† bi·ªÉu ƒë·ªì tr√™n trang s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t theo l·ª±a ch·ªçn c·ªßa b·∫°n.</li>
                    <li><strong>C√°c Tab ƒêi·ªÅu h∆∞·ªõng:</strong>
                        <ul class="list-disc list-inside ml-5 mt-1 space-y-1">
                            <li><strong>D·ªØ li·ªáu SST:</strong> N∆°i hi·ªÉn th·ªã Ngu·ªìn Ch√¢n L√Ω Duy Nh·∫•t (Single Source of Truth). ƒê√¢y l√† trung t√¢m qu·∫£n l√Ω d·ªØ li·ªáu c·ªßa b·∫°n v√† t·∫•t c·∫£ c√°c ph√¢n t√≠ch s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán d·ª±a tr√™n d·ªØ li·ªáu ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã t·∫°i ƒë√¢y.</li>
                            <li><strong>T·ªïng quan Th·ªã tr∆∞·ªùng:</strong> Cung c·∫•p c√°i nh√¨n to√†n c·∫£nh v·ªÅ ƒë·ªãnh v·ªã gi√° c·ªßa c√°c th∆∞∆°ng hi·ªáu v√† s·ª± ph√¢n b·ªï c·ªßa c√°c ch·ªßng lo·∫°i c√† ph√™.</li>
                            <li><strong>Ph√¢n t√≠ch C·∫°nh tranh:</strong> Tr·ª±c quan h√≥a v·ªã th·∫ø c·ªßa c√°c th∆∞∆°ng hi·ªáu tr√™n th·ªã tr∆∞·ªùng d·ª±a tr√™n gi√° trung b√¨nh v√† s·ªë l∆∞·ª£ng s·∫£n ph·∫©m (SKUs).</li>
                            <li><strong>V·∫≠n h√†nh Logistics:</strong> T√≠ch h·ª£p m√¥ ph·ªèng t·ªïng chi ph√≠ th·ª±c t·∫ø kh√°ch h√†ng ph·∫£i tr·∫£ d·ª±a tr√™n gi√° tr·ªã gi·ªè h√†ng v√† ch√≠nh s√°ch freeship c·ªßa t·ª´ng th∆∞∆°ng hi·ªáu.</li>
                            <li><strong>Ph√¢n t√≠ch AI:</strong> Cho ph√©p b·∫°n ƒë·∫∑t c√¢u h·ªèi b·∫±ng ng√¥n ng·ªØ t·ª± nhi√™n ƒë·ªÉ nh·∫≠n ƒë∆∞·ª£c c√°c ph√¢n t√≠ch v√† khuy·∫øn ngh·ªã chi·∫øn l∆∞·ª£c t·ª´ AI d·ª±a tr√™n c√°c th·ªëng k√™ t·ª´ d·ªØ li·ªáu hi·ªán t·∫°i.</li>
                        </ul>
                    </li>
                </ul>
            </div>

            <div>
                <h3 class="text-lg font-semibold mb-2 text-gray-900">Ch·ª©c nƒÉng Tab D·ªØ li·ªáu SST</h3>
                 <ul class="list-disc list-inside space-y-2 pl-2">
                    <li><strong>Th√™m d·ªØ li·ªáu:</strong> Cho ph√©p b·∫°n t·∫£i l√™n m·ªôt file CSV ƒë·ªÉ b·ªï sung d·ªØ li·ªáu v√†o h·ªá th·ªëng. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g√°n c√°c ID duy nh·∫•t cho c√°c h√†ng kh√¥ng c√≥ ID.</li>
                    <li><strong>T·∫°o file CSV:</strong> T·∫£i xu·ªëng to√†n b·ªô d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã ra file CSV.</li>
                    <li><strong>Thi·∫øt l·∫≠p Hi·ªÉn th·ªã & Kh√≥a:</strong>
                        <ul class="list-disc list-inside ml-5 mt-1 space-y-2">
                            <li class="flex items-start">
                                <div class="flex-shrink-0 w-6 flex justify-center pt-0.5">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <span class="ml-2">B·∫≠t/t·∫Øt hi·ªÉn th·ªã c·ªßa t·ª´ng c·ªôt tr√™n l∆∞·ªõi hi·ªÉn th·ªã.</span>
                            </li>
                            <li class="flex items-start">
                                <div class="flex-shrink-0 w-6 flex justify-center pt-0.5">
                                    <input id="deduplicate-key" type="checkbox" class="form-checkbox h-5 w-5 text-purple-600 rounded focus:ring-purple-500" checked>
                                </div>
                                <label for="deduplicate-key" class="ml-2">
                                    Ch·ªçn c√°c c·ªôt l√†m "kh√≥a" ƒë·ªÉ ch·ªëng tr√πng l·∫∑p. C√°c h√†ng c√≥ c√πng gi√° tr·ªã tr√™n t·∫•t c·∫£ c√°c c·ªôt ƒë√£ ch·ªçn s·∫Ω b·ªã ·∫©n ƒëi, ch·ªâ gi·ªØ l·∫°i h√†ng ƒë·∫ßu ti√™n theo th·ª© t·ª± s·∫Øp x·∫øp hi·ªán t·∫°i.
                                </label>
                            </li>
                        </ul>
                    </li>
                     <li><strong>Ki·ªÉm tra c·∫≠p nh·∫≠t gi√°:</strong> T·ª± ƒë·ªông truy c·∫≠p v√†o c√°c "Link M√¥ t·∫£" (c·ªôt "Link") v√† c·∫≠p nh·∫≠t l·∫°i gi√° cho c√°c s·∫£n ph·∫©m. Tr·∫°ng th√°i s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t:
                        <ul class="list-disc list-inside ml-5 mt-1 space-y-1">
                            <li><strong>M·ªõi:</strong> Gi√° ƒë√£ thay ƒë·ªïi. Nh·∫•n v√†o n√∫t ƒë·ªÉ t·∫°o m·ªôt phi√™n b·∫£n m·ªõi v·ªõi gi√° ƒë√£ c·∫≠p nh·∫≠t.</li>
                            <li><strong>C·∫£nh b√°o (s·ªë):</strong> Kh√¥ng t√¨m th·∫•y gi√° b·∫±ng vi·ªác scraping v·ªõi selector (c·ªôt "HTML"), nh∆∞ng t√¨m th·∫•y nhi·ªÅu h∆°n 1 k·∫øt qu·∫£ kh·ªõp v·ªõi gi√° c≈© trong h√†ng d·ªØ li·ªáu. C·∫ßn c·∫≠p nh·∫≠t l·∫°i selector ƒë·ªÉ c√≥ th·ªÉ scraping th√†nh c√¥ng.</li>
                            <li><strong>L·ªói:</strong> Kh√¥ng t√¨m th·∫•y gi√° b·∫±ng vi·ªác scraping v·ªõi selector (c·ªôt "HTML") v√† c≈©ng kh√¥ng t√¨m th·∫•y gi√° kh·ªõp v·ªõi gi√° c≈© trong h√†ng d·ªØ li·ªáu. Nhi·ªÅu kh·∫£ nƒÉng URL ƒë√£ b·ªã thay ƒë·ªïi.</li>
                        </ul>
                     </li>
                     <li><strong>Th√™m t·∫•t c·∫£ thay ƒë·ªïi:</strong> T·ª± ƒë·ªông t·∫°o phi√™n b·∫£n m·ªõi cho t·∫•t c·∫£ c√°c h√†ng c√≥ tr·∫°ng th√°i l√† "M·ªõi".</li>
                </ul>
            </div>

             <div>
                <h3 class="text-lg font-semibold mb-2 text-gray-900">H√†ng ƒë·ª£i T√°c v·ª•</h3>
                <p>H√†ng ƒë·ª£i n√†y xu·∫•t hi·ªán khi b·∫°n ch·∫°y ch·ª©c nƒÉng "Ki·ªÉm tra c·∫≠p nh·∫≠t gi√°". N√≥ cho ph√©p b·∫°n theo d√µi ti·∫øn tr√¨nh v√† qu·∫£n l√Ω c√°c t√°c v·ª•. B·∫°n c√≥ th·ªÉ k√©o th·∫£, thu g·ªçn ƒë·ªÉ ti·∫øt ki·ªám kh√¥ng gian.</p>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 1. DATA SECTION (SYNCHRONIZED SST) ---
    // Set sst_data to empty as requested for debugging.
    let sst_data = [];
    
    // --- 3. GLOBAL STATE & UTILS ---
    let charts = {};
    let taskQueue = [];
    let avgTaskTime = 15000;
    let completedTaskTimes = [];
    let sstGridOptions;
    let deduplicationKeys = ["ID", "S·∫£n ph·∫©m", "Th∆∞∆°ng hi·ªáu", "Ngu·ªìn", "Link M√¥ t·∫£", "Lo·∫°i C√† ph√™", "ƒê∆°n v·ªã t√≠nh", "Gi√° ni√™m y·∫øt (VND)", "Ph√≠ ship (VND)", "Ng∆∞·ª°ng Freeship (VND)", "T·∫°i ƒê·ªãa Ph∆∞∆°ng", "HTML", "date", "updateStatus", "N·ªÅn t·∫£ng TMƒêT"];
    let geminiApiKey = sessionStorage.getItem('geminiApiKey') || null;

    const getFormattedDate = () => {
        const today = new Date();
        const year = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        return `${year}-${mm}-${dd}`;
    };

    const parseWeight = (weightStr) => {
        if (!weightStr) return 0;
        const value = parseFloat(String(weightStr).replace(/,/g, ''));
        if (String(weightStr).toLowerCase().includes('kg')) return value * 1000;
        return value;
    };

    const calculatePricePerKg = (item) => {
        const price = parseNumericValue(item['Gi√° ni√™m y·∫øt (VND)']);
        const weightInGrams = parseWeight(item['ƒê∆°n v·ªã t√≠nh']);
        if (weightInGrams === 0 || !price) return 0;
        return (price / weightInGrams) * 1000;
    };

    const parseDateString = (dateStr) => {
        if (!dateStr || typeof dateStr !== 'string') return null;
        
        let d;
        const parts = dateStr.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})$/);
        if (parts) {
            const isoDateStr = `${parts[3]}-${String(parts[2]).padStart(2, '0')}-${String(parts[1]).padStart(2, '0')}T00:00:00`;
            d = new Date(isoDateStr);
            if (!isNaN(d.getTime())) return d;
        }

        d = new Date(dateStr);
        if (!isNaN(d.getTime())) return d;
        
        return null;
    };

    const parseCsvLine = (line) => {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current);
        return result;
    };

    const generateSelectorFromHtml = (htmlString) => {
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            let deepestElement = null;
            let maxDepth = -1;

            function findDeepest(elem, depth) {
                if (elem.nodeType === Node.ELEMENT_NODE && elem.textContent && /\d/.test(elem.textContent)) {
                    if (depth > maxDepth) {
                        maxDepth = depth;
                        deepestElement = elem;
                    }
                }
                for (const child of elem.children) {
                    findDeepest(child, depth + 1);
                }
            }

            findDeepest(doc.body, 0);

            if (!deepestElement) return null;

            let current = deepestElement;
            let path = [];
            
            while(current && current.tagName && current.tagName.toLowerCase() !== 'body') {
                const tagName = current.tagName.toLowerCase();
                const id = current.id;
                const classes = Array.from(current.classList).filter(c => c && typeof c === 'string').join('.');
                
                let segment = tagName;
                if (id) {
                    segment = `#${id}`;
                    path.unshift(segment);
                    break; 
                } else if (classes) {
                    segment += `.${classes}`;
                }

                path.unshift(segment);

                if (classes && !['price', 'amount'].every(c => classes.includes(c))) {
                    break;
                }
                
                current = current.parentElement;
            }

            return path.join(' > ');

        } catch (e) {
            console.error("Error generating selector from HTML:", e);
            return null;
        }
    };

    const parseNumericValue = (value) => {
        if (typeof value !== 'string' && typeof value !== 'number') {
            return null;
        }
        const strValue = String(value);
        const match = strValue.match(/(\d[\d,.]*)/);
        if (match) {
            return parseFloat(match[0].replace(/,/g, ''));
        }
        return null;
    };

    const makeDraggable = (element, handle) => {
        let active = false;
        let startMouseX, startMouseY;
        let startElemX, startElemY;

        handle.addEventListener("mousedown", dragStart, false);

        function dragStart(e) {
            // NgƒÉn ch·∫∑n c√°c h√†nh vi m·∫∑c ƒë·ªãnh (nh∆∞ ch·ªçn vƒÉn b·∫£n)
            e.preventDefault();

            // L·∫•y v·ªã tr√≠ ban ƒë·∫ßu c·ªßa con tr·ªè chu·ªôt
            startMouseX = e.clientX;
            startMouseY = e.clientY;

            // L·∫•y v·ªã tr√≠ transform hi·ªán t·∫°i c·ªßa ph·∫ßn t·ª≠
            const transformMatrix = new WebKitCSSMatrix(window.getComputedStyle(element).transform);
            startElemX = transformMatrix.m41;
            startElemY = transformMatrix.m42;
            
            // K√≠ch ho·∫°t tr·∫°ng th√°i k√©o
            active = true;

            // L·∫Øng nghe s·ª± ki·ªán tr√™n to√†n b·ªô t√†i li·ªáu ƒë·ªÉ k√©o kh√¥ng b·ªã gi√°n ƒëo·∫°n
            document.addEventListener("mousemove", drag, false);
            document.addEventListener("mouseup", dragEnd, false);
        }

        function drag(e) {
            if (active) {
                // T√≠nh to√°n kho·∫£ng c√°ch chu·ªôt ƒë√£ di chuy·ªÉn so v·ªõi ƒëi·ªÉm b·∫Øt ƒë·∫ßu
                const deltaX = e.clientX - startMouseX;
                const deltaY = e.clientY - startMouseY;

                // V·ªã tr√≠ m·ªõi = V·ªã tr√≠ ban ƒë·∫ßu c·ªßa ph·∫ßn t·ª≠ + Kho·∫£ng c√°ch chu·ªôt ƒë√£ di chuy·ªÉn
                const newX = startElemX + deltaX;
                const newY = startElemY + deltaY;

                // √Åp d·ª•ng v·ªã tr√≠ m·ªõi b·∫±ng transform3d ƒë·ªÉ t·ªëi ∆∞u hi·ªáu su·∫•t
                element.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
            }
        }

        function dragEnd(e) {
            // H·ªßy tr·∫°ng th√°i k√©o
            active = false;
            // D·ªçn d·∫πp c√°c s·ª± ki·ªán l·∫Øng nghe ƒë·ªÉ ti·∫øt ki·ªám t√†i nguy√™n
            document.removeEventListener("mousemove", drag, false);
            document.removeEventListener("mouseup", dragEnd, false);
            adjustTaskQueuePosition();
        }
    };

    const adjustTaskQueuePosition = () => {
        const element = document.getElementById('task-queue-container');
        // L·∫•y k√≠ch th∆∞·ªõc c·ªßa c·ª≠a s·ªï tr√¨nh duy·ªát
        const chieuRongManHinh = window.innerWidth;
        const chieuCaoManHinh = window.innerHeight;
        const khoangDem = 16; // Kho·∫£ng ƒë·ªám 1rem ƒë·ªÉ kh√¥ng b·ªã d√≠nh s√°t v√†o c·∫°nh

        // L·∫•y th√¥ng tin v·ªã tr√≠ v√† k√≠ch th∆∞·ªõc hi·ªán t·∫°i c·ªßa thanh H√†ng ƒë·ª£i
        const rect = element.getBoundingClientRect();

        // L·∫•y gi√° tr·ªã transform X v√† Y hi·ªán t·∫°i m·ªôt l·∫ßn duy nh·∫•t
        const transformMatrix = new WebKitCSSMatrix(window.getComputedStyle(element).transform);
        let viTriX_Moi = transformMatrix.m41;
        let viTriY_Moi = transformMatrix.m42;

        // --- Ki·ªÉm tra v√† t√≠nh to√°n v·ªã tr√≠ m·ªõi cho c·∫£ 4 c·∫°nh ---

        // 1. Ki·ªÉm tra c·∫°nh ph·∫£i
        if (rect.right > chieuRongManHinh) {
            viTriX_Moi -= (rect.right - chieuRongManHinh + khoangDem);
        }

        // 2. Ki·ªÉm tra c·∫°nh tr√°i
        if (rect.left < 0) {
            viTriX_Moi += (Math.abs(rect.left) + khoangDem);
        }

        // 3. Ki·ªÉm tra c·∫°nh d∆∞·ªõi
        if (rect.bottom > chieuCaoManHinh) {
            viTriY_Moi -= (rect.bottom - chieuCaoManHinh + khoangDem);
        }

        // 4. Ki·ªÉm tra c·∫°nh tr√™n
        if (rect.top < 0) {
            viTriY_Moi += (Math.abs(rect.top) + khoangDem);
        }

        // √Åp d·ª•ng v·ªã tr√≠ ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh m·ªôt l·∫ßn duy nh·∫•t
        element.style.transform = `translate3d(${viTriX_Moi}px, ${viTriY_Moi}px, 0)`;
    };


    // --- 4. FUNCTION DEFINITIONS ---
    const createChart = (ctx, type, data, options) => {
        if (charts[ctx.canvas.id]) charts[ctx.canvas.id].destroy();
        charts[ctx.canvas.id] = new Chart(ctx, { type, data, options });
    };

    const updateChartsFromGridData = () => {
        const dataForCharts = [];
        if (sstGridOptions.api) {
            sstGridOptions.api.forEachNodeAfterFilter(node => {
                dataForCharts.push(node.data);
            });
        }
        
        const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
        switch(activeTab) {
            case 'marketOverviewTab':
                updateBrandPriceChart(dataForCharts);
                updateCoffeeTypeChart(dataForCharts);
                break;
            case 'competitiveAnalysisTab':
                updateBrandPositioningChart(dataForCharts);
                break;
            case 'logisticsTab':
                updateFreeshipChart(dataForCharts);
                break;
        }
    };

    const filterDataByDateRange = (data, startDate, endDate) => {
        filteredData = [...data];
        if (!(!startDate || !endDate)) {
            const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), 0, 0, 0, 0).getTime();
            const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate(), 23, 59, 59, 999).getTime();

            filteredData = filteredData.filter(item => {
                const itemDate = parseDateString(item.date);
                if (!itemDate) return false;
                const itemTime = itemDate.getTime();
                return itemTime >= start && itemTime <= end;
            });
        }
        return filteredData;
    };

    const dedupData = (data) => {
        filteredData = [...data];
        if (deduplicationKeys.length === 0) return;

        const seen = new Set();
        const rowsToRemove = [];
        const rowsToKeep = [];
        const nodesToProcess = [];
        
        filteredData.forEach(item => {
            const key = deduplicationKeys.map(k => item[k]).join('||');
            console.log(`Checking item with key: ${key}`);
            if (seen.has(key)) {
                rowsToRemove.push(item);
            } else {
                seen.add(key);
                rowsToKeep.push(item);
            }
        });

        if (rowsToRemove.length > 0) {
            filteredData = rowsToKeep;
        }

        return filteredData;
    };

    const applyAllFilters = (startDate, endDate) => {
        filteredData = [...sst_data];
        
        const fromDate = picker.getStartDate();
        const toDate = picker.getEndDate();
        filteredData = filterDataByDateRange(filteredData, fromDate, toDate);
        filteredData = dedupData(filteredData);

        

        currentFilteredData = filteredData;
        rowsToRemove = currentFilteredData.filter(item => !filteredData.includes(item));
        console.log("rowsToRemove:", rowsToRemove);
        if (sstGridOptions && sstGridOptions.api) {
            sstGridOptions.api.applyTransaction({ remove: rowsToRemove });
            sstGridOptions.api.setRowData(currentFilteredData);
        }
    };

    const updateBrandPriceChart = (data) => {
        const brandData = data.reduce((acc, item) => {
            const brand = item['Th∆∞∆°ng hi·ªáu'];
            if (!acc[brand]) acc[brand] = { total_price_per_kg: 0, count: 0 };
            const pricePerKg = calculatePricePerKg(item);
            if(pricePerKg > 0) {
                acc[brand].total_price_per_kg += pricePerKg;
                acc[brand].count++;
            }
            return acc;
        }, {});
        const labels = Object.keys(brandData).filter(brand => brandData[brand].count > 0);
        const avgPrices = labels.map(brand => brandData[brand].total_price_per_kg / brandData[brand].count);
        const ctx = document.getElementById('brandPriceChart').getContext('2d');
        createChart(ctx, 'bar', {
            labels,
            datasets: [{
                label: 'Gi√° trung b√¨nh (VND/kg)',
                data: avgPrices,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        }, {
            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
            scales: { x: { beginAtZero: true, ticks: { callback: value => value.toLocaleString('vi-VN') + 'ƒë' } } },
            plugins: { legend: { display: false } }
        });
    };

    const updateCoffeeTypeChart = (data) => {
        const typeData = data.reduce((acc, item) => {
            let type = 'Blend';
            const coffeeType = item['Lo·∫°i C√† ph√™'] ? item['Lo·∫°i C√† ph√™'].toLowerCase() : '';
            if (coffeeType.includes('robusta') && !coffeeType.includes('arabica')) type = '100% Robusta';
            else if (coffeeType.includes('arabica') && !coffeeType.includes('robusta')) type = '100% Arabica';
            else if (coffeeType.includes('specialty') || coffeeType.includes('moka') || coffeeType.includes('bourbon') || coffeeType.includes('organic') || coffeeType.includes('yirgacheffe') || coffeeType.includes('honduras')) type = 'Specialty/Single Origin';
            acc[type] = (acc[type] || 0) + 1;
            return acc;
        }, {});
        const ctx = document.getElementById('coffeeTypeChart').getContext('2d');
        createChart(ctx, 'doughnut', {
            labels: Object.keys(typeData),
            datasets: [{ data: Object.values(typeData), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'] }]
        }, { responsive: true, maintainAspectRatio: false });
    };
    
    const updateBrandPositioningChart = (data) => {
      const pricesPerKg = data.map(item => calculatePricePerKg(item)).filter(p => p !== null && isFinite(p));
      pricesPerKg.sort((a, b) => a - b);

      const getPercentile = (arr, q) => {
          if (arr.length === 0) return null;
          const pos = (arr.length - 1) * q;
          const base = Math.floor(pos);
          const rest = pos - base;
          if (arr[base + 1] !== undefined) {
              return arr[base] + rest * (arr[base + 1] - arr[base]);
          } else {
              return arr[base];
          }
      };

      const q1 = getPercentile(pricesPerKg, 0.25);
      const q3 = getPercentile(pricesPerKg, 0.75);
        
      const brandData = data.reduce((acc, item) => {
        const brand = item['Th∆∞∆°ng hi·ªáu'];
        if (!acc[brand]) acc[brand] = { skus: 0, total_price_per_kg: 0, count: 0 };
        acc[brand].skus++;
        const pricePerKg = calculatePricePerKg(item);
        if (pricePerKg > 0) {
          acc[brand].total_price_per_kg += pricePerKg;
          acc[brand].count++;
        }
        return acc;
      }, {});

      const brandColors = {};
      const colorPalette = ['#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9A6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075'];
      Object.keys(brandData).forEach((brand, index) => {
        brandColors[brand] = colorPalette[index % colorPalette.length];
      });

      const segmentColors = {
        'Ph·ªï th√¥ng': 'rgba(54, 162, 235, 0.7)',
        'Trung-Cao c·∫•p': 'rgba(255, 206, 86, 0.7)',
        'ƒê·∫∑c s·∫£n/Luxury': 'rgba(255, 99, 132, 0.7)'
      };

      const groupedBySegment = {
        'Ph·ªï th√¥ng': [],
        'Trung-Cao c·∫•p': [],
        'ƒê·∫∑c s·∫£n/Luxury': []
      };

      Object.keys(brandData).forEach((brand) => {
        const stats = brandData[brand];
        const avgPrice = stats.count > 0 ? stats.total_price_per_kg / stats.count : 0;
        const skus = stats.skus;
        let segment = 'Ph·ªï th√¥ng';
        const dataForAI = [];
        sstGridOptions.api.forEachNodeAfterFilter(node => dataForAI.push(node.data));
        
        const global_stats = calculateStats(dataForAI);
        if (avgPrice > (global_stats.price_percentile_75*1000)) segment = 'ƒê·∫∑c s·∫£n/Luxury';
        else if (avgPrice >= (global_stats.price_percentile_25*1000)) segment = 'Trung-Cao c·∫•p';

        groupedBySegment[segment].push({
          x: avgPrice,
          y: skus,
          r: skus * 4 + 6,
          brand: brand
        });
      });

      const datasets = Object.entries(groupedBySegment)
        .filter(([_, points]) => points.length > 0)
        .map(([segment, points]) => ({
          label: segment,
          data: points,
          backgroundColor: segmentColors[segment],
          borderColor: segmentColors[segment],
          borderWidth: 2
        }));

      const ctx = document.getElementById('brandPositioningChart').getContext('2d');
      createChart(ctx, 'bubble', { datasets }, {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: 'M·ª©c gi√° trung b√¨nh/kg (VND)' },
              ticks: {
                callback: value => value.toLocaleString('vi-VN') + 'ƒë'
              }
            },
            y: {
              title: { display: true, text: 'S·ªë l∆∞·ª£ng d√≤ng s·∫£n ph·∫©m (SKUs)' },
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          },
          plugins: {
            title: { display: true, text: 'Ph√¢n kh√∫c Th∆∞∆°ng hi·ªáu theo AI' }, 
            legend: {
                display: true,
                position: 'top',
                labels: {
                  boxWidth: 20,
                  padding: 15
                }
            },
            tooltip: {
              callbacks: {
                title: (ctx) => `${ctx[0]?.dataset?.label}`,
                label: function(context) {
                  const item = context.raw;
                  return `${item.brand}: (Gi√° TB: ${Math.round(item.x).toLocaleString('vi-VN')}ƒë, SKU: ${item.y})`;
                }
              }
            }
          }
        });
    };

    const updateFreeshipChart = (data) => {
        const datasets = [];
        const colors = ['#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9A6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075'];
        const uniqueBrands = [...new Set(data.map(item => item['Th∆∞∆°ng hi·ªáu']))];
        const phiShipMacDinh = parseInt(document.getElementById('input-default-ship-fee').value);

        uniqueBrands.forEach((brand, index) => {
            const brandData = data.find(item => item['Th∆∞∆°ng hi·ªáu'] === brand);
            const freeship = parseNumericValue(brandData?.['Ng∆∞·ª°ng Freeship (VND)']);
            const fee = parseNumericValue(brandData?.['Ph√≠ ship (VND)']) || phiShipMacDinh;

            if (freeship === null) return;

            const dataPoints = [];
            for (let value = 0; value <= 700000; value += 25000) {
                let totalCost = (value > 0 && value < freeship) ? value + fee : value;
                dataPoints.push({ x: value, y: totalCost });
            }
            datasets.push({
                label: brand, data: dataPoints, borderColor: colors[index % colors.length],
                fill: false, tension: 0.1
            });
        });

        const ctx = document.getElementById('freeshipChart').getContext('2d');
        createChart(ctx, 'line', { datasets }, {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Gi√° tr·ªã gi·ªè h√†ng (VND)' }, ticks: { callback: value => value.toLocaleString('vi-VN') + 'ƒë' } },
                y: { title: { display: true, text: 'T·ªïng chi ph√≠ kh√°ch h√†ng tr·∫£ (VND)' }, ticks: { callback: value => value.toLocaleString('vi-VN') + 'ƒë' } }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: (ctx) => `Gi·ªè h√†ng: ${ctx[0].parsed.x.toLocaleString('vi-VN')}ƒë`,
                        label: (ctx) => `${ctx.dataset.label}: T·ªïng tr·∫£ ${ctx.parsed.y.toLocaleString('vi-VN')}ƒë`
                    }
                }
            }
        });
    };

    const addMessage = (text, sender, elementId = null) => {
        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        if (elementId) {
            messageDiv.id = elementId;
        }

        if (sender === 'user') {
            messageDiv.classList.add('user-message');
            messageDiv.textContent = text;
        } else if (sender === 'bot') {
            messageDiv.classList.add('bot-message');
            messageDiv.innerHTML = text; // Use innerHTML to render formatted text
        } else if (sender === 'loading') {
            messageDiv.classList.add('loading-message');
            messageDiv.textContent = text;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return messageDiv;
    };

    const calculateStats = (data) => {
        if (!data || data.length === 0) {
            return { error: "No data available for analysis." };
        }

        const pricesPerKg = data.map(item => calculatePricePerKg(item)).filter(p => p !== null && isFinite(p));
        pricesPerKg.sort((a, b) => a - b);

        const getPercentile = (arr, q) => {
            if (arr.length === 0) return null;
            const pos = (arr.length - 1) * q;
            const base = Math.floor(pos);
            const rest = pos - base;
            if (arr[base + 1] !== undefined) {
                return arr[base] + rest * (arr[base + 1] - arr[base]);
            } else {
                return arr[base];
            }
        };
        
        const freeshipSeries = data.map(item => parseNumericValue(item['Ng∆∞·ª°ng Freeship (VND)'])).filter(v => v !== null);
        freeshipSeries.sort((a, b) => a - b);

        const stats = {
            num_products: data.length,
            num_brands: new Set(data.map(item => item['Th∆∞∆°ng hi·ªáu'])).size,
            current_year: new Date().getFullYear(),
            price_min_per_kg: pricesPerKg.length > 0 ? Math.round(pricesPerKg[0]).toLocaleString('vi-VN') : 'N/A',
            price_max_per_kg: pricesPerKg.length > 0 ? Math.round(pricesPerKg[pricesPerKg.length - 1]).toLocaleString('vi-VN') : 'N/A',
            price_percentile_25: pricesPerKg.length > 0 ? Math.round(getPercentile(pricesPerKg, 0.25)).toLocaleString('vi-VN') : 'N/A',
            price_percentile_75: pricesPerKg.length > 0 ? Math.round(getPercentile(pricesPerKg, 0.75)).toLocaleString('vi-VN') : 'N/A',
            main_sources: [...new Set(data.map(item => item['Ngu·ªìn']))].slice(0, 5).join(', ') + (new Set(data.map(item => item['Ngu·ªìn'])).size > 5 ? '...' : ''),
            freeship_threshold_min: freeshipSeries.length > 0 ? Math.round(freeshipSeries[0]).toLocaleString('vi-VN') : 'N/A',
            freeship_threshold_max: freeshipSeries.length > 0 ? Math.round(freeshipSeries[freeshipSeries.length - 1]).toLocaleString('vi-VN') : 'N/A',
            freeship_threshold_avg: freeshipSeries.length > 0 ? Math.round(getPercentile(freeshipSeries, 0.5)).toLocaleString('vi-VN') : 'N/A', // Median
        };

        return stats;
    };

    const generateDynamicPrompt = (stats, userQuestion) => {
        if (stats.error) {
            return `Error: ${stats.error}`;
        }

        const promptTemplate = `
**B·ªëi c·∫£nh v√† Vai tr√≤:**
B·∫°n l√† m·ªôt AI chuy√™n gia ph√¢n t√≠ch chi·∫øn l∆∞·ª£c th·ªã tr∆∞·ªùng b√°n l·∫ª, ƒë∆∞·ª£c cung c·∫•p m·ªôt b·ªô d·ªØ li·ªáu (SST) g·ªìm **{num_products}** s·∫£n ph·∫©m c√† ph√™ t·ª´ **{num_brands}** th∆∞∆°ng hi·ªáu kh√°c nhau t·∫°i Vi·ªát Nam, ƒë∆∞·ª£c thu th·∫≠p trong kho·∫£ng th·ªùi gian nƒÉm **{current_year}**. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ƒë∆∞a ra c√°c k·∫øt lu·∫≠n v√† khuy·∫øn ngh·ªã chi·∫øn l∆∞·ª£c d·ª±a tr√™n d·ªØ li·ªáu n√†y, tr·∫£ l·ªùi c√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng theo m·ªôt t∆∞ duy ph√¢n t√≠ch s√¢u s·∫Øc.

**T∆∞ t∆∞·ªüng Ph√¢n t√≠ch C·ªët l√µi (Core Analytical Philosophy):**
Khi ph√¢n t√≠ch, h√£y lu√¥n ghi nh·ªõ nh·ªØng nguy√™n t·∫Øc sau:
1.  **Th·ªã tr∆∞·ªùng l√† ƒëa t·∫ßng, kh√¥ng ph·∫≥ng:** ƒê·ª´ng nh√¨n v√†o gi√° trung b√¨nh m·ªôt c√°ch ƒë∆°n thu·∫ßn. H√£y ph√¢n t√≠ch th·ªã tr∆∞·ªùng qua c√°c ph√¢n kh√∫c gi√°. D·ªØ li·ªáu cho th·∫•y m·ªôt s·ª± ph√¢n h√≥a r√µ r·ªát:
    * **Ph·ªï th√¥ng (d∆∞·ªõi {price_percentile_25} VND/kg):** Cu·ªôc chi·∫øn v·ªÅ gi√°.
    * **Trung c·∫•p ({price_percentile_25} - {price_percentile_75} VND/kg):** S√¢n ch∆°i c·ªßa c√°c th∆∞∆°ng hi·ªáu chu·ªói v√† c√°c nh√† rang xay m·ªõi n·ªïi, c·∫°nh tranh b·∫±ng s·ª± c√¢n b·∫±ng gi·ªØa ch·∫•t l∆∞·ª£ng v√† gi√°.
    * **Cao c·∫•p & ƒê·∫∑c s·∫£n (tr√™n {price_percentile_75} VND/kg):** C·∫°nh tranh b·∫±ng c√¢u chuy·ªán, s·ª± minh b·∫°ch v√† ch·∫•t l∆∞·ª£ng v∆∞·ª£t tr·ªôi.
2.  **Logistics l√† m·ªôt v≈© kh√≠ chi·∫øn l∆∞·ª£c:** Ch√≠nh s√°ch v·∫≠n chuy·ªÉn ƒë·ªãnh h√¨nh l·∫°i b·∫£n ƒë·ªì c·∫°nh tranh. Ng∆∞·ª°ng freeship (dao ƒë·ªông t·ª´ **{freeship_threshold_min} VND** ƒë·∫øn **{freeship_threshold_max} VND** trong b·ªô d·ªØ li·ªáu n√†y) kh√¥ng ph·∫£i l√† chi ph√≠, m√† l√† m·ªôt c√¥ng c·ª• t√¢m l√Ω ƒë·ªÉ t·ªëi ∆∞u h√≥a gi√° tr·ªã ƒë∆°n h√†ng trung b√¨nh (AOV).
3.  **Minh b·∫°ch x√¢y d·ª±ng l√≤ng tin:** ·ªû ph√¢n kh√∫c cao c·∫•p, kh√°ch h√†ng y√™u c·∫ßu s·ª± minh b·∫°ch tuy·ªát ƒë·ªëi v·ªÅ ngu·ªìn g·ªëc, t·ª∑ l·ªá ph·ªëi tr·ªôn v√† ph∆∞∆°ng ph√°p ch·∫ø bi·∫øn. ƒê√¢y l√† m·ªôt y√™u c·∫ßu b·∫Øt bu·ªôc, kh√¥ng ph·∫£i l√† m·ªôt l·ª±a ch·ªçn.

**D·ªØ li·ªáu T√≥m t·∫Øt t·ª´ SST:**
* **Kho·∫£ng gi√° (ƒë√£ chu·∫©n h√≥a theo kg):** T·ª´ **{price_min_per_kg} VND/kg** ƒë·∫øn **{price_max_per_kg} VND/kg**.
* **C√°c k√™nh b√°n h√†ng ch√≠nh:** **{main_sources}**.
* **Ng∆∞·ª°ng Freeship ph·ªï bi·∫øn:** Dao ƒë·ªông quanh m·ª©c **{freeship_threshold_avg} VND**.

**Y√™u c·∫ßu Nhi·ªám v·ª•:**
D·ª±a tr√™n to√†n b·ªô b·ªëi c·∫£nh, t∆∞ t∆∞·ªüng v√† d·ªØ li·ªáu t√≥m t·∫Øt ·ªü tr√™n, h√£y tr·∫£ l·ªùi c√¢u h·ªèi sau c·ªßa ng∆∞·ªùi d√πng m·ªôt c√°ch s√¢u s·∫Øc v√† chi·∫øn l∆∞·ª£c:

**"{user_question}"**

**ƒê·ªãnh d·∫°ng ƒê·∫ßu ra:**
H√£y c·∫•u tr√∫c c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n theo c√°c ph·∫ßn sau ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh logic v√† d·ªÖ theo d√µi:
1.  **T·ªïng k·∫øt c√°c Insight Then ch·ªët:** N√™u b·∫≠t nh·ªØng ph√°t hi·ªán quan tr·ªçng nh·∫•t t·ª´ d·ªØ li·ªáu.
2.  **Ph√¢n t√≠ch Ch√¢n dung Kh√°ch h√†ng:** M√¥ t·∫£ c√°c nh√≥m kh√°ch h√†ng m·ª•c ti√™u v√† h√†nh vi c·ªßa h·ªç, ƒë·∫∑c bi·ªát l√† s·ª± nh·∫°y c·∫£m v·ªÅ gi√° v√† logistics.
3.  **Khuy·∫øn ngh·ªã Chi·∫øn l∆∞·ª£c:** ƒê∆∞a ra c√°c ƒë·ªÅ xu·∫•t c·ª• th·ªÉ, c√≥ t√≠nh h√†nh ƒë·ªông v·ªÅ (a) S·∫£n ph·∫©m v√† Gi√°, v√† (b) Logistics v√† Tr·∫£i nghi·ªám Kh√°ch h√†ng.
`;
        
        let finalPrompt = promptTemplate;
        for (const key in stats) {
            finalPrompt = finalPrompt.replace(new RegExp(`\\{${key}\\}`, 'g'), stats[key]);
        }
        finalPrompt = finalPrompt.replace('{user_question}', userQuestion);

        return finalPrompt;
    };

    const handleChatSubmit = async () => {
        const chatInput = document.getElementById('chat-input');
        const userQuery = chatInput.value.trim();
        if (!userQuery) return;

        if (!geminiApiKey) {
            document.getElementById('api-key-modal').classList.remove('hidden');
            return;
        }

        addMessage(userQuery, 'user');
        chatInput.value = '';
        chatInput.disabled = true;
        document.getElementById('chat-submit').disabled = true;

        const loadingMsgId = `loading-${Date.now()}`;
        addMessage('Chuy√™n gia AI ƒëang ph√¢n t√≠ch...', 'loading', loadingMsgId);

        try {
            const dataForAI = [];
            sstGridOptions.api.forEachNodeAfterFilter(node => dataForAI.push(node.data));
            
            const stats = calculateStats(dataForAI);
            const prompt = generateDynamicPrompt(stats, userQuery);

            if (prompt.startsWith('Error:')) {
                throw new Error(prompt);
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }]
                }]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const result = await response.json();
            
            let botResponse = "Xin l·ªói, t√¥i kh√¥ng th·ªÉ t·∫°o ph·∫£n h·ªìi v√†o l√∫c n√†y.";
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                botResponse = result.candidates[0].content.parts[0].text;
            }
            
            const loadingElement = document.getElementById(loadingMsgId);
            if (loadingElement) loadingElement.remove();
            addMessage(botResponse, 'bot');

        } catch (error) {
            console.error("Error during AI analysis:", error);
            const loadingElement = document.getElementById(loadingMsgId);
            if (loadingElement) loadingElement.remove();
            addMessage(`ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh ph√¢n t√≠ch: ${error.message}`, 'bot');
        } finally {
            chatInput.disabled = false;
            document.getElementById('chat-submit').disabled = false;
            chatInput.focus();
        }
    };

    const renderTaskQueue = () => {
        const taskQueueBody = document.getElementById('task-queue-body');
        const taskCountSpan = document.getElementById('task-count');
        const taskQueueContainer = document.getElementById('task-queue-container');

        taskQueueBody.innerHTML = '';
        taskCountSpan.textContent = taskQueue.length;
        taskQueueContainer.classList.toggle('hidden', taskQueue.length === 0);

        taskQueue.forEach((task, index) => {
            const taskElement = document.createElement('div');
            taskElement.id = `task-${task.id}`;
            taskElement.className = 'p-2 border rounded-md bg-gray-50';
            
            const isRunning = index === 0;
            const cancelBtnHtml = `
                <button 
                    class="cancel-task-btn text-gray-400 hover:text-red-500 disabled:opacity-50 disabled:cursor-not-allowed" 
                    data-task-id="${task.id}"
                    title="${isRunning ? 'Kh√¥ng th·ªÉ h·ªßy t√°c v·ª• ƒëang ch·∫°y' : 'X√≥a t√°c v·ª• kh·ªèi h√†ng ƒë·ª£i'}"
                    ${isRunning ? 'disabled' : ''}>
                    &times;
                </button>`;

            taskElement.innerHTML = `
                <div class="flex justify-between items-center text-sm">
                    <span class="font-medium truncate pr-2">${task.id}: ${task.name}</span>
                    ${cancelBtnHtml}
                </div>
                <div class="mt-2 h-2 progress-bar">
                    <div class="h-full progress-bar-fill" style="width: ${task.progress || 0}%;"></div>
                </div>
            `;
            taskQueueBody.appendChild(taskElement);
        });

        document.querySelectorAll('.cancel-task-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const taskId = e.currentTarget.dataset.taskId;
                taskQueue = taskQueue.filter(t => t.id !== taskId);
                renderTaskQueue();
            });
        });
    };
    
    const updateAddAllButtonVisibility = () => {
        const addAllBtn = document.getElementById('add-all-btn');
        let hasNewItems = false;
        sstGridOptions.api.forEachNode(node => {
            if (node.data.updateStatus === 'M·ªõi') {
                hasNewItems = true;
            }
        });
        addAllBtn.classList.toggle('hidden', !hasNewItems);
    };

    const processQueue = async () => {
        const checkPriceBtn = document.getElementById('check-price-btn');
        if (taskQueue.length === 0) {
            checkPriceBtn.disabled = false;
            updateAddAllButtonVisibility();
            return;
        }

        checkPriceBtn.disabled = true;
        const task = taskQueue[0];
        renderTaskQueue(); // Re-render to disable the cancel button for the running task
        
        const taskElement = document.getElementById(`task-${task.id}`);
        if (!taskElement) { 
            taskQueue.shift();
            processQueue();
            return;
        }

        const progressBarFill = taskElement.querySelector('.progress-bar-fill');
        task.progress = 0;
        const interval = setInterval(() => {
            if (task.progress < 95) {
                task.progress += 100 / (avgTaskTime / 1000);
                progressBarFill.style.width = `${task.progress}%`;
            }
        }, 1000);
        
        const startTime = Date.now();
        task.controller = new AbortController();
        const signal = task.controller.signal;

        try {
            let selectorForApi = task.selector;
            if (selectorForApi && selectorForApi.trim().startsWith('<')) {
                const generatedSelector = generateSelectorFromHtml(selectorForApi);
                if (generatedSelector) {
                    console.log(`Converted raw HTML to selector: '${selectorForApi}' -> '${generatedSelector}'`);
                    selectorForApi = generatedSelector;
                } else {
                    throw new Error("Failed to generate selector from raw HTML.");
                }
            }

            const response = await fetch('/api/check-price', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: task.url, selector: selectorForApi }),
                signal
            });

            const result = await response.json();
            const node = sstGridOptions.api.getRowNode(task.id);

            if (node) {
                if (response.ok && result.price !== null) {
                    const newPrice = parseNumericValue(result.price);
                    const oldPrice = parseNumericValue(node.data['Gi√° ni√™m y·∫øt (VND)']);
                    if (newPrice !== null && oldPrice !== null && newPrice !== oldPrice) {
                        node.data.updateStatus = 'M·ªõi';
                        node.data.newPrice = newPrice;
                    } else {
                        node.data.updateStatus = 'ƒê√£';
                    }
                } else {
                    throw new Error(result.error || "Primary scraping failed.");
                }
                sstGridOptions.api.refreshCells({ rowNodes: [node], columns: ['updateStatus'] });
            }

        } catch (error) {
            if (error.name === 'AbortError') {
                console.log(`Task ${task.id} aborted.`);
            } else {
                console.warn(`Primary scraping for ${task.id} failed:`, error.message, ". Attempting fallback.");
                try {
                    const oldPrice = parseNumericValue(task.originalPrice);
                    if (oldPrice === null) throw new Error("No valid original price for fallback.");

                    const fallbackResponse = await fetch('/api/verify-price-by-text', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ url: task.url, price: oldPrice }),
                         signal
                    });
                    const fallbackResult = await fallbackResponse.json();
                    const node = sstGridOptions.api.getRowNode(task.id);
                    if (node) {
                        if (fallbackResponse.ok && fallbackResult.found_uniquely) {
                            node.data.updateStatus = 'L·ªói';
                            node.data.matchCount = 1;
                        } else {
                            node.data.updateStatus = 'L·ªói';
                            node.data.matchCount = fallbackResult.match_count;
                        }
                        sstGridOptions.api.refreshCells({ rowNodes: [node], columns: ['updateStatus'] });
                    }
                } catch (fallbackError) {
                     if (fallbackError.name === 'AbortError') {
                        console.log(`Fallback for task ${task.id} aborted.`);
                    } else {
                        console.error(`Fallback for ${task.id} also failed:`, fallbackError.message);
                        const node = sstGridOptions.api.getRowNode(task.id);
                        if (node) {
                            node.data.updateStatus = 'L·ªói';
                             node.data.matchCount = -1; // Indicate error
                            sstGridOptions.api.refreshCells({ rowNodes: [node], columns: ['updateStatus'] });
                        }
                    }
                }
            }
        } finally {
            clearInterval(interval);
            if (taskElement) {
                progressBarFill.style.width = '100%';
            }
            const endTime = Date.now();
            completedTaskTimes.push(endTime - startTime);
            avgTaskTime = completedTaskTimes.reduce((a, b) => a + b, 0) / completedTaskTimes.length;
            
            setTimeout(() => {
                taskQueue.shift();
                renderTaskQueue();
                processQueue();
            }, 500);
        }
    };

    const createNewVersion = (node) => {
        let nextIdSuffix = 0;
        const originalData = node.data;
        const newRowData = { ...originalData }; 

        const originalId = originalData.ID;
        const baseId = originalId.split('-v')[0]; 

        const lastVIndex = originalId.lastIndexOf('-v');

        if (lastVIndex !== -1) {
            const suffixString = originalId.substring(lastVIndex + 2);
            const parsedSuffix = parseInt(suffixString, 10);
            
            if (!isNaN(parsedSuffix)) {
                nextIdSuffix = parsedSuffix;
            }
        }

        nextIdSuffix = nextIdSuffix + 1;

        // Set the new price for the new row
        newRowData['Gi√° ni√™m y·∫øt (VND)'] = originalData.newPrice;
        delete newRowData.newPrice; // Clean up temporary property
        delete newRowData.matchCount; // Clean up temporary property

        newRowData.ID = `${baseId}-v${nextIdSuffix}`;
        newRowData.date = getFormattedDate();
        newRowData.updateStatus = 'ƒê√£';

        // Prepare the old row for update
        const updatedOriginalData = { ...originalData };
        delete updatedOriginalData.newPrice; // Clean up temporary property
        updatedOriginalData.updateStatus = 'C≈©';
        
        const originalIndexInMaster = sst_data.findIndex(item => item.ID === originalData.ID);
        if (originalIndexInMaster !== -1) {
            sst_data[originalIndexInMaster] = updatedOriginalData;
            sst_data.splice(originalIndexInMaster + 1, 0, newRowData); 
        }

        // Apply changes to the grid
        sstGridOptions.api.applyTransaction({
            add: [newRowData],
            update: [updatedOriginalData]
        });
    };

    const statusCellRenderer = (params) => {
        if (params.value === 'M·ªõi') {
            const btn = document.createElement('button');
            btn.innerHTML = 'M·ªõi (Th√™m)';
            btn.className = 'add-new-version-btn bg-yellow-400 text-yellow-900 text-xs font-bold py-1 px-2 rounded hover:bg-yellow-500';
            btn.dataset.nodeId = params.node.id;
            return btn;
        }
        if (params.value === 'L·ªói') {
            const btn = document.createElement('button');
            const matchCount = params.data.matchCount;
            let errorText = 'L·ªói';
            let btnClass = 'bg-red-500 hover:bg-red-700'; // Default to red for error

            if (typeof matchCount === 'number' && matchCount > 0) {
                errorText = `C·∫£nh b√°o`;
                if (matchCount > 1) {
                    errorText = `C·∫£nh b√°o (${matchCount})`;
                }
                
                btnClass = 'bg-amber-500 hover:bg-amber-600'; // Change to amber for warning

            } else if (matchCount === 0) {
                errorText = 'L·ªói';
            }

            btn.innerHTML = `${errorText} (X√≥a?)`;
            btn.className = `${btnClass} text-white text-xs font-bold py-1 px-2 rounded`;
            btn.addEventListener('click', () => {
                const rowId = params.node.data.ID;
                sst_data = sst_data.filter(item => item.ID !== rowId);
                sstGridOptions.api.applyTransaction({ remove: [params.node.data] });
                const fromDate = picker.getStartDate();
                const toDate = picker.getEndDate();

                applyAllFilters(fromDate.dateInstance, toDate.dateInstance);
            });
            return btn;
        }
        if (params.value === 'ƒê√£') {
             return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">ƒê√£</span>`;
        }
        if (params.value === 'C≈©') {
             return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">C≈©</span>`;
        }
        return params.value || 'Ch∆∞a KT';
    };

    // --- 5. UI INITIALIZATION & EVENT LISTENERS ---
    let initialColumnDefs = [
        { headerName: "ID", field: "ID", width: 110, sortable: true, filter: true },
        { headerName: "Gi√° ƒë√£ c·∫≠p nh·∫≠t?", field: "updateStatus", width: 140, cellRenderer: statusCellRenderer },
        { headerName: "S·∫£n ph·∫©m", field: "S·∫£n ph·∫©m", flex: 2, sortable: true, filter: true, wrapText: true, autoHeight: true },
        { headerName: "Th∆∞∆°ng hi·ªáu", field: "Th∆∞∆°ng hi·ªáu", flex: 1, sortable: true, filter: true },
        { 
            headerName: "Gi√° ni√™m y·∫øt", 
            field: "Gi√° ni√™m y·∫øt (VND)", 
            width: 150, 
            sortable: true, 
            filter: 'agNumberColumnFilter',
            valueGetter: p => parseNumericValue(p.data['Gi√° ni√™m y·∫øt (VND)']),
            valueFormatter: p => {
                const value = parseNumericValue(p.value);
                return value !== null ? value.toLocaleString('vi-VN') + '‚Ç´' : 'N/A';
            }
        },
        { headerName: "Ng√†y Th√™m", field: "date", width: 120, sortable: true, filter: 'agDateColumnFilter' },
        { 
            headerName: "Ph√≠ Ship (VND)", 
            field: "Ph√≠ ship (VND)", 
            width: 150,
            filter: 'agNumberColumnFilter',
            valueGetter: p => parseNumericValue(p.data['Ph√≠ ship (VND)']),
            valueFormatter: p => typeof p.value === 'string' ? p.value : (p.value !== null ? p.value.toLocaleString('vi-VN') + '‚Ç´' : 'N/A')
        },
        { 
            headerName: "Ng∆∞·ª°ng Freeship", 
            field: "Ng∆∞·ª°ng Freeship (VND)", 
            width: 160,
            filter: 'agNumberColumnFilter',
            valueGetter: p => parseNumericValue(p.data['Ng∆∞·ª°ng Freeship (VND)']),
            valueFormatter: p => typeof p.value === 'string' ? p.value : (p.value !== null ? p.value.toLocaleString('vi-VN') + '‚Ç´' : 'N/A')
        },
        { headerName: "Ngu·ªìn", field: "Ngu·ªìn", flex: 1, sortable: true, filter: true, hide: true },
        { headerName: "Lo·∫°i C√† ph√™", field: "Lo·∫°i C√† ph√™", flex: 1, sortable: true, filter: true, wrapText: true, autoHeight: true, hide: true },
        { headerName: "ƒê∆°n v·ªã t√≠nh", field: "ƒê∆°n v·ªã t√≠nh", width: 120, sortable: true, filter: true, hide: true },
        { headerName: "T·∫°i ƒê·ªãa Ph∆∞∆°ng", field: "T·∫°i ƒê·ªãa Ph∆∞∆°ng", flex: 1, sortable: true, filter: true, hide: true },
        { headerName: "Link", field: "Link M√¥ t·∫£", cellRenderer: p => p.value ? `<a href="${p.value}" target="_blank" class="text-blue-600 hover:underline">Xem</a>` : '', width: 80 },
        { headerName: "HTML Selector", field: "HTML", flex: 2, wrapText: true, autoHeight: true, hide: true },
    ];
    
    sstGridOptions = {
        columnDefs: initialColumnDefs,
        defaultColDef: { resizable: true, sortable: true, filter: true },
        getRowId: params => params.data.ID,
        onFilterChanged: updateChartsFromGridData,
        onSortChanged: updateChartsFromGridData,
        onGridReady: (params) => {
            // Now the API is ready
            updateChartsFromGridData();
        }
    };
    
    const sstGridDiv = document.querySelector('#sstGrid');
    new agGrid.Grid(sstGridDiv, sstGridOptions);

    const picker = new Litepicker({
        element: document.getElementById('datepicker'),
        singleMode: false,
        format: 'YYYY-MM-DD',
        setup: (p) => {
            p.on('selected', (d1, d2) => {
                applyAllFilters(d1.dateInstance, d2.dateInstance);
            });
        },
    });

    const chatInput = document.getElementById('chat-input');
    const chatSubmit = document.getElementById('chat-submit');
    const promptButtons = document.querySelectorAll('.prompt-btn');
    promptButtons.forEach(button => {
        button.addEventListener('click', () => {
            chatInput.value = button.textContent;
            handleChatSubmit();
        });
    });
    chatSubmit.addEventListener('click', handleChatSubmit);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleChatSubmit();
    });
    
    const tabs = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
             tabs.forEach(t => t.classList.remove('active'));
             tab.classList.add('active');
             const target = tab.getAttribute('data-tab');
             tabContents.forEach(content => {
                 content.classList.remove('active');
                 if (content.id === target) content.classList.add('active');
             });
             
             if(target === 'aiAnalysisTab' && !geminiApiKey) {
                document.getElementById('api-key-modal').classList.remove('hidden');
             }

            updateChartsFromGridData();
        });
    });
    
    document.getElementById('check-price-btn').addEventListener('click', () => {
        if (taskQueue.length > 0) {
            alert('M·ªôt qu√° tr√¨nh ki·ªÉm tra ƒëang ƒë∆∞·ª£c th·ª±c hi·ªán. Vui l√≤ng ƒë·ª£i.');
            return;
        }
        sstGridOptions.api.forEachNodeAfterFilterAndSort(node => {
            if (node.data.updateStatus !== 'C≈©'){
                taskQueue.push({
                    id: node.data.ID,
                    name: node.data['S·∫£n ph·∫©m'],
                    url: node.data['Link M√¥ t·∫£'],
                    selector: node.data.HTML,
                    originalPrice: node.data['Gi√° ni√™m y·∫øt (VND)']
                });
            }
            
        });
        renderTaskQueue();
        processQueue();
    });

    sstGridDiv.addEventListener('click', (event) => {
        if (event.target.matches('.add-new-version-btn')) {
            const nodeId = event.target.dataset.nodeId;
            const node = sstGridOptions.api.getRowNode(nodeId);
            if (node) {
                createNewVersion(node);
                updateAddAllButtonVisibility();
            }
        }
    });
    
    document.getElementById('add-all-btn').addEventListener('click', () => {
        const nodesToUpdate = [];
        sstGridOptions.api.forEachNode(node => {
            if(node.data.updateStatus === 'M·ªõi') {
                nodesToUpdate.push(node);
            }
        });
        for(let i = nodesToUpdate.length - 1; i >= 0; i--) {
            createNewVersion(nodesToUpdate[i]);
        }
        updateAddAllButtonVisibility();
    });

    const addDataBtn = document.getElementById('add-data-btn');
    const csvFileInput = document.getElementById('csv-file-input');

    addDataBtn.addEventListener('click', () => {
        csvFileInput.click();
    });

    csvFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) {
                alert('T·ªáp CSV kh√¥ng h·ª£p l·ªá ho·∫∑c tr·ªëng.');
                csvFileInput.value = '';
                return;
            }

            const header = parseCsvLine(lines.shift()).map(h => h.replace(/"/g, ''));
            
            // --- FIX STARTS HERE ---
            const existingIds = new Set(sst_data.map(item => item.ID));
            let idCounter = 0;

            const newSstEntries = lines.map(line => {
                const values = parseCsvLine(line);
                if (values.length !== header.length) {
                    console.warn('Skipping malformed CSV line:', line);
                    return null;
                }
                const rowData = {};
                header.forEach((colName, index) => {
                    rowData[colName] = values[index] ? values[index].replace(/"/g, '').trim() : null;
                });
                
                let finalId = rowData['ID'];
                if (!finalId || finalId.trim() === '') {
                    while (true) {
                        const nextId = `ID${String(idCounter).padStart(3, '0')}`;
                        if (!existingIds.has(nextId)) {
                            finalId = nextId;
                            existingIds.add(finalId); // Th√™m ID m·ªõi v√†o b·ªô ƒë·ªám ngay l·∫≠p t·ª©c
                            break;
                        }
                        idCounter++;
                    }
                }

                const parsedDate = parseDateString(rowData['Ng√†y Th√™m']);

                return {
                    "ID": finalId,
                    "S·∫£n ph·∫©m": rowData['S·∫£n ph·∫©m'] || 'Kh√¥ng c√≥ t√™n',
                    "Th∆∞∆°ng hi·ªáu": rowData['Th∆∞∆°ng hi·ªáu'] || 'Kh√¥ng r√µ',
                    "Ngu·ªìn": rowData['Ngu·ªìn'] || '',
                    "Link M√¥ t·∫£": rowData['Link M√¥ t·∫£'] || '',
                    "Lo·∫°i C√† ph√™": rowData['Lo·∫°i C√† ph√™'] || 'Kh√¥ng r√µ',
                    "ƒê∆°n v·ªã t√≠nh": rowData['ƒê∆°n v·ªã t√≠nh'] || '',
                    "Gi√° ni√™m y·∫øt (VND)": rowData['Gi√° ni√™m y·∫øt (VND)'],
                    "Ph√≠ ship (VND)": rowData['Ph√≠ ship (VND)'],
                    "Ng∆∞·ª°ng Freeship (VND)": rowData['Ng∆∞·ª°ng Freeship (VND)'],
                    "T·∫°i ƒê·ªãa Ph∆∞∆°ng": rowData['T·∫°i ƒê·ªãa Ph∆∞∆°ng'] || 'To√†n qu·ªëc',
                    "HTML": rowData['HTML'] || '',
                    "date": parsedDate ? parsedDate.toISOString().split('T')[0] : getFormattedDate(),
                    "updateStatus": rowData['updateStatus'] === 'C≈©' ? 'C≈©' : 'ƒê√£',
                    "N·ªÅn t·∫£ng TMƒêT": rowData['N·ªÅn t·∫£ng TMƒêT'] || 'Kh√¥ng r√µ'
                };
            }).filter(entry => entry !== null);
            // --- FIX ENDS HERE ---

            if (newSstEntries.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong t·ªáp ƒë·ªÉ th√™m.');
                csvFileInput.value = '';
                return;
            }

            sst_data.push(...newSstEntries);
            currentFilteredData = [...sst_data]; // Reset filtered data to include new entries
            if (sstGridOptions && sstGridOptions.api) {
                sstGridOptions.api.setRowData(currentFilteredData);
            }
            
            if (sst_data.length > 0) {
                const allDates = sst_data
                    .map(item => parseDateString(item.date))
                    .filter(d => d !== null && !isNaN(d.getTime()));

                if (allDates.length > 0) {
                    const allTimestamps = allDates.map(d => d.getTime());
                    const minDate = new Date(Math.min.apply(null, allTimestamps));
                    const maxDate = new Date(Math.max.apply(null, allTimestamps));
                    picker.setDateRange(minDate, maxDate);
                } else {
                    picker.clearSelection();
                    applyAllFilters(null, null);
                }
            } else {
                const fromDate = picker.getStartDate();
                const toDate = picker.getEndDate();
                applyAllFilters(fromDate.dateInstance, toDate.dateInstance);
            }

            alert(`${newSstEntries.length} h√†ng ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng.`);
        };
        reader.readAsText(file, 'UTF-8');
        event.target.value = '';
    });
    
    document.getElementById('toggle-queue-btn').addEventListener('click', () => {
        document.getElementById('task-queue-body').classList.toggle('hidden');
        document.querySelector('#toggle-queue-btn svg').classList.toggle('rotate-180');
        adjustTaskQueuePosition(document.getElementById('toggle-queue-btn'));
    });
    
    document.getElementById('clear-pending-tasks-btn').addEventListener('click', () => {
        if (taskQueue.length > 1) {
            const runningTask = taskQueue[0];
            taskQueue = [runningTask];
            renderTaskQueue();
            processQueue();
        }
    });

    document.getElementById('to-csv-btn').addEventListener('click', () => {
        let currentFilteredData = [];
        sstGridOptions.api.forEachNodeAfterFilterAndSort(node => {
            currentFilteredData.push(node.data);
        });
      if (!currentFilteredData || currentFilteredData.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.");
        return;
      }

      const csvHeaders = [
          "ID", "S·∫£n ph·∫©m", "Th∆∞∆°ng hi·ªáu", "Ngu·ªìn", "Link M√¥ t·∫£", "Lo·∫°i C√† ph√™", 
          "ƒê∆°n v·ªã t√≠nh", "Gi√° ni√™m y·∫øt (VND)", "Ph√≠ ship (VND)", "Ng∆∞·ª°ng Freeship (VND)", 
          "T·∫°i ƒê·ªãa Ph∆∞∆°ng", "HTML", "Ng√†y Th√™m", "updateStatus", "N·ªÅn t·∫£ng TMƒêT"
      ];

      const dataForCsv = currentFilteredData.map(row => ({
          "ID": row.ID,
          "S·∫£n ph·∫©m": row["S·∫£n ph·∫©m"],
          "Th∆∞∆°ng hi·ªáu": row["Th∆∞∆°ng hi·ªáu"],
          "Ngu·ªìn": row.Ngu·ªìn,
          "Link M√¥ t·∫£": row["Link M√¥ t·∫£"],
          "Lo·∫°i C√† ph√™": row["Lo·∫°i C√† ph√™"],
          "ƒê∆°n v·ªã t√≠nh": row["ƒê∆°n v·ªã t√≠nh"],
          "Gi√° ni√™m y·∫øt (VND)": row["Gi√° ni√™m y·∫øt (VND)"],
          "Ph√≠ ship (VND)": row["Ph√≠ ship (VND)"],
          "Ng∆∞·ª°ng Freeship (VND)": row["Ng∆∞·ª°ng Freeship (VND)"],
          "T·∫°i ƒê·ªãa Ph∆∞∆°ng": row["T·∫°i ƒê·ªãa Ph∆∞∆°ng"],
          "HTML": row.HTML,
          "Ng√†y Th√™m": row.date,
          "updateStatus": row.updateStatus,
          "N·ªÅn t·∫£ng TMƒêT": row["N·ªÅn t·∫£ng TMƒêT"]
      }));

      const csvContent = [
        csvHeaders.join(','),
        ...dataForCsv.map(row =>
          csvHeaders.map(header => {
            let val = (row[header] ?? '').toString();
            if (val.includes(',')) {
                val = `"${val.replace(/"/g, '""')}"`;
            }
            return val;
          }).join(',')
        )
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'du_lieu_sst.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    const helpModal = document.getElementById('help-modal');
    const helpBtn = document.getElementById('help-btn');
    const closeHelpBtn = document.getElementById('close-help-btn');

    // M·ªü modal khi nh·∫•n n√∫t Tr·ª£ gi√∫p
    helpBtn.addEventListener('click', () => {
        helpModal.classList.remove('hidden');
    });

    // ƒê√≥ng modal khi nh·∫•n n√∫t 'X'
    closeHelpBtn.addEventListener('click', () => {
        helpModal.classList.add('hidden');
    });

    // ƒê√≥ng modal khi nh·∫•n v√†o l·ªõp ph·ªß b√™n ngo√†i
    helpModal.addEventListener('click', (event) => {
        // Ch·ªâ ƒë√≥ng n·∫øu ng∆∞·ªùi d√πng nh·∫•n tr·ª±c ti·∫øp v√†o l·ªõp ph·ªß m√†u ƒëen
        if (event.target === helpModal) {
            helpModal.classList.add('hidden');
        }
    });

    const settingsModal = document.getElementById('settings-modal');
    document.getElementById('settings-btn').addEventListener('click', () => {
        const list = document.getElementById('settings-list');
        list.innerHTML = ''; // Clear previous items
        
        const allColumns = sstGridOptions.api.getColumns();
        if (!allColumns) return; // Grid API not ready yet

        allColumns.forEach(col => {
            const colDef = col.getColDef();
            const key = colDef.field;
            const headerName = colDef.headerName;
            
            const controlRow = document.createElement('div');
            controlRow.className = 'flex items-center justify-between p-1 rounded hover:bg-gray-100';

            const label = document.createElement('label');
            label.className = 'flex items-center space-x-2 cursor-pointer flex-grow';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = key;
            checkbox.checked = deduplicationKeys.includes(key);
            checkbox.className = 'form-checkbox h-5 w-5 text-purple-600 rounded focus:ring-purple-500';
            
            const span = document.createElement('span');
            span.textContent = headerName;
            
            label.appendChild(checkbox);
            label.appendChild(span);
            
            const visibilityBtn = document.createElement('button');
            visibilityBtn.className = 'p-1 rounded-full hover:bg-gray-200';
            visibilityBtn.dataset.colId = col.getColId();
            const isVisible = col.isVisible();
            visibilityBtn.innerHTML = isVisible 
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>` 
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>`;
            
            visibilityBtn.addEventListener('click', (e) => {
                const btn = e.currentTarget;
                const isCurrentlyVisible = btn.dataset.visible === 'true';
                btn.dataset.visible = !isCurrentlyVisible;
                btn.innerHTML = !isCurrentlyVisible
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>` 
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>`;
            });
            visibilityBtn.dataset.visible = isVisible;

            controlRow.appendChild(visibilityBtn);
            controlRow.appendChild(label);
            list.appendChild(controlRow);
        });
        settingsModal.classList.remove('hidden');
    });

    document.getElementById('cancel-settings-btn').addEventListener('click', () => {
        document.getElementById('settings-modal').classList.add('hidden');
    });

    document.getElementById('apply-settings-btn').addEventListener('click', () => {
        const list = document.getElementById('settings-list');
        const newKeys = [];
        const visibilityState = {};

        list.querySelectorAll('label').forEach(label => {
            const checkbox = label.querySelector('input[type="checkbox"]');
            const key = checkbox.value;
            if (checkbox.checked) {
                newKeys.push(key);
            }
        });
        
        list.querySelectorAll('button').forEach(btn => {
            const colId = btn.dataset.colId;
            const isVisible = btn.dataset.visible === 'true';
            visibilityState[colId] = isVisible;
        });

        deduplicationKeys = newKeys;
        const colIds = Object.keys(visibilityState);
        const colsToShow = colIds.filter(id => visibilityState[id]);
        const colsToHide = colIds.filter(id => !visibilityState[id]);
        sstGridOptions.api.setColumnsVisible(colsToHide, false);
        sstGridOptions.api.setColumnsVisible(colsToShow, true);
        

        applyAllFilters();
        document.getElementById('settings-modal').classList.add('hidden');
    });

    const apiKeyModal = document.getElementById('api-key-modal');
    document.getElementById('save-api-key-btn').addEventListener('click', () => {
        const keyInput = document.getElementById('gemini-api-key-input');
        const key = keyInput.value.trim();
        if (key) {
            geminiApiKey = key;
            sessionStorage.setItem('geminiApiKey', key);
            apiKeyModal.classList.add('hidden');
            handleChatSubmit(); // Automatically submit after saving key
        } else {
            alert('Vui l√≤ng nh·∫≠p m·ªôt API Key h·ª£p l·ªá.');
        }
    });
    document.getElementById('cancel-api-key-btn').addEventListener('click', () => {
        apiKeyModal.classList.add('hidden');
    });

    defaultShipFeeInput = document.getElementById('input-default-ship-fee');

    defaultShipFeeInput.addEventListener('change', () => {
        updateChartsFromGridData();
    });

    defaultShipFeeInput.addEventListener('blur', () => {
        // N·∫øu gi√° tr·ªã sau khi c·∫Øt b·ªè kho·∫£ng tr·∫Øng l√† r·ªóng...
        if (defaultShipFeeInput.value.trim() === '') {
            // ...th√¨ ƒë·∫∑t l·∫°i gi√° tr·ªã l√† 30000
            defaultShipFeeInput.value = 30000;

            // K√≠ch ho·∫°t s·ª± ki·ªán 'input' m·ªôt c√°ch nh√¢n t·∫°o ƒë·ªÉ bi·ªÉu ƒë·ªì c·∫≠p nh·∫≠t theo gi√° tr·ªã m·ªõi
            defaultShipFeeInput.dispatchEvent(new Event('input'));
        }
    });

    // L·∫•y c√°c ph·∫ßn t·ª≠ t·ª´ DOM
    const taskQueueContainer = document.getElementById('task-queue-container');
    const taskQueueHeader = document.getElementById('task-queue-header');

    // K√≠ch ho·∫°t ch·ª©c nƒÉng k√©o-th·∫£
    makeDraggable(taskQueueContainer, taskQueueHeader);


    // --- 6. INITIAL LOAD ---
    const endDate = new Date('2025-07-06');
    const startDate = new Date('2025-05-23');
    picker.setDateRange(startDate, endDate);
});
</script>

</body>
</html>
