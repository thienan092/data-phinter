<!-- ‚úÖ Patched version: Default mode is 'selenium' on Windows, otherwise 'bs4'.
‚úÖ Dynamic mode label and version inserted into help modal.
‚úÖ mode included in backend requests via getScrapingMode().
‚úÖ data-lang-key adjusted dynamically on DOM load.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="page_title">·ª®ng D·ª•ng H·ªó Tr·ª£ Ki·ªÉm Ch·ª©ng v√† T√≠ch L≈©y D·ªØ Li·ªáu "T√¨m Ki·∫øm S√¢u" (phi√™n b·∫£n d√†nh cho K·ªá H√†ng C√† Ph√™ Tr·ª±c Tuy·∫øn)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/ag-grid-community@31.3.2/dist/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <style>
        :root {
            --header-height: 80px;
            --tab-height: 50px;
        }
        html, body {
            max-width: 100vw;
            overflow-x: hidden;
            height: 100%;
            overflow: hidden;
        }
        body {
            background-color: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }
       .main-container {
            overflow-y: auto;
            height: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
       }
       .tab-content {
            display: none;
            overflow-y: auto;
            flex-grow: 1;
            padding: 1rem; /* Adjusted padding for mobile */
        }
       .tab-content.active {
            display: flex;
            flex-direction: column;
        }
       .tab-btn.active {
            border-color: #1d4ed8;
            color: #1d4ed8;
            background-color: #eff6ff;
        }
       .ag-theme-alpine {
            min-height: 400px;
            max-height: calc(100vh - 250px);
            overflow: auto;
            height: 100%;
            width: 100%;
            flex-grow: 1;
            /* Ensure rows are not too wide on desktop */
            --ag-row-height: 38px; /* Default row height, adjust as needed */
            --ag-header-height: 40px; /* Default header height */
        }
        /* Adjust cell padding for better density on desktop */
        .ag-cell {
            padding: 4px 8px !important; /* Smaller padding */
            word-break: break-word !important;
        }
        .ag-header-cell-text {
            white-space: normal !important;
        }

       #logisticsTab {
            padding: 0.5rem !important; /* Gi·∫£m kho·∫£ng tr·∫Øng cho mobile */
        }

        /* ƒêi·ªÅu ch·ªânh box nh·∫≠p ph√≠ ship */
        #logisticsTab .bg-white {
            padding: 0.5rem !important; /* √çt padding h∆°n tr√™n mobile */
        }

        /* T·ªëi ∆∞u b·ªë c·ª•c chart */
        .chart-container {
            background: white;
            padding: 0.5rem; /* √≠t padding h∆°n cho mobile */
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-height: 300px; /* Minimum height for charts */
            flex-grow: 1; /* Re-added to allow charts to grow within flex container */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* T·ªëi ∆∞u bi·ªÉu ƒë·ªì hi·ªÉn th·ªã tr√™n m·ªçi thi·∫øt b·ªã */
        .chart-container canvas {
            width: 100% !important;
            height: 100% !important; /* Fill parent container */
            max-height: 100%;
            object-fit: contain;
        }

        /* Responsive grid spacing nh·ªè h∆°n cho mobile */
        #logisticsTab .grid {
            gap: 0.75rem !important;
        }
        
        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: #ffffff;
        }
       .message {
            margin-bottom: 0.75rem; /* Adjusted margin for mobile */
            padding: 0.5rem 0.75rem; /* Adjusted padding for mobile */
            border-radius: 0.5rem;
            max-width: 90%; /* Adjusted max-width for mobile */
            line-height: 1.4; /* Adjusted line-height for mobile */
            white-space: pre-wrap; /* To respect newlines from AI */
        }
       .user-message {
            background-color: #dbeafe;
            align-self: flex-end;
            margin-left: auto;
        }
       .bot-message {
            background-color: #f3f4f6;
            align-self: flex-start;
        }
        .loading-message {
            align-self: flex-start;
            color: #6b7280;
            font-style: italic;
        }
       
        #task-queue-container {
            position: fixed;
            bottom: 0.5rem; /* Adjusted for mobile */
            right: 0.5rem; /* Adjusted for mobile */
            width: 95%; /* Adjusted for mobile */
            max-width: 350px; /* Max width for larger screens */
            max-height: 400px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease-in-out;
            transform: translate(0, 0); /* K√≠ch ho·∫°t tƒÉng t·ªëc GPU ƒë·ªÉ di chuy·ªÉn m∆∞·ª£t m√† */
        }
        #task-queue-header {
            cursor: grab; /* Thay ƒë·ªïi con tr·ªè chu·ªôt khi di qua header */
        }
        #task-queue-header:active {
            cursor: grabbing; /* Thay ƒë·ªïi con tr·ªè chu·ªôt khi ƒëang k√©o */
        }
        .progress-bar {
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar-fill {
            background-color: #3b82f6;
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem; /* Adjusted padding for mobile */
            border-radius: 0.5rem;
            max-width: 95%; /* Adjusted for mobile */
            width: 90%;
        }

        /* Resizing handles for charts */
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.8);
            z-index: 10;
        }
        /* Only bottom-right handle is active */
        .resize-handle.top-left,
        .resize-handle.top-right,
        .resize-handle.bottom-left {
            display: none; /* Hide other handles */
        }
        .resize-handle.bottom-right { bottom: -5px; right: -5px; cursor: nwse-resize; }
    </style>
</head>
<body class="text-gray-800">

<div class="p-3 bg-white shadow-md z-20"> <!-- Adjusted padding for mobile -->
    <div class="mb-3 flex flex-col md:flex-row justify-between items-center"> <!-- Adjusted margin and flex direction for mobile -->
        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 w-full md:w-auto mb-2 md:mb-0">
            <h1 class="text-xl md:text-3xl font-bold text-gray-800 text-center md:text-left" data-lang-key="main_title">D·ªØ Li·ªáu K·ªá H√†ng C√† Ph√™ Tr·ª±c Tuy·∫øn</h1>
            <button id="help-btn" class="ml-0 md:ml-3 text-gray-400 hover:text-blue-600 transition-colors duration-200" data-lang-key-title="user_guide_title">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto md:mx-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
        </div>
        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 w-full md:w-auto">
            <div class="w-full md:w-auto">
                <label for="datepicker" class="text-sm font-medium text-gray-700 mr-2 block md:inline-block" data-lang-key="time_filter_label">B·ªô l·ªçc Th·ªùi gian:</label>
                <input id="datepicker" class="border border-gray-300 rounded-md px-3 py-2 text-sm w-full md:w-64"/>
            </div>
            <div class="relative w-full md:w-auto">
                <select id="language-switcher" class="border border-gray-300 rounded-md px-3 py-2 text-sm appearance-none pr-8 cursor-pointer w-full">
                    <option value="en">English</option>
                    <option value="vn">Ti·∫øng Vi·ªát</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="px-3 bg-white/80 backdrop-blur-sm z-20"> <!-- Adjusted padding for mobile -->
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-3 overflow-x-auto" id="tab-container"> <!-- Adjusted space-x for mobile -->
            <button class="tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab="sstTab" data-lang-key="sst_data_tab">D·ªØ Li·ªáu SST</button>
            <button class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="marketOverviewTab" data-lang-key="market_overview_tab">T·ªïng quan Th·ªã tr∆∞·ªùng</button>
            <button class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="competitiveAnalysisTab" data-lang-key="competitive_analysis_tab">Ph√¢n t√≠ch C·∫°nh tranh</button>
            <button class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="logisticsTab" data-lang-key="logistics_tab">V·∫≠n h√†nh Logistics</button>
            <button class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="aiAnalysisTab" data-lang-key="ai_analysis_tab">Ph√¢n t√≠ch AI</button>
        </nav>
    </div>
</div>

<main class="main-container">
    <div id="sstTab" class="tab-content active">
        <div class="mb-3 flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0"> <!-- Adjusted margin and flex direction for mobile -->
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 w-full md:w-auto">
                <button id="add-data-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 w-full md:w-auto" data-lang-key="add_data_btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Th√™m d·ªØ li·ªáu
                </button>
                <button id="to-csv-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 w-full md:w-auto" data-lang-key="export_csv_btn">
                    üì§ T·∫°o file CSV
                </button>
                <button id="toggle-edit-mode-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 w-full md:w-auto" data-lang-key="edit_mode_btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                    </svg>
                </button>
                <input type="file" id="csv-file-input" class="hidden" accept=".csv">
            </div>
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 w-full md:w-auto">
                <button id="add-all-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 hidden w-full md:w-auto" data-lang-key="add_all_changes_btn">
                    Th√™m t·∫•t c·∫£ thay ƒë·ªïi
                </button>
                <button id="check-price-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed w-full md:w-auto" data-lang-key="check_price_updates_btn">
                    Ki·ªÉm tra/C·∫≠p nh·∫≠t Gi√°
                </button>
                 <button id="settings-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-lg shadow-md transition duration-300 w-full md:w-auto" data-lang-key-title="settings_btn_title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
            </div>
        </div>
        <div id="sstGrid" class="ag-theme-alpine"></div>
    </div>

    <div id="marketOverviewTab" class="tab-content">
        <div class="flex flex-col lg:flex-row lg:flex-wrap gap-4 w-full h-full">
            <div class="chart-container w-full h-full lg:w-[calc(66.66%-0.5rem)]" data-chart-id="brandPriceChart"> <!-- Adjusted width for desktop -->
                <h3 class="text-lg font-semibold mb-3 text-center" data-lang-key="avg_price_chart_title">ƒê·ªãnh v·ªã Gi√° Trung b√¨nh theo Th∆∞∆°ng hi·ªáu (VND/kg)</h3>
                <canvas id="brandPriceChart"></canvas>
                <div class="resize-handle bottom-right"></div>
            </div>
            <div class="chart-container w-full h-full lg:w-[calc(33.33%-0.5rem)]" data-chart-id="coffeeTypeChart"> <!-- Adjusted width for desktop -->
                <h3 class="text-lg font-semibold mb-3 text-center" data-lang-key="coffee_type_chart_title">Ph√¢n b·ªï Ch·ªßng lo·∫°i C√† ph√™</h3>
                <canvas id="coffeeTypeChart"></canvas>
                <div class="resize-handle bottom-right"></div>
            </div>
        </div>
    </div>

    <div id="competitiveAnalysisTab" class="tab-content">
        <div class="flex flex-col gap-4 w-full h-full">
            <div class="chart-container w-full" data-chart-id="brandPositioningChart">
                <h3 class="text-lg font-semibold mb-3 text-center" data-lang-key="brand_map_chart_title">B·∫£n ƒë·ªì ƒê·ªãnh v·ªã Th∆∞∆°ng hi·ªáu</h3>
                <canvas id="brandPositioningChart"></canvas>
                <div class="resize-handle bottom-right"></div>
            </div>
        </div>
    </div>

    <div id="logisticsTab" class="tab-content">
        <div class="mb-3 p-2 sm:p-3 bg-white rounded-lg shadow">
            <label for="input-default-ship-fee" class="text-sm font-medium text-gray-700 mr-2 block mb-1" data-lang-key="default_shipping_fee_label">Ph√≠ ship m·∫∑c ƒë·ªãnh (VND):</label>
            <input type="number" id="input-default-ship-fee" value="30000" step="1000" class="p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm w-full">
        </div>
        <div class="flex flex-col gap-4 w-full h-full">
            <div class="chart-container w-full h-full p-2 sm:p-4" data-chart-id="freeshipChart">
                <h3 class="text-lg font-semibold mb-3 text-center" data-lang-key="freeship_chart_title">Ph√¢n t√≠ch Hi·ªáu qu·∫£ Ng∆∞·ª°ng Freeship</h3>
                <canvas id="freeshipChart"></canvas>
                <div class="resize-handle bottom-right"></div>
            </div>
        </div>
    </div>

    <div id="aiAnalysisTab" class="tab-content">
        <div id="chat-container">
            <div id="chat-messages" class="mb-3 flex flex-col space-y-3">
                 <div class="message bot-message" data-lang-key="ai_welcome_message">
                    <strong>Xin ch√†o!</strong> T√¥i l√† tr·ª£ l√Ω ph√¢n t√≠ch chi·∫øn l∆∞·ª£c. H√£y ƒë·∫∑t c√¢u h·ªèi v·ªÅ th·ªã tr∆∞·ªùng c√† ph√™ d·ª±a tr√™n d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã, ho·∫∑c ch·ªçn m·ªôt g·ª£i √Ω b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu.
                </div>
            </div>
            <div class="p-3 border-t border-gray-200">
                <p class="text-sm font-medium text-gray-600 mb-2" data-lang-key="ai_suggestions_label">G·ª£i √Ω ph√¢n t√≠ch:</p>
                <div class="flex flex-wrap gap-2">
                    <button class="prompt-btn bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium py-1 px-3 rounded-full" data-lang-key="ai_prompt_1">Ph√¢n kh√∫c th·ªã tr∆∞·ªùng ƒëang c√≥ nh·ªØng ƒë·∫∑c ƒëi·ªÉm g√¨?</button>
                    <button class="prompt-btn bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium py-1 px-3 rounded-full" data-lang-key="ai_prompt_2">So s√°nh chi·∫øn l∆∞·ª£c logistics c·ªßa c√°c th∆∞∆°ng hi·ªáu.</button>
                    <button class="prompt-btn bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium py-1 px-3 rounded-full" data-lang-key="ai_prompt_3">Y·∫øu t·ªë n√†o quan tr·ªçng nh·∫•t v·ªõi kh√°ch h√†ng cao c·∫•p?</button>
                </div>
                <div class="flex mt-3">
                    <input type="text" id="chat-input" class="flex-grow border border-gray-300 rounded-l-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"  data-lang-key-placeholder="ai_input_placeholder">
                    <button id="chat-submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-r-md hover:bg-blue-700" data-lang-key="ai_send_button">G·ª≠i</button>
                </div>
            </div>
        </div>
    </div>

    
</main>

<div id="task-queue-container" class="hidden">
    <div id="task-queue-header" class="p-3 bg-gray-700 text-white font-semibold flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <button id="toggle-queue-btn" class="text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>
            <span data-lang-key="task_queue_title">H√†ng ƒë·ª£i t√°c v·ª• (<span id="task-count">0</span>)</span>
        </div>
        <button id="clear-pending-tasks-btn" class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded" data-lang-key="task_queue_clear_btn">L√†m Tr·ªëng</button>
    </div>
    <div id="task-queue-body" class="p-3 space-y-3 overflow-y-auto">
    </div>
</div>

<div id="settings-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 class="text-xl font-bold mb-4" data-lang-key="settings_modal_title">Thi·∫øt l·∫≠p Hi·ªÉn th·ªã & Kh√≥a</h2>
        <p class="text-sm text-gray-600 mb-4" data-lang-key="settings_modal_desc">T√πy ch·ªânh c√°c c·ªôt ƒë∆∞·ª£c hi·ªÉn th·ªã v√† c√°c c·ªôt ƒë∆∞·ª£c s·ª≠ d·ª•ng l√†m kh√≥a ch·ªëng tr√πng l·∫∑p.</p>
        <div id="settings-list" class="space-y-2 mb-6 max-h-64 overflow-y-auto">
            <!-- Settings will be inserted here by JS -->
        </div>
        <div class="flex justify-end space-x-3">
            <button id="cancel-settings-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" data-lang-key="settings_modal_cancel_btn">H·ªßy</button>
            <button id="apply-settings-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" data-lang-key="settings_modal_apply_btn">√Åp d·ª•ng</button>
        </div>
    </div>
</div>

<div id="api-key-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 class="text-xl font-bold mb-4" data-lang-key="api_key_modal_title">Thi·∫øt l·∫≠p Gemini API Key</h2>
        <p class="text-sm text-gray-600 mb-4"data-lang-key="api_key_modal_desc">Vui l√≤ng cung c·∫•p kh√≥a API Gemini c·ªßa b·∫°n ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng ph√¢n t√≠ch AI. Kh√≥a s·∫Ω ƒë∆∞·ª£c l∆∞u tr·ªØ trong phi√™n l√†m vi·ªác c·ªßa tr√¨nh duy·ªát.</p>
        <div>
            <label for="gemini-api-key-input" class="block text-sm font-medium text-gray-700" data-lang-key="api_key_modal_label">Gemini API Key</label>
            <input type="password" id="gemini-api-key-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
        </div>
        <div class="flex justify-end space-x-3 mt-6">
            <button id="cancel-api-key-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" data-lang-key="api_key_modal_cancel_btn">H·ªßy</button>
            <button id="save-api-key-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" data-lang-key="api_key_modal_save_btn">L∆∞u</button>
        </div>
    </div>
</div>

<div id="help-modal" class="modal-overlay hidden">
    <div class="modal-content relative max-w-2xl">
        <button id="close-help-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        
        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2" data-lang-key="help_modal_title">H∆∞·ªõng d·∫´n S·ª≠ d·ª•ng</h2>
        
        <div id="help-modal-body" class="text-sm text-gray-700 space-y-4 max-h-[70vh] overflow-y-auto pr-2">
            <p data-lang-key="help_intro1">·ª®ng d·ª•ng ƒë∆∞·ª£c thi·∫øt k·∫ø nh·∫±m t√≠ch h·ª£p nh·ªØng ch·ª©c nƒÉng c∆° b·∫£n nh·∫•t ƒë·ªÉ ng∆∞·ªùi s·ª≠ d·ª•ng ph·ªï th√¥ng c√≥ th·ªÉ chu·∫©n h√≥a v√† t√≠ch l≈©y "d·ªØ li·ªáu t√¨m ki·∫øm s√¢u" (d·ªØ li·ªáu c√≥ ƒë∆∞·ª£c th√¥ng qua ch·ª©c nƒÉng <a href="https://gemini.google/overview/deep-research/?hl=vn">Deep Research</a> c·ªßa m√¥ h√¨nh ng√¥n ng·ªØ l·ªõn Gemini) theo th·ªùi gian</p>
            <p data-lang-key="help_intro2"><strong>Phi√™n b·∫£n:</strong> D·ªØ Li·ªáu K·ªá H√†ng Tr·ª±c Tuy·∫øn (<span id="mode-label" class="font-semibold text-blue-600">ƒëang t·∫£i...</span>)</p>
            <p data-lang-key="help_intro3"><strong>S·ªë phi√™n b·∫£n:</strong> v1.0+<span id="version-mode" class="font-mono">auto</span></p>
            <p data-lang-key="help_intro4"><strong>ƒê·ªëi t∆∞·ª£ng:</strong> Th·ªã Tr∆∞·ªùng C√† Ph√™ B√°n L·∫ª</p>

            <div>
                <h3 class="text-lg font-semibold mb-2 text-gray-900" data-lang-key="help_key_components_title">Key Components</h3>
                <ul class="list-disc list-inside space-y-2 pl-2">
                    <li data-lang-key="help_key_components_1"><strong>Time Filter:</strong> Allows you to select a time range for analysis. All data and charts on the page will update based on your selection.</li>
                    <li><strong data-lang-key="help_key_components_2_title">Navigation Tabs:</strong>
                        <ul class="list-disc list-inside ml-5 mt-1 space-y-1">
                            <li data-lang-key="help_key_components_2_1"><strong>SST Data:</strong> This is where the Single Source of Truth is displayed. It's your data management hub, and all analyses are based on the data shown here.</li>
                            <li data-lang-key="help_key_components_2_2"><strong>Market Overview:</strong> Provides a high-level view of brand price positioning and the distribution of coffee types.</li>
                            <li data-lang-key="help_key_components_2_3"><strong>Competitive Analysis:</strong> Visualizes the market position of brands based on average price and number of products (SKUs).</li>
                            <li data-lang-key="help_key_components_2_4"><strong>Logistics Operations:</strong> Integrates a simulation of the total actual cost to the customer based on cart value and each brand's freeship policy.</li>
                            <li data-lang-key="help_key_components_2_5"><strong>AI Analysis:</strong> Allows you to ask questions in natural language to receive strategic analyses and recommendations from an AI based on statistics from the current data.</li>
                        </ul>
                    </li>
                </ul>
            </div>

            <div>
                <h3 class="text-lg font-semibold mb-2 text-gray-900" data-lang-key="help_sst_functions_title">SST Data Tab Functions</h3>
                 <ul class="list-disc list-inside space-y-2 pl-2">
                    <li data-lang-key="help_sst_functions_1"><strong>Add Data:</strong> Allows you to upload a CSV file to add data to the system. The system will automatically assign unique IDs to rows that don't have one.</li>
                    <li data-lang-key="help_sst_functions_2"><strong>Export to CSV:</strong> Downloads all currently displayed data to a CSV file.</li>
                    <li><strong data-lang-key="help_sst_functions_3_title">Display & Key Settings:</strong>
                        <ul class="list-disc list-inside ml-5 mt-1 space-y-2">
                            <li class="flex items-start">
                                <div class="flex-shrink-0 w-6 flex justify-center pt-0.5">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <span class="ml-2" data-lang-key="help_sst_functions_3_1">Toggle the visibility of each column in the grid.</span>
                            </li>
                            <li class="flex items-start">
                                <div class="flex-shrink-0 w-6 flex justify-center pt-0.5">
                                    <input id="deduplicate-key" type="checkbox" class="form-checkbox h-5 w-5 text-purple-600 rounded focus:ring-purple-500" checked>
                                </div>
                                <label for="deduplicate-key" class="ml-2" data-lang-key="help_sst_functions_3_2">
                                    Select columns to use as "keys" for deduplication. Rows with the same values across all selected columns will be hidden, keeping only the first row according to the current sort order.
                                </label>
                            </li>
                        </ul>
                    </li>
                     <li><strong data-lang-key="help_sst_functions_4_title">Check for Price Updates:</strong> <span data-lang-key="help_sst_functions_4_desc">Automatically visits the "Product Link" (the "Link" column) and updates the prices for the products. The status will be updated:</span>
                        <ul class="list-disc list-inside ml-5 mt-1 space-y-1">
                            <li data-lang-key="help_sst_functions_4_1"><strong>New:</strong> The price has changed. Click the button to create a new version with the updated price.</li>
                            <li data-lang-key="help_sst_functions_4_2"><strong>Warning (number):</strong> The price was not found by scraping with the selector (the "HTML" column), but more than one match for the old price was found in the data row. The selector needs to be updated for successful scraping.</li>
                            <li data-lang-key="help_sst_functions_4_3"><strong>Error:</strong> The price was not found by scraping with the selector (the "HTML" column) and no match for the old price was found in the data row. The URL has likely changed.</li>
                            <div style="margin-top: 10px; padding: 3px; text-align: center; background-color: #fffbe6; border: 1px solid #a0a0e8; border-radius: 3px; color: #7151ef; font-size: 14px;">
                                <span data-lang-key="help_sst_functions_4_note"><i><strong>Note:</strong> Although the price statuses of the session will be saved when saving to a csv file, when opening the file, the application will assume that the \"Error\" statuses of the previous session have been reviewed and will be labeled as "Done", so there will only be two statuses, "Done" and "Old", when starting a new session.</i></span>
                            </div> 
                        </ul>
                     </li>
                     <li data-lang-key="help_sst_functions_5"><strong>Add All Changes:</strong> Automatically creates a new version for all rows with the status "New".</li>
                </ul>
            </div>

             <div>
                <h3 class="text-lg font-semibold mb-2 text-gray-900" data-lang-key="help_task_queue_title">Task Queue</h3>
                <p data-lang-key="help_task_queue_desc">This queue appears when you run the "Check for Price Updates" function. It allows you to monitor progress and manage tasks. You can drag, drop, and collapse it to save space.</p>
            </div>
            <div style="margin-top: 50px; padding: 20px; text-align: center; background-color: #fffbe6; border: 1px solid #ffe58f; border-radius: 8px; color: #614700; font-size: 16px;">
            <strong data-lang-key="help_support_title">üéâ Find this application useful?</strong><br>
            <span data-lang-key="help_support_desc">Please <a href="https://www.buymeacoffee.com/anlt" target="_blank" style="color: #d48806; font-weight: bold; text-decoration: underline;">buy me a coffee</a> to fuel further development ‚òï.</span><br><br>
            <span data-lang-key="help_support_thanks">Your support is a great source of inspiration. Thank you sincerely üíõ</span>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 0. LANGUAGE & TRANSLATION ---
    const translations = {
        en: {
            page_title: "\"Deep Search\" Data Collection and Verification (Online Coffee Shelf version)",
            main_title: "Online Coffee Shelf Data",
            user_guide_title: "User Guide",
            time_filter_label: "Time Filter:",
            sst_data_tab: "SST Data",
            market_overview_tab: "Market Overview",
            competitive_analysis_tab: "Competitive Analysis",
            logistics_ops_tab: "Logistics Operations",
            ai_analysis_tab: "AI Analysis",
            add_data_btn: "\<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-5 w-5 inline-block mr-2\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\"\>\<path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" /\>\</svg\>Add Data",
            export_csv_btn: "üì§ Export to CSV",
            add_all_changes_btn: "Add All Changes",
            check_price_updates_btn: "Verify/Update Price",
            settings_btn_title: "Display & Key Settings",
            avg_price_chart_title: "Average Price Positioning by Brand (VND/kg)",
            coffee_type_chart_title: "Coffee Type Distribution",
            brand_map_chart_title: "Brand Positioning Map",
            brand_map_chart_subtitle: "Brand Segmentation by AI",
            brand_map_chart_x_axis: "Average Price (VND/kg)",
            brand_map_chart_y_axis: "Number of Product Lines (SKUs)",
            brand_map_chart_tip: "Avg. Price",
            segment_low: "Mass Market",
            segment_mid: "Mid-High End",
            segment_high: "Specialty/Luxury",
            default_shipping_fee_label: "Default Shipping Fee (VND):",
            freeship_chart_title: "Freeship Threshold Efficiency Analysis",
            ai_welcome_message: "<strong>Hello!</strong> I am your strategic analysis assistant. Ask a question about the coffee market based on the current data, or select a suggestion below to get started.",
            ai_suggestions_label: "Analysis Suggestions:",
            ai_prompt_1: "What are the characteristics of the market segments?",
            ai_prompt_2: "Compare the logistics strategies of the brands.",
            ai_prompt_3: "What is the most important factor for high-end customers?",
            ai_input_placeholder: "Enter your question...",
            ai_send_btn: "Send",
            task_queue_title: "Task Queue (<span id=\"task-count\">0</span>)",
            task_queue_clear_btn: "Clear",
            settings_modal_title: "Display & Key Settings",
            settings_modal_desc: "Customize which columns are displayed and which are used as deduplication keys.",
            settings_modal_cancel_btn: "Cancel",
            settings_modal_apply_btn: "Apply",
            api_key_modal_title: "Set Gemini API Key",
            api_key_modal_desc: "Please provide your Gemini API key to use the AI analysis feature. The key will be stored in your browser session.",
            api_key_modal_label: "Gemini API Key",
            api_key_modal_cancel_btn: "Cancel",
            api_key_modal_save_btn: "Save",
            help_modal_title: "<strong><a href=\"https://github.com/thienan092/data-phinter/tree/main\" target=\"_blank\" class=\"inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors duration-200\">Data Phin-ter<svg class=\"h-5 w-5 mr-1\" fill=\"currentColor\" viewBox=\"0 0 24 24\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.47.087.68-.233.68-.522 0-.256-.009-.937-.015-1.839-2.775.605-3.364-1.34-3.364-1.34-.454-1.157-1.11-1.46-1.11-1.46-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.529 2.341 1.087 2.91.828.092-.647.35-1.087.636-1.334-2.22-.253-4.555-1.113-4.555-4.953 0-1.096.393-1.995 1.029-2.693-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.70.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.099 2.65.637.698 1.029 1.597 1.029 2.693 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.334-.012 2.41-.012 2.72 0 .289.208.61.691.522C21.135 20.197 24 16.442 24 12.017 24 6.484 19.522 2 14 2h-2z\" clip-rule=\"evenodd\" /></svg></a></strong>",
            help_intro1: "This version is designed to integrate the most basic analysis functions so that non-tech users can standardize and accumulate \"deep search data\" (data obtained through the <a href=\"https://gemini.google/overview/deep-research/?hl=en\" target=\"_blank\">Deep Research</a> function of the Gemini large language model) over time.",
            help_intro2_speed: "<strong>Version:</strong> Online Shelf Data (for-speed version)",
            help_intro2_stable: "<strong>Version:</strong> Online Shelf Data (stable version)",
            help_intro3_speed: "<strong>Version Number:</strong> v1.0+bs4",
            help_intro3_stable: "<strong>Version Number:</strong> v1.0+selenium",
            help_intro4: "<strong>Topic:</strong> Coffee Market",
            help_key_components_title: "Key Components",
            help_key_components_1: "<strong>Time Filter:</strong> Allows you to select a time range for analysis. All data and charts on the page will update based on your selection.",
            help_key_components_2_title: "Navigation Tabs:",
            help_key_components_2_1: "<strong>SST Data:</strong> This is where the Single Source of Truth is displayed. It's your data management hub, and all analyses are based on the data shown here.",
            help_key_components_2_2: "<strong>Market Overview:</strong> Provides a high-level view of brand price positioning and the distribution of coffee types.",
            help_key_components_2_3: "<strong>Competitive Analysis:</strong> Visualizes the market position of brands based on average price and number of products (SKUs).",
            help_key_components_2_4: "<strong>Logistics Operations:</strong> Integrates a simulation of the total actual cost to the customer based on cart value and each brand's freeship policy.",
            help_key_components_2_5: "<strong>AI Analysis:</strong> Allows you to ask questions in natural language to receive strategic analyses and recommendations from an AI based on statistics from the current data.",
            help_sst_functions_title: "SST Data Tab Functions",
            help_sst_functions_1: "<strong>Add Data:</strong> Allows you to upload a CSV file to add data to the system. The system will automatically assign unique IDs to rows that don't have one.",
            help_sst_functions_2: "<strong>Export to CSV:</strong> Downloads all currently displayed data to a CSV file.",
            help_sst_functions_3_title: "Display & Key Settings:",
            help_sst_functions_3_1: "Toggle the visibility of each column in the grid.",
            help_sst_functions_3_2: "Select columns to use as \"keys\" for deduplication. Rows with the same values across all selected columns will be hidden, keeping only the first row according to the current sort order.",
            help_sst_functions_4_title: "Check for Price Updates:",
            help_sst_functions_4_desc: "Automatically visits the <strong>\"Product Links\"</strong> (the <strong>Link</strong> column) to verify and update the prices for the products, except for products had status <span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800\">Old</span>. The status will be updated:",
            help_sst_functions_4_1: "<strong><span class=\"add-new-version-btn bg-yellow-400 text-yellow-900 text-xs font-bold py-1 px-2 rounded hover:bg-yellow-500\">New</span>:</strong> The price has changed. Click the <span class=\"add-new-version-btn bg-yellow-400 text-yellow-900 text-xs font-bold py-1 px-2 rounded hover:bg-yellow-500\">Add?</span> button to create a new version with the updated price.",
            help_sst_functions_4_2: "<strong><span class=\"bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold py-1 px-2 rounded\">Warning <(number)></span>:</strong> The price was not found by scraping with the selector (the <strong>\"HTML\"</strong> column), but more than one (exact number is displayed in <strong><i>&lt;(number)&gt;</i></strong> and not displayed if it is <strong><i>1</i></strong>) match for the old price was found in the data row. The selector needs to be updated to ensure data accuracy.",
            help_sst_functions_4_3: "<strong><span class=\"bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded\">Error</span>:</strong> The price was not found by scraping with the selector (the <strong>\"HTML\"</strong> column) and no match for the old price was found in the data row. The URL has likely changed or is simply incorrect. Click the <span class=\"bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded\">Remove?</span> button to remove the row completely from the SST data.",
            help_sst_functions_4_note: "<i><strong>Note:</strong> Although the price statuses from the session are saved to the CSV file, when the file is opened, the application will assume that the \"Error\" statuses from the previous session have been reviewed and will be labeled as \"Live\". Thus, there will only be two statuses, \"Live\" and \"Old\", when starting a new session.</i>",
            help_sst_functions_5: "<strong>Add All Changes:</strong> Automatically creates a new version (of the form <strong><i>&lt;current row ID&gt;-v&lt;version number&gt;</i></strong>) for all rows with the status <span class=\"add-new-version-btn bg-yellow-400 text-yellow-900 text-xs font-bold py-1 px-2 rounded hover:bg-yellow-500\">M·ªõi</span>.",
            help_task_queue_title: "Task Queue",
            help_task_queue_desc: "This queue appears when you run the <strong>\"Check for Price Updates\"</strong> function. It allows you to monitor progress and manage tasks. You can drag, drop, and collapse it to save space.",
            help_support_title: "üéâ Find this application useful?",
            help_support_desc: "Please <a href=\"https://www.buymeacoffee.com/anlt\" target=\"_blank\" style=\"color: #d48806; font-weight: bold; text-decoration: underline;\">buy me a coffee</a> to fuel further development ‚òï.",
            help_support_thanks: "Your support is a great source of inspiration. Thank you sincerely üíõ",
            col_id: "ID",
            col_header_status_update: "Price Updated?",
            col_header_product: "Product Name",
            col_header_brand: "Brand Name",
            col_header_list_price: "Listed Price (VND)",
            col_header_date_added: "Data Date",
            col_header_shipping_fee: "Shipping Fee (VND)",
            col_header_freeship_threshold: "Freeship Threshold (VND)",
            col_header_source: "Citation Source",
            col_header_coffee_type: "Coffee Type",
            col_header_unit: "Unit",
            col_header_location: "Sell Location",
            col_header_link: "Product Link",
            col_header_html_selector: "HTML Selector (Price)",
            col_header_ecommerce_platform: "E-commerce Platform",
            col_header_update_status: "Update Status",
            col_status_update: "Price Updated?",
            col_product: "Product",
            col_brand: "Brand",
            col_list_price: "Listed Price (VND)",
            col_date_added: "Date",
            col_shipping_fee: "Shipping Fee (VND)",
            col_freeship_threshold: "Freeship Threshold (VND)",
            col_source: "Source",
            col_coffee_type: "Product Type",
            col_unit: "Unit",
            col_location: "Location",
            col_link: "Product Link",
            col_html_selector: "HTML",
            col_ecommerce_platform: "E-commerce Platform",
            col_update_status: "Update Status",
            download_file_name: "sst-en.csv",
            status_add_btn: "Add?",
            status_new: "New",
            status_error: "Error",
            status_warning: "Warning",
            status_remove_btn: "Remove?",
            status_updated: "Live",
            status_outdated: "Old",
            status_not_checked: "Not Checked",
            alert_in_progress: "A check is already in progress. Please wait.",
            alert_invalid_csv: "Invalid or empty CSV file.",
            alert_no_valid_data: "No valid data in the file to add.",
            alert_rows_added: "rows added successfully.",
            alert_no_export_data: "No data to export.",
            alert_enter_api_key: "Please enter a valid API Key.",
            alert_cannot_cancel_task: 'Cannot cancel running task',
            alert_cannot_clear_task: 'Cannot remove task from the queue',
            alert_lang_detect: "Detected that the current language option does not match the input format. The system decided to try with another language!",
            loading_ai: "AI expert is analyzing...",
            error_ai: "An error occurred during analysis:",
            error_ai_response: "Sorry, I couldn't generate a response at this time.",
            cart_value: 'Cart Value (VND)',
            total_customer_cost: 'Total Customer Cost (VND)',
            cart: 'Cart',
            total_cost: 'Total Cost'
        },
        vn: {
            page_title: "·ª®ng D·ª•ng H·ªó Tr·ª£ Ki·ªÉm Ch·ª©ng v√† T√≠ch L≈©y D·ªØ Li·ªáu \"T√¨m Ki·∫øm S√¢u\" (b·∫£n K·ªá H√†ng C√† Ph√™ Tr·ª±c Tuy·∫øn)",
            main_title: "D·ªØ Li·ªáu K·ªá H√†ng C√† Ph√™ Tr·ª±c Tuy·∫øn",
            user_guide_title: "H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng",
            time_filter_label: "B·ªô l·ªçc Th·ªùi gian:",
            sst_data_tab: "D·ªØ Li·ªáu SST",
            market_overview_tab: "T·ªïng quan Th·ªã tr∆∞·ªùng",
            competitive_analysis_tab: "Ph√¢n t√≠ch C·∫°nh tranh",
            logistics_ops_tab: "V·∫≠n h√†nh Logistics",
            ai_analysis_tab: "Ph√¢n t√≠ch AI",
            add_data_btn: "\<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-5 w-5 inline-block mr-2\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\"\>\<path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" /\>\</svg\>Th√™m d·ªØ li·ªáu",
            export_csv_btn: "üì§ T·∫°o file CSV",
            add_all_changes_btn: "Th√™m t·∫•t c·∫£ thay ƒë·ªïi",
            check_price_updates_btn: "Ki·ªÉm tra/C·∫≠p nh·∫≠t Gi√°",
            settings_btn_title: "Thi·∫øt l·∫≠p Hi·ªÉn th·ªã & Kh√≥a",
            avg_price_chart_title: "ƒê·ªãnh v·ªã Gi√° Trung b√¨nh theo Th∆∞∆°ng hi·ªáu (VND/kg)",
            coffee_type_chart_title: "Ph√¢n b·ªï Ch·ªßng lo·∫°i C√† ph√™",
            brand_map_chart_title: "B·∫£n ƒë·ªì ƒê·ªãnh v·ªã Th∆∞∆°ng hi·ªáu",
            brand_map_chart_subtitle: "Ph√¢n kh√∫c Th∆∞∆°ng hi·ªáu theo AI",
            brand_map_chart_x_axis: "M·ª©c gi√° trung b√¨nh/kg (VND)",
            brand_map_chart_y_axis: "S·ªë l∆∞·ª£ng d√≤ng s·∫£n ph·∫©m (SKUs)",
            brand_map_chart_tip: "Gi√° TB",
            segment_low: "Ph·ªï th√¥ng",
            segment_mid: "Trung-Cao c·∫•p",
            segment_high: "ƒê·∫∑c s·∫£n/Luxury",
            default_shipping_fee_label: "Ph√≠ ship m·∫∑c ƒë·ªãnh (VND):",
            freeship_chart_title: "Ph√¢n t√≠ch Hi·ªáu qu·∫£ Ng∆∞·ª°ng Freeship",
            ai_welcome_message: "<strong>Xin ch√†o!</strong> T√¥i l√† tr·ª£ l√Ω ph√¢n t√≠ch chi·∫øn l∆∞·ª£c. H√£y ƒë·∫∑t c√¢u h·ªèi v·ªÅ th·ªã tr∆∞·ªùng c√† ph√™ d·ª±a tr√™n d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã, ho·∫∑c ch·ªçn m·ªôt g·ª£i √Ω b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu.",
            ai_suggestions_label: "G·ª£i √Ω ph√¢n t√≠ch:",
            ai_prompt_1: "Ph√¢n kh√∫c th·ªã tr∆∞·ªùng ƒëang c√≥ nh·ªØng ƒë·∫∑c ƒëi·ªÉm g√¨?",
            ai_prompt_2: "So s√°nh chi·∫øn l∆∞·ª£c logistics c·ªßa c√°c th∆∞∆°ng hi·ªáu.",
            ai_prompt_3: "Y·∫øu t·ªë n√†o quan tr·ªçng nh·∫•t v·ªõi kh√°ch h√†ng cao c·∫•p?",
            ai_input_placeholder: "Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n...",
            ai_send_btn: "G·ª≠i",
            task_queue_title: "H√†ng ƒë·ª£i t√°c v·ª• (<span id=\"task-count\">0</span>)",
            task_queue_clear_btn: "L√†m Tr·ªëng",
            settings_modal_title: "Thi·∫øt l·∫≠p Hi·ªÉn th·ªã & Kh√≥a",
            settings_modal_desc: "T√πy ch·ªânh c√°c c·ªôt ƒë∆∞·ª£c hi·ªÉn th·ªã v√† c√°c c·ªôt ƒë∆∞·ª£c s·ª≠ d·ª•ng l√†m kh√≥a ch·ªëng tr√πng l·∫∑p.",
            settings_modal_cancel_btn: "H·ªßy",
            settings_modal_apply_btn: "√Åp d·ª•ng",
            api_key_modal_title: "Thi·∫øt l·∫≠p Gemini API Key",
            api_key_modal_desc: "Vui l√≤ng cung c·∫•p kh√≥a API Gemini c·ªßa b·∫°n ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng ph√¢n t√≠ch AI. Kh√≥a s·∫Ω ƒë∆∞·ª£c l∆∞u tr·ªØ trong phi√™n l√†m vi·ªác c·ªßa tr√¨nh duy·ªát.",
            api_key_modal_label: "Gemini API Key",
            api_key_modal_cancel_btn: "H·ªßy",
            api_key_modal_save_btn: "L∆∞u",
            help_modal_title: "<strong><a href=\"https://github.com/thienan092/data-phinter/tree/main\" target=\"_blank\" class=\"inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors duration-200\">Data Phin-ter<svg class=\"h-5 w-5 mr-1\" fill=\"currentColor\" viewBox=\"0 0 24 24\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.47.087.68-.233.68-.522 0-.256-.009-.937-.015-1.839-2.775.605-3.364-1.34-3.364-1.34-.454-1.157-1.11-1.46-1.11-1.46-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.529 2.341 1.087 2.91.828.092-.647.35-1.087.636-1.334-2.22-.253-4.555-1.113-4.555-4.953 0-1.096.393-1.995 1.029-2.693-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.70.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.099 2.65.637.698 1.029 1.597 1.029 2.693 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.334-.012 2.41-.012 2.72 0 .289.208.61.691.522C21.135 20.197 24 16.442 24 12.017 24 6.484 19.522 2 14 2h-2z\" clip-rule=\"evenodd\" /></svg></a></strong>",
            help_intro1: "Gi·∫£i ph√°p ƒë∆∞·ª£c thi·∫øt k·∫ø v√† t√≠ch h·ª£p nh·ªØng ch·ª©c nƒÉng ph√¢n t√≠ch c∆° b·∫£n nh·∫•t m√† m·ªôt ng∆∞·ªùi s·ª≠ d·ª•ng ph·ªï th√¥ng c√≥ th·ªÉ s·ª≠ d·ª•ng cho vi·ªác chu·∫©n h√≥a v√† t√≠ch l≈©y d·ªØ li·ªáu ch·∫•t l∆∞·ª£ng cao, c√≥ ƒë∆∞·ª£c th√¥ng qua ch·ª©c nƒÉng <a href=\"https://gemini.google/overview/deep-research/?hl=vn\" target=\"_blank\">Deep Research</a> c·ªßa m√¥ h√¨nh ng√¥n ng·ªØ l·ªõn Gemini.",
            help_intro2_speed: "<strong>Phi√™n b·∫£n:</strong> D·ªØ Li·ªáu K·ªá H√†ng Tr·ª±c Tuy·∫øn (b·∫£n ∆∞u ti√™n t·ªëc ƒë·ªô)",
            help_intro2_stable: "<strong>Phi√™n b·∫£n:</strong> D·ªØ Li·ªáu K·ªá H√†ng Tr·ª±c Tuy·∫øn (b·∫£n ·ªïn ƒë·ªãnh)",
            help_intro3_speed: "<strong>Version Number:</strong> v1.0+bs4",
            help_intro3_stable: "<strong>Version Number:</strong> v1.0+selenium",
            help_intro4: "<strong>Ch·ªß ƒë·ªÅ:</strong> Th·ªã Tr∆∞·ªùng C√† Ph√™",
            help_key_components_title: "C√°c Th√†nh ph·∫ßn Ch√≠nh",
            help_key_components_1: "<strong>L·ªçc theo Th·ªùi gian:</strong> Cho ph√©p b·∫°n ch·ªçn m·ªôt kho·∫£ng th·ªùi gian ƒë·ªÉ ph√¢n t√≠ch. To√†n b·ªô d·ªØ li·ªáu v√† bi·ªÉu ƒë·ªì tr√™n trang s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t theo l·ª±a ch·ªçn c·ªßa b·∫°n.",
            help_key_components_2_title: "C√°c Tab ƒêi·ªÅu h∆∞·ªõng:",
            help_key_components_2_1: "<strong>D·ªØ li·ªáu SST:</strong> N∆°i hi·ªÉn th·ªã Ngu·ªìn Ch√¢n L√Ω Duy Nh·∫•t (Single Source of Truth). ƒê√¢y l√† trung t√¢m qu·∫£n l√Ω d·ªØ li·ªáu c·ªßa b·∫°n v√† t·∫•t c·∫£ c√°c ph√¢n t√≠ch s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán d·ª±a tr√™n d·ªØ li·ªáu ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã t·∫°i ƒë√¢y.",
            help_key_components_2_2: "<strong>T·ªïng quan Th·ªã tr∆∞·ªùng:</strong> Cung c·∫•p c√°i nh√¨n to√†n c·∫£nh v·ªÅ ƒë·ªãnh v·ªã gi√° c·ªßa c√°c th∆∞∆°ng hi·ªáu v√† s·ª± ph√¢n b·ªï c·ªßa c√°c ch·ªßng lo·∫°i c√† ph√™.",
            help_key_components_2_3: "<strong>Ph√¢n t√≠ch C·∫°nh tranh:</strong> Tr·ª±c quan h√≥a v·ªã th·∫ø c·ªßa c√°c th∆∞∆°ng hi·ªáu tr√™n th·ªã tr∆∞·ªùng d·ª±a tr√™n gi√° trung b√¨nh v√† s·ªë l∆∞·ª£ng s·∫£n ph·∫©m (SKUs).",
            help_key_components_2_4: "<strong>V·∫≠n h√†nh Logistics:</strong> T√≠ch h·ª£p m√¥ ph·ªèng t·ªïng chi ph√≠ th·ª±c t·∫ø kh√°ch h√†ng ph·∫£i tr·∫£ d·ª±a tr√™n gi√° tr·ªã gi·ªè h√†ng v√† ch√≠nh s√°ch freeship c·ªßa t·ª´ng th∆∞∆°ng hi·ªáu.",
            help_key_components_2_5: "<strong>Ph√¢n t√≠ch AI:</strong> Cho ph√©p b·∫°n ƒë·∫∑t c√¢u h·ªèi b·∫±ng ng√¥n ng·ªØ t·ª± nhi√™n ƒë·ªÉ nh·∫≠n ƒë∆∞·ª£c c√°c ph√¢n t√≠ch v√† khuy·∫øn ngh·ªã chi·∫øn l∆∞·ª£c t·ª´ AI d·ª±a tr√™n c√°c th·ªëng k√™ t·ª´ d·ªØ li·ªáu hi·ªán t·∫°i.",
            help_sst_functions_title: "Ch·ª©c nƒÉng Tab D·ªØ li·ªáu SST",
            help_sst_functions_1: "<strong>Th√™m d·ªØ li·ªáu:</strong> Cho ph√©p b·∫°n t·∫£i l√™n m·ªôt file CSV ƒë·ªÉ b·ªï sung d·ªØ li·ªáu v√†o h·ªá th·ªëng. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g√°n c√°c ID duy nh·∫•t cho c√°c h√†ng kh√¥ng c√≥ ID.",
            help_sst_functions_2: "<strong>T·∫°o file CSV:</strong> T·∫£i xu·ªëng to√†n b·ªô d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã ra file CSV.",
            help_sst_functions_3_title: "Thi·∫øt l·∫≠p Hi·ªÉn th·ªã & Kh√≥a:",
            help_sst_functions_3_1: "B·∫≠t/t·∫Øt hi·ªÉn th·ªã c·ªßa t·ª´ng c·ªôt tr√™n l∆∞·ªõi hi·ªÉn th·ªã.",
            help_sst_functions_3_2: "Ch·ªçn c√°c c·ªôt l√†m \"kh√≥a\" ƒë·ªÉ ch·ªëng tr√πng l·∫∑p. C√°c h√†ng c√≥ c√πng gi√° tr·ªã tr√™n t·∫•t c·∫£ c√°c c·ªôt ƒë√£ ch·ªçn s·∫Ω b·ªã ·∫©n ƒëi, ch·ªâ gi·ªØ l·∫°i h√†ng ƒë·∫ßu ti√™n theo th·ª© t·ª± s·∫Øp x·∫øp hi·ªán t·∫°i.",
            help_sst_functions_4_title: "Ki·ªÉm tra/C·∫≠p nh·∫≠t Gi√°:",
            help_sst_functions_4_desc: "T·ª± ƒë·ªông truy c·∫≠p v√†o c√°c <strong>\"Link M√¥ t·∫£\"</strong> (c·ªôt <strong>Link</strong>) ƒë·ªÉ ki·ªÉm ch·ª©ng v√† c·∫≠p nh·∫≠t l·∫°i gi√° cho c√°c s·∫£n ph·∫©m, tr·ª´ c√°c s·∫£n ph·∫©m c√≥ nh√£n l√† <span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800\">C≈©</span>. Tr·∫°ng th√°i s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t:",
            help_sst_functions_4_1: "<strong><span class=\"add-new-version-btn bg-yellow-400 text-yellow-900 text-xs font-bold py-1 px-2 rounded hover:bg-yellow-500\">M·ªõi</span>:</strong> Gi√° ƒë√£ thay ƒë·ªïi. Nh·∫•n v√†o n√∫t <span class=\"add-new-version-btn bg-yellow-400 text-yellow-900 text-xs font-bold py-1 px-2 rounded hover:bg-yellow-500\">Th√™m?</span> ƒë·ªÉ t·∫°o m·ªôt phi√™n b·∫£n m·ªõi v·ªõi gi√° ƒë√£ c·∫≠p nh·∫≠t.",
            help_sst_functions_4_2: "<strong><span class=\"bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold py-1 px-2 rounded\">C·∫£nh b√°o <(s·ªë)></span>:</strong> Kh√¥ng t√¨m th·∫•y gi√° b·∫±ng vi·ªác scraping v·ªõi selector (c·ªôt <strong>HTML</strong>), nh∆∞ng t√¨m th·∫•y nhi·ªÅu h∆°n 1 (s·ªë ch√≠nh x√°c ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü <strong><i>&lt;(s·ªë)&gt;</i></strong> v√† kh√¥ng hi·ªÉn th·ªã n·∫øu ƒë√≥ l√† <strong><i>1</i></strong>) k·∫øt qu·∫£ kh·ªõp v·ªõi gi√° c≈© trong h√†ng d·ªØ li·ªáu. C·∫ßn c·∫≠p nh·∫≠t l·∫°i selector ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh ch√≠nh x√°c c·ªßa d·ªØ li·ªáu.",
            help_sst_functions_4_3: "<strong><span class=\"bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded\">L·ªói</span>:</strong> Kh√¥ng t√¨m th·∫•y gi√° b·∫±ng vi·ªác scraping v·ªõi selector (c·ªôt <strong>HTML</strong>) v√† c≈©ng kh√¥ng t√¨m th·∫•y gi√° kh·ªõp v·ªõi gi√° c≈© trong h√†ng d·ªØ li·ªáu. Nhi·ªÅu kh·∫£ nƒÉng URL ƒë√£ b·ªã thay ƒë·ªïi ho·∫∑c ƒë∆∞·ª£c thu th·∫≠p m·ªôt c√°ch kh√¥ng ch√≠nh x√°c. Nh·∫•n v√†o n√∫t <span class=\"bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded\">X√≥a?</span> ƒë·ªÉ x√≥a h√†ng l·ªói ho√†n to√†n kh·ªèi d·ªØ li·ªáu SST.",
            help_sst_functions_4_note: "<i><strong>L∆∞u √Ω:</strong> M·∫∑c d·∫ßu c√°c tr·∫°ng th√°i v·ªÅ gi√° c·ªßa phi√™n l√†m vi·ªác c≈©ng s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o file CSV nh∆∞ng khi m·ªü file th√¨ ·ª©ng d·ª•ng s·∫Ω m·∫∑c ƒë·ªãnh r·∫±ng c√°c tr·∫°ng th√°i \"L·ªói\" ·ªü phi√™n l√†m vi·ªác tr∆∞·ªõc ƒë√≥ ƒë·ªÅu ƒë√£ ƒë∆∞·ª£c xem x√©t v√† s·∫Ω g√°n nh√£n l√† \"ƒê√£\". Nh∆∞ v·∫≠y, s·∫Ω ch·ªâ c√≥ hai tr·∫°ng th√°i l√† \"ƒê√£\" v√† \"C≈©\" khi b·∫Øt ƒë·∫ßu m·ªôt phi√™n l√†m vi·ªác m·ªõi. </i>",
            help_sst_functions_5: "<strong>Th√™m t·∫•t c·∫£ thay ƒë·ªïi:</strong> T·ª± ƒë·ªông t·∫°o phi√™n b·∫£n m·ªõi (c√≥ d·∫°ng <strong><i>&lt;ID c·ªßa h√†ng hi·ªán t·∫°i&gt;-v&lt;s·ªë phi√™n b·∫£n&gt;</i></strong>) cho t·∫•t c·∫£ c√°c h√†ng c√≥ tr·∫°ng th√°i l√† <span class=\"add-new-version-btn bg-yellow-400 text-yellow-900 text-xs font-bold py-1 px-2 rounded hover:bg-yellow-500\">M·ªõi</span>.",
            help_task_queue_title: "H√†ng ƒë·ª£i T√°c v·ª•",
            help_task_queue_desc: "H√†ng ƒë·ª£i n√†y xu·∫•t hi·ªán khi b·∫°n ch·∫°y ch·ª©c nƒÉng <strong>\"Ki·ªÉm tra/C·∫≠p nh·∫≠t Gi√°\"</strong>. N√≥ cho ph√©p b·∫°n theo d√µi ti·∫øn tr√¨nh v√† qu·∫£n l√Ω c√°c t√°c v·ª•. B·∫°n c√≥ th·ªÉ k√©o th·∫£, thu g·ªçn ƒë·ªÉ ti·∫øt ki·ªám kh√¥ng gian.",
            help_support_title: "üéâ B·∫°n th·∫•y ·ª©ng d·ª•ng n√†y h·ªØu √≠ch?",
            help_support_desc: "H√£y <a href=\"https://www.buymeacoffee.com/anlt\" target=\"_blank\" style=\"color: #d48806; font-weight: bold; text-decoration: underline;\">mua cho t√¥i m·ªôt ly c√† ph√™</a> ƒë·ªÉ ti·∫øp th√™m ƒë·ªông l·ª±c ph√°t tri·ªÉn ‚òï.",
            help_support_thanks: "M·ªçi s·ª± ·ªßng h·ªô c·ªßa b·∫°n l√† ngu·ªìn c·∫£m h·ª©ng r·∫•t l·ªõn. Ch√¢n th√†nh c·∫£m ∆°n üíõ",
            col_id: "ID",
            col_header_status_update: "Gi√° ƒë√£ c·∫≠p nh·∫≠t?",
            col_header_product: "S·∫£n ph·∫©m",
            col_header_brand: "Th∆∞∆°ng hi·ªáu",
            col_header_list_price: "Gi√° ni√™m y·∫øt (VND)",
            col_header_date_added: "Ng√†y Th√™m",
            col_header_shipping_fee: "Ph√≠ ship (VND)",
            col_header_freeship_threshold: "Ng∆∞·ª°ng Freeship (VND)",
            col_header_source: "Ngu·ªìn Tr√≠ch d·∫´n",
            col_header_coffee_type: "Lo·∫°i C√† ph√™",
            col_header_unit: "ƒê∆°n v·ªã t√≠nh",
            col_header_location: "T·∫°i ƒê·ªãa ph∆∞∆°ng",
            col_header_link: "Link M√¥ t·∫£",
            col_header_html_selector: "HTML Selector (Gi√°)",
            col_header_ecommerce_platform: "N·ªÅn t·∫£ng TMƒêT",
            col_header_update_status: "T√¨nh tr·∫°ng Gi√°",
            col_status_update: "Gi√° ƒë√£ c·∫≠p nh·∫≠t?",
            col_product: "S·∫£n ph·∫©m",
            col_brand: "Th∆∞∆°ng hi·ªáu",
            col_list_price: "Gi√° ni√™m y·∫øt (VND)",
            col_date_added: "Ng√†y Th√™m",
            col_shipping_fee: "Ph√≠ ship (VND)",
            col_freeship_threshold: "Ng∆∞·ª°ng Freeship (VND)",
            col_source: "Ngu·ªìn",
            col_coffee_type: "Lo·∫°i SP",
            col_unit: "ƒê∆°n v·ªã t√≠nh",
            col_location: "ƒê·ªãa ph∆∞∆°ng",
            col_link: "Link",
            col_html_selector: "HTML",
            col_ecommerce_platform: "TMƒêT",
            col_update_status: "T√¨nh tr·∫°ng Gi√°",
            download_file_name: "sst-vn.csv",
            status_add_btn: "Th√™m?",
            status_new: "M·ªõi",
            status_error: "L·ªói",
            status_warning: "C·∫£nh b√°o",
            status_remove_btn: "X√≥a?",
            status_updated: "ƒê√£",
            status_outdated: "C≈©",
            status_not_checked: "Ch∆∞a KT",
            alert_in_progress: "M·ªôt qu√° tr√¨nh ki·ªÉm tra ƒëang ƒë∆∞·ª£c th·ª±c hi·ªán. Vui l√≤ng ƒë·ª£i.",
            alert_invalid_csv: "T·ªáp CSV kh√¥ng h·ª£p l·ªá ho·∫∑c tr·ªëng.",
            alert_no_valid_data: "Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong t·ªáp ƒë·ªÉ th√™m.",
            alert_rows_added: "h√†ng ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng.",
            alert_no_export_data: "Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.",
            alert_enter_api_key: "Vui l√≤ng nh·∫≠p m·ªôt API Key h·ª£p l·ªá.",
            alert_cannot_cancel_task: 'Kh√¥ng th·ªÉ h·ªßy t√°c v·ª• ƒëang ch·∫°y',
            alert_cannot_clear_task: 'X√≥a t√°c v·ª• kh·ªèi h√†ng ƒë·ª£i',
            alert_lang_detect: "Ph√°t hi·ªán t√πy ch·ªçn ng√¥n ng·ªØ hi·ªán t·∫°i ch∆∞a kh·ªõp v·ªõi ƒë·ªãnh d·∫°ng file ƒë·∫ßu v√†o. H·ªá th·ªëng quy·∫øt ƒë·ªãnh th·ª≠ v·ªõi ng√¥n ng·ªØ kh√°c!",
            loading_ai: "Chuy√™n gia AI ƒëang ph√¢n t√≠ch...",
            error_ai: "ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh ph√¢n t√≠ch:",
            error_ai_response: "Xin l·ªói, t√¥i kh√¥ng th·ªÉ t·∫°o ph·∫£n h·ªìi v√†o l√∫c n√†y.",
            cart_value: 'Gi√° tr·ªã gi·ªè h√†ng (VND)',
            total_customer_cost: 'T·ªïng chi ph√≠ kh√°ch h√†ng tr·∫£ (VND)',
            cart: 'Gi·ªè h√†ng',
            total_cost: 'T·ªïng tr·∫£'
        }
    };
    
    // --- 1. DATA SECTION (SYNCHRONIZED SST) ---
    // Set sst_data to empty as requested for debugging.
    let sst_data = [];
    
    // --- 3. GLOBAL STATE & UTILS ---
    let charts = {};
    let taskQueue = [];
    let avgTaskTime = 15000;
    let completedTaskTimes = [];
    const savedLang = localStorage.getItem('language') || 'en';
    let currentLang = savedLang;
    let sstGridOptions;
    let deduplicationKeys = ["ID"];
    let geminiApiKey = sessionStorage.getItem('geminiApiKey') || null;
    let isEditMode = false; // New state variable for raw mode
    let visibilityState = {};

    const getFormattedDate = () => {
        const today = new Date();
        const year = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        if (currentLang === 'vn') {
            return `${year}-${mm}-${dd}`;
        }
        return `${year}-${mm}-${dd}`;
    };

    const parseWeight = (weightStr) => {
        if (!weightStr) return 0;
        const value = parseFloat(String(weightStr).replace(/,/g, ''));
        if (String(weightStr).toLowerCase().includes('kg')) return value * 1000;
        return value;
    };

    const calculatePricePerKg = (item) => {
        const price = parseNumericValue(item['Gi√° ni√™m y·∫øt (VND)']);
        const weightInGrams = parseWeight(item['ƒê∆°n v·ªã t√≠nh']);
        if (weightInGrams === 0 || !price) return 0;
        return (price / weightInGrams) * 1000;
    };

    const parseDateString = (dateStr, lang) => {
        if (!dateStr || typeof dateStr !== 'string') return null;

        let d;
        let parts;

        if (lang === 'vn') {
            // Chu·∫©n Vi·ªát Nam: DD/MM/YYYY ho·∫∑c DD-MM-YYYY
            parts = dateStr.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})$/);
            if (parts) {
                // ƒê·∫£m b·∫£o th√°ng v√† ng√†y c√≥ 2 ch·ªØ s·ªë (padding with 0)
                const day = String(parts[1]).padStart(2, '0');
                const month = String(parts[2]).padStart(2, '0');
                const year = parts[3];
                const isoDateStr = `${year}-${month}-${day}T00:00:00`;
                d = new Date(isoDateStr);
                if (!isNaN(d.getTime())) return d;
            }
        } else if (lang === 'en') {
            // Chu·∫©n Anh/M·ªπ: MM/DD/YYYY ho·∫∑c MM-DD-YYYY
            parts = dateStr.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})$/);
            if (parts) {
                // ƒê·∫£m b·∫£o th√°ng v√† ng√†y c√≥ 2 ch·ªØ s·ªë (padding with 0)
                const month = String(parts[1]).padStart(2, '0');
                const day = String(parts[2]).padStart(2, '0');
                const year = parts[3];
                const isoDateStr = `${year}-${month}-${day}T00:00:00`;
                d = new Date(isoDateStr);
                if (!isNaN(d.getTime())) return d;
            }
        }

        // Th·ª≠ t·∫°o Date object tr·ª±c ti·∫øp t·ª´ chu·ªói (ƒë·ªÉ x·ª≠ l√Ω c√°c ƒë·ªãnh d·∫°ng chu·∫©n ISO ho·∫∑c ƒë·ªãnh d·∫°ng kh√°c m√† JS c√≥ th·ªÉ hi·ªÉu)
        d = new Date(dateStr);
        
        if (!isNaN(d.getTime())) return d;

        return null;
    };

    const parseCsvLine = (line) => {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current);
        return result;
    };

    const generateSelectorFromHtml = (htmlString) => {
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            let deepestElement = null;
            let maxDepth = -1;

            function findDeepest(elem, depth) {
                if (elem.nodeType === Node.ELEMENT_NODE && elem.textContent && /\d/.test(elem.textContent)) {
                    if (depth > maxDepth) {
                        maxDepth = depth;
                        deepestElement = elem;
                    }
                }
                for (const child of elem.children) {
                    findDeepest(child, depth + 1);
                }
            }

            findDeepest(doc.body, 0);

            if (!deepestElement) return null;

            let current = deepestElement;
            let path = [];
            
            while(current && current.tagName && current.tagName.toLowerCase() !== 'body') {
                const tagName = current.tagName.toLowerCase();
                const id = current.id;
                const classes = Array.from(current.classList).filter(c => c && typeof c === 'string').join('.');
                
                let segment = tagName;
                if (id) {
                    segment = `#${id}`;
                    path.unshift(segment);
                    break; 
                } else if (classes) {
                    segment += `.${classes}`;
                }

                path.unshift(segment);

                if (classes && !['price', 'amount'].every(c => classes.includes(c))) {
                    break;
                }
                
                current = current.parentElement;
            }

            return path.join(' > ');

        } catch (e) {
            console.error("Error generating selector from HTML:", e);
            return null;
        }
    };

    const parseNumericValue = (value) => {
        if (typeof value !== 'string' && typeof value !== 'number') {
            return null;
        }
        const strValue = String(value);
        const match = strValue.match(/(\d[\d,.]*)/);
        if (match) {
            if (currentLang === "vn") {
                // Chuy·ªÉn ƒë·ªïi d·∫•u ph·∫©y th√†nh d·∫•u ch·∫•m n·∫øu l√† ti·∫øng Vi·ªát
                return parseFloat(match[0].replace(/,/g, ''));
            }
            return parseFloat(match[0].replace(/\./g, ''));
        }
        return null;
    };

    const makeDraggable = (element, handle) => {
        let startMouseX, startMouseY;
        let startElemX, startElemY;
        let active = false;
        let rafId = null; // ƒê·ªÉ l∆∞u ID c·ªßa requestAnimationFrame
        let newX = 0, newY = 0; // Bi·∫øn ƒë·ªÉ l∆∞u v·ªã tr√≠ m·ªõi nh·∫•t

        handle.addEventListener("mousedown", dragStart, false);
        handle.addEventListener("touchstart", dragStart, false); // Add touch support

        function dragStart(e) {
            e.preventDefault();

            if (e.type === "touchstart") {
                startMouseX = e.touches[0].clientX;
                startMouseY = e.touches[0].clientY;
            } else {
                startMouseX = e.clientX;
                startMouseY = e.clientY;
            }

            // L·∫•y v·ªã tr√≠ hi·ªán t·∫°i c·ªßa ph·∫ßn t·ª≠ t·ª´ transform
            const transformMatrix = new WebKitCSSMatrix(window.getComputedStyle(element).transform);
            startElemX = transformMatrix.m41; // gi√° tr·ªã translate X
            startElemY = transformMatrix.m42; // gi√° tr·ªã translate Y
            
            active = true;

            // G√°n c√°c s·ª± ki·ªán l·∫Øng nghe
            document.addEventListener("mousemove", drag, { passive: true }); // D√πng { passive: true } cho s·ª± ki·ªán cu·ªôn/k√©o
            document.addEventListener("mouseup", dragEnd);
            document.addEventListener("touchmove", drag, { passive: true }); // D√πng { passive: true }
            document.addEventListener("touchend", dragEnd);
        }

        function drag(e) {
            if (active) {
                let currentX, currentY;
                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                } else {
                    currentX = e.clientX;
                    currentY = e.clientY;
                }

                const deltaX = currentX - startMouseX;
                const deltaY = currentY - startMouseY;

                newX = startElemX + deltaX;
                newY = startElemY + deltaY;

                // Ch·ªâ y√™u c·∫ßu requestAnimationFrame n·∫øu ch∆∞a c√≥ m·ªôt y√™u c·∫ßu n√†o ƒëang ch·ªù
                if (!rafId) {
                    rafId = requestAnimationFrame(updatePosition);
                }
            }
        }

        function updatePosition() {
            // √Åp d·ª•ng transform ·ªü ƒë√¢y
            element.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
            rafId = null; // ƒê·∫∑t l·∫°i rafId sau khi ƒë√£ c·∫≠p nh·∫≠t
        }

        function dragEnd(e) {
            active = false;
            // H·ªßy b·ªè b·∫•t k·ª≥ requestAnimationFrame ƒëang ch·ªù n√†o
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }

            // G·ª° b·ªè c√°c s·ª± ki·ªán l·∫Øng nghe
            document.removeEventListener("mousemove", drag);
            document.removeEventListener("mouseup", dragEnd);
            document.removeEventListener("touchmove", drag);
            document.removeEventListener("touchend", dragEnd);
            
            // ƒê·∫£m b·∫£o v·ªã tr√≠ cu·ªëi c√πng ƒë∆∞·ª£c c·∫≠p nh·∫≠t n·∫øu c√≥ thay ƒë·ªïi nh·ªè n√†o ƒë√≥ ch∆∞a ƒë∆∞·ª£c render
            // Ho·∫∑c g·ªçi l·∫°i updatePosition n·∫øu b·∫°n mu·ªën ƒë·∫£m b·∫£o v·ªã tr√≠ ƒë∆∞·ª£c "ch·ªët" ngay l·∫≠p t·ª©c
            // N·∫øu kh√¥ng c√≥ v·∫•n ƒë·ªÅ g√¨ v·ªÅ ƒë·ªô ch√≠nh x√°c nh·ªè, b·∫°n c√≥ th·ªÉ b·ªè qua b∆∞·ªõc n√†y
            updatePosition(); 

            // G·ªçi h√†m ƒëi·ªÅu ch·ªânh v·ªã tr√≠ cu·ªëi c√πng c·ªßa Task Queue sau khi k√©o xong
            adjustTaskQueuePosition(); 
        }
    };

    const adjustTaskQueuePosition = () => {
        const element = document.getElementById('task-queue-container');
        const chieuRongManHinh = window.innerWidth;
        const chieuCaoManHinh = window.innerHeight;
        const khoangDem = 8; // Adjusted padding for mobile (0.5rem)

        const rect = element.getBoundingClientRect();

        const transformMatrix = new WebKitCSSMatrix(window.getComputedStyle(element).transform);
        let viTriX_Moi = transformMatrix.m41;
        let viTriY_Moi = transformMatrix.m42;

        // Ensure it stays within bounds
        if (rect.right > chieuRongManHinh - khoangDem) {
            viTriX_Moi -= (rect.right - (chieuRongManHinh - khoangDem));
        }
        if (rect.left < khoangDem) {
            viTriX_Moi += (khoangDem - rect.left);
        }
        if (rect.bottom > chieuCaoManHinh - khoangDem) {
            viTriY_Moi -= (rect.bottom - (chieuCaoManHinh - khoangDem));
        }
        if (rect.top < khoangDem) {
            viTriY_Moi += (khoangDem - rect.top);
        }

        element.style.transform = `translate3d(${viTriX_Moi}px, ${viTriY_Moi}px, 0)`;
    };

    // Function to make chart containers resizable
    const makeResizable = (element) => {
        const handle = element.querySelector('.resize-handle.bottom-right'); // Only target bottom-right
        if (!handle) return; // Exit if handle not found

        let startX, startY, startWidth, startHeight;

        const initResize = (e) => {
            e.preventDefault();
            startX = e.clientX || e.touches[0].clientX;
            startY = e.clientY || e.touches[0].clientY;
            startWidth = element.offsetWidth;
            startHeight = element.offsetHeight;

            document.addEventListener('mousemove', resize, false);
            document.addEventListener('mouseup', stopResize, false);
            document.addEventListener('touchmove', resize, false);
            document.addEventListener('touchend', stopResize, false);
        };

        const resize = (e) => {
            let currentX = e.clientX || e.touches[0].clientX;
            let currentY = e.clientY || e.touches[0].clientY;
            
            let newWidth = startWidth + (currentX - startX);
            let newHeight = startHeight + (currentY - startY);

            element.style.width = Math.max(200, newWidth) + 'px'; // Minimum width
            element.style.height = Math.max(200, newHeight) + 'px'; // Minimum height

            // Update chart inside
            const chartId = element.dataset.chartId;
            if (charts[chartId]) {
                charts[chartId].resize(); // Trigger Chart.js resize
            }
        };

        const stopResize = () => {
            document.removeEventListener('mousemove', resize, false);
            document.removeEventListener('mouseup', stopResize, false);
            document.removeEventListener('touchmove', resize, false);
            document.removeEventListener('touchend', stopResize, false);
        };

        handle.addEventListener('mousedown', initResize, false);
        handle.addEventListener('touchstart', initResize, false);
    };


    // --- 4. FUNCTION DEFINITIONS ---
    const createChart = (ctx, type, data, options) => {
        if (charts[ctx.canvas.id]) charts[ctx.canvas.id].destroy();
        charts[ctx.canvas.id] = new Chart(ctx, { type, data, options });
    };

    const updateChartsFromGridData = () => {
        const dataForCharts = [];
        if (sstGridOptions.api) {
            sstGridOptions.api.forEachNodeAfterFilter(node => {
                dataForCharts.push(node.data);
            });
        }
        
        const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
        switch(activeTab) {
            case 'marketOverviewTab':
                updateBrandPriceChart(dataForCharts);
                updateCoffeeTypeChart(dataForCharts);
                break;
            case 'competitiveAnalysisTab':
                updateBrandPositioningChart(dataForCharts);
                break;
            case 'logisticsTab':
                updateFreeshipChart(dataForCharts);
                break;
        }
    };

    const filterDataByDateRange = (data, startDate, endDate) => {
        filteredData = [...data];
        if (!(!startDate || !endDate)) {
            const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), 0, 0, 0, 0).getTime();
            const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate(), 23, 59, 59, 999).getTime();

            filteredData = filteredData.filter(item => {
                const itemDate = parseDateString(item[translations["vn"].col_date_added], currentLang);
                if (!itemDate) return false;
                const itemTime = itemDate.getTime();
                return itemTime >= start && itemTime <= end;
            });
        }
        return filteredData;
    };

    const dedupData = (data) => {
        filteredData = [...data];
        if (deduplicationKeys.length === 0) return;

        const seen = new Set();
        const rowsToRemove = [];
        const rowsToKeep = [];
        const nodesToProcess = [];
        
        filteredData.forEach(item => {
            const key = deduplicationKeys.map(k => item[k]).join('||');
            if (seen.has(key)) {
                rowsToRemove.push(item);
            } else {
                seen.add(key);
                rowsToKeep.push(item);
            }
        });

        if (rowsToRemove.length > 0) {
            filteredData = rowsToKeep;
        }

        return filteredData;
    };

    const applyAllFilters = (startDate, endDate, is_remove=false) => {
        filteredData = [...sst_data];
        
        const fromDate = picker.getStartDate();
        const toDate = picker.getEndDate();
        filteredData = filterDataByDateRange(filteredData, fromDate, toDate);
        filteredData = dedupData(filteredData);

        setViewMode();

        if (sstGridOptions && sstGridOptions.api) {
            let sstGridOptionsData = [];
            sstGridOptions.api.forEachNodeAfterFilterAndSort(node => {
                sstGridOptionsData.push(node.data);
            });
            if (is_remove) {
                rowsToRemove = sstGridOptionsData.filter(item => !filteredData.includes(item));
                sstGridOptions.api.applyTransaction({ remove: rowsToRemove });
            }
            else {
                sstGridOptions.api.applyTransaction({ remove: sstGridOptionsData });
                sstGridOptions.api.setRowData(filteredData);
            }
        }
    };

    const getOriginalLangUpdateStatus = (status) => {
        // Map the status to the current language
        if (translations[currentLang].status_new === status) {
            return translations["vn"].status_new;
        }
        if (translations[currentLang].status_error === status) {
            return translations["vn"].status_error;
        }
        if (translations[currentLang].status_outdated === status) {
            return translations["vn"].status_outdated;
        }
        return translations["vn"].status_updated;
    };

    const updateBrandPriceChart = (data) => {
        const brandData = data.reduce((acc, item) => {
            const brand = item['Th∆∞∆°ng hi·ªáu'];
            if (!acc[brand]) acc[brand] = { total_price_per_kg: 0, count: 0 };
            const pricePerKg = calculatePricePerKg(item);
            if(pricePerKg > 0) {
                acc[brand].total_price_per_kg += pricePerKg;
                acc[brand].count++;
            }
            return acc;
        }, {});
        const labels = Object.keys(brandData).filter(brand => brandData[brand].count > 0);
        const avgPrices = labels.map(brand => brandData[brand].total_price_per_kg / brandData[brand].count);
        const ctx = document.getElementById('brandPriceChart').getContext('2d');
        const locale = currentLang === 'vn' ? 'vi-VN' : 'en-US';
        createChart(ctx, 'bar', {
            labels,
            datasets: [{
                label: 'Gi√° trung b√¨nh (VND/kg)',
                data: avgPrices,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        }, {
            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
            scales: { x: { beginAtZero: true, ticks: { callback: value => value.toLocaleString(locale) + 'ƒë' } } },
            plugins: { legend: { display: false } }
        });
    };

    const updateCoffeeTypeChart = (data) => {
        const typeData = data.reduce((acc, item) => {
            let type = 'Blend';
            const coffeeType = item[translations["vn"].col_coffee_type] ? item[translations["vn"].col_coffee_type].toLowerCase() : '';
            if (coffeeType.includes('robusta') && !coffeeType.includes('arabica')) type = '100% Robusta';
            else if (coffeeType.includes('arabica') && !coffeeType.includes('robusta')) type = '100% Arabica';
            else if (coffeeType.includes('specialty') || coffeeType.includes('moka') || coffeeType.includes('bourbon') || coffeeType.includes('organic') || coffeeType.includes('yirgacheffe') || coffeeType.includes('honduras')) type = 'Specialty/Single Origin';
            acc[type] = (acc[type] || 0) + 1;
            return acc;
        }, {});
        const ctx = document.getElementById('coffeeTypeChart').getContext('2d');
        createChart(ctx, 'doughnut', {
            labels: Object.keys(typeData),
            datasets: [{ data: Object.values(typeData), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'] }]
        }, { responsive: true, maintainAspectRatio: false });
    };
    
    const updateBrandPositioningChart = (data) => {
      const pricesPerKg = data.map(item => calculatePricePerKg(item)).filter(p => p !== null && isFinite(p));
      pricesPerKg.sort((a, b) => a - b);

      const getPercentile = (arr, q) => {
          if (arr.length === 0) return null;
          const pos = (arr.length - 1) * q;
          const base = Math.floor(pos);
          const rest = pos - base;
          if (arr[base + 1] !== undefined) {
              return arr[base] + rest * (arr[base + 1] - arr[base]);
          } else {
              return arr[base];
          }
      };

      const q1 = getPercentile(pricesPerKg, 0.25);
      const q3 = getPercentile(pricesPerKg, 0.75);
        
      const brandData = data.reduce((acc, item) => {
        const brand = item['Th∆∞∆°ng hi·ªáu'];
        if (!acc[brand]) acc[brand] = { skus: 0, total_price_per_kg: 0, count: 0 };
        acc[brand].skus++;
        const pricePerKg = calculatePricePerKg(item);
        if (pricePerKg > 0) {
          acc[brand].total_price_per_kg += pricePerKg;
          acc[brand].count++;
        }
        return acc;
      }, {});

      const brandColors = {};
      const colorPalette = ['#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9A6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075'];
      Object.keys(brandData).forEach((brand, index) => {
        brandColors[brand] = colorPalette[index % colorPalette.length];
      });

      const segmentColors = {
        'Ph·ªï th√¥ng': 'rgba(54, 162, 235, 0.7)',
        'Trung-Cao c·∫•p': 'rgba(255, 206, 86, 0.7)',
        'ƒê·∫∑c s·∫£n/Luxury': 'rgba(255, 99, 132, 0.7)'
      };

      const groupedBySegment = {
        [translations[currentLang].segment_low]: [],
        [translations[currentLang].segment_mid]: [],
        [translations[currentLang].segment_high]: []
      };

      Object.keys(brandData).forEach((brand) => {
        const stats = brandData[brand];
        const avgPrice = stats.count > 0 ? stats.total_price_per_kg / stats.count : 0;
        const skus = stats.skus;
        let segment = translations[currentLang].segment_low;
        const dataForAI = [];
        sstGridOptions.api.forEachNodeAfterFilter(node => dataForAI.push(node.data));
        
        const global_stats = calculateStats(dataForAI);
        if (avgPrice > (global_stats.price_percentile_75)) segment = translations[currentLang].segment_high;
        else if (avgPrice >= (global_stats.price_percentile_25)) segment = translations[currentLang].segment_mid;

        groupedBySegment[segment].push({
          x: avgPrice,
          y: skus,
          r: skus * 4 + 6,
          brand: brand
        });
      });

      const datasets = Object.entries(groupedBySegment)
        .filter(([_, points]) => points.length > 0)
        .map(([segment, points]) => ({
          label: segment,
          data: points,
          backgroundColor: segmentColors[segment],
          borderColor: segmentColors[segment],
          borderWidth: 2
        }));

      const ctx = document.getElementById('brandPositioningChart').getContext('2d');
      const locale = currentLang === 'vn' ? 'vi-VN' : 'en-US';
      createChart(ctx, 'bubble', { datasets }, {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: translations[currentLang].brand_map_chart_x_axis },
              ticks: {
                callback: value => value.toLocaleString(locale) + 'ƒë'
              }
            },
            y: {
              title: { display: true, text: translations[currentLang].brand_map_chart_y_axis },
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          },
          plugins: {
            title: { display: true, text: translations[currentLang].brand_map_chart_subtitle },
            legend: {
                display: true,
                position: 'top',
                labels: {
                  boxWidth: 20,
                  padding: 15
                }
            },
            tooltip: {
              callbacks: {
                title: (ctx) => `${ctx[0]?.dataset?.label}`,
                label: function(context) {
                  const item = context.raw;
                  return `${item.brand}: (${translations[currentLang].brand_map_chart_tip}: ${Math.round(item.x).toLocaleString(locale)}ƒë, SKU: ${item.y})`;
                }
              }
            }
          }
        });
    };

    const updateFreeshipChart = (data) => {
        const datasets = [];
        const colors = ['#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9A6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075'];
        const uniqueBrands = [...new Set(data.map(item => item['Th∆∞∆°ng hi·ªáu']))];
        const phiShipMacDinh = parseInt(document.getElementById('input-default-ship-fee').value);
        const locale = currentLang === 'vn' ? 'vi-VN' : 'en-US';
        const dataForAI = [];
        sstGridOptions.api.forEachNodeAfterFilter(node => dataForAI.push(node.data));
        
        const global_stats = calculateStats(dataForAI);

        uniqueBrands.forEach((brand, index) => {
            const brandData = data.find(item => item['Th∆∞∆°ng hi·ªáu'] === brand);
            const freeship = parseNumericValue(brandData?.['Ng∆∞·ª°ng Freeship (VND)']);
            const fee = parseNumericValue(brandData?.['Ph√≠ ship (VND)']) || phiShipMacDinh;

            if (freeship === null) return;

            const dataPoints = [];
            for (let value = 0; value <= (global_stats.price_percentile_75+global_stats.freeship_threshold_max); value += ((global_stats.price_percentile_75+global_stats.freeship_threshold_max) / 30)) {
                let totalCost = (value > 0 && value < freeship) ? value + fee : value;
                dataPoints.push({ x: value, y: totalCost });
            }
            datasets.push({
                label: brand, data: dataPoints, borderColor: colors[index % colors.length],
                fill: false, tension: 0.1
            });
        });
        const ctx = document.getElementById('freeshipChart').getContext('2d');
        createChart(ctx, 'line', { datasets }, {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { type: 'linear', position: 'bottom', title: { display: true, text: translations.cart_value }, ticks: { callback: value => value.toLocaleString(locale) + 'ƒë' } },
                y: { title: { display: true, text: translations.total_customer_cost }, ticks: { callback: value => value.toLocaleString(locale) + 'ƒë' } }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: (ctx) => `${translations.cart}: ${ctx[0].parsed.x.toLocaleString(locale)}ƒë`,
                        label: (ctx) => `${ctx.dataset.label}: ${translations.total_cost} ${ctx.parsed.y.toLocaleString(locale)}ƒë`
                    }
                }
            }
        });
    };

    const addMessage = (text, sender, elementId = null) => {
        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        if (elementId) {
            messageDiv.id = elementId;
        }

        if (sender === 'user') {
            messageDiv.classList.add('user-message');
            messageDiv.textContent = text;
        } else if (sender === 'bot') {
            messageDiv.classList.add('bot-message');
            messageDiv.innerHTML = text; // Use innerHTML to render formatted text
        } else if (sender === 'loading') {
            messageDiv.classList.add('loading-message');
            messageDiv.textContent = text;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return messageDiv;
    };

    const calculateStats = (data) => {
        if (!data || data.length === 0) {
            return { error: "No data available for analysis." };
        }

        const pricesPerKg = data.map(item => calculatePricePerKg(item)).filter(p => p !== null && isFinite(p));
        pricesPerKg.sort((a, b) => a - b);
        
        const getPercentile = (arr, q) => {
            if (arr.length === 0) return null;
            const pos = (arr.length - 1) * q;
            const base = Math.floor(pos);
            const rest = pos - base;
            if (arr[base + 1] !== undefined) {
                return arr[base] + rest * (arr[base + 1] - arr[base]);
            } else {
                return arr[base];
            }
        };

        const freeshipSeries = data.map(item => parseNumericValue(item[translations["vn"].col_freeship_threshold])).filter(v => v !== null);
        freeshipSeries.sort((a, b) => a - b);

        const stats = {
            num_products: data.length,
            num_brands: new Set(data.map(item => item[translations["vn"].col_brand])).size,
            current_year: new Date().getFullYear(),
            price_min_per_kg: pricesPerKg.length > 0 ? Math.round(pricesPerKg[0]) : 'N/A',
            price_max_per_kg: pricesPerKg.length > 0 ? Math.round(pricesPerKg[pricesPerKg.length - 1]) : 'N/A',
            price_percentile_25: pricesPerKg.length > 0 ? Math.round(getPercentile(pricesPerKg, 0.25)) : 'N/A',
            price_percentile_75: pricesPerKg.length > 0 ? Math.round(getPercentile(pricesPerKg, 0.75)) : 'N/A',
            main_sources: [...new Set(data.map(item => item[translations["vn"].col_source]))].slice(0, 5).join(', ') + (new Set(data.map(item => item[translations["vn"].col_source])).size > 5 ? '...' : ''),
            freeship_threshold_min: freeshipSeries.length > 0 ? Math.round(freeshipSeries[0]) : 'N/A',
            freeship_threshold_max: freeshipSeries.length > 0 ? Math.round(freeshipSeries[freeshipSeries.length - 1]) : 'N/A',
            freeship_threshold_avg: freeshipSeries.length > 0 ? Math.round(getPercentile(freeshipSeries, 0.5)) : 'N/A', // Median
        };

        return stats;
    };

    const calculateLangStats = (stats) => {
        
        const locale = currentLang === 'vn' ? 'vi-VN' : 'en-US'; // Define locale here
        const lang_stats = {
            num_products: stats.num_products,
            num_brands: stats.num_brands,
            current_year: new Date().getFullYear(),
            price_min_per_kg: stats.price_min_per_kg !== 'N/A' ? stats.price_min_per_kg.toLocaleString(locale) : 'N/A',
            price_max_per_kg: stats.price_max_per_kg !== 'N/A' ? stats.price_max_per_kg.toLocaleString(locale) : 'N/A',
            price_percentile_25: stats.price_percentile_25 !== 'N/A' ? stats.price_percentile_25.toLocaleString(locale) : 'N/A',
            price_percentile_75: stats.price_percentile_75 !== 'N/A' ? stats.price_percentile_75.toLocaleString(locale) : 'N/A',
            main_sources: stats.main_sources,
            freeship_threshold_min: stats.freeship_threshold_min !== 'N/A' ? stats.freeship_threshold_min.toLocaleString(locale) : 'N/A',
            freeship_threshold_max: stats.freeship_threshold_max !== 'N/A' ? stats.freeship_threshold_max.toLocaleString(locale) : 'N/A',
            freeship_threshold_avg: stats.freeship_threshold_avg !== 'N/A' ? stats.freeship_threshold_avg.toLocaleString(locale) : 'N/A',
        };

        return lang_stats;
    };

    const generateDynamicPrompt = (stats, userQuestion) => {
        if (stats.error) {
            return `Error: ${stats.error}`;
        }

        lang_stats = calculateLangStats(stats);
        let promptTemplate = `
**B·ªëi c·∫£nh v√† Vai tr√≤:**
B·∫°n l√† m·ªôt AI chuy√™n gia ph√¢n t√≠ch chi·∫øn l∆∞·ª£c th·ªã tr∆∞·ªùng b√°n l·∫ª, ƒë∆∞·ª£c cung c·∫•p m·ªôt b·ªô d·ªØ li·ªáu (SST) g·ªìm **{num_products}** s·∫£n ph·∫©m c√† ph√™ t·ª´ **{num_brands}** th∆∞∆°ng hi·ªáu kh√°c nhau t·∫°i Vi·ªát Nam, ƒë∆∞·ª£c thu th·∫≠p trong kho·∫£ng th·ªùi gian nƒÉm **{current_year}**. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ƒë∆∞a ra c√°c k·∫øt lu·∫≠n v√† khuy·∫øn ngh·ªã chi·∫øn l∆∞·ª£c d·ª±a tr√™n d·ªØ li·ªáu n√†y, tr·∫£ l·ªùi c√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng theo m·ªôt t∆∞ duy ph√¢n t√≠ch s√¢u s·∫Øc.

**T∆∞ t∆∞·ªüng Ph√¢n t√≠ch C·ªët l√µi (Core Analytical Philosophy):**
Khi ph√¢n t√≠ch, h√£y lu√¥n ghi nh·ªõ nh·ªØng nguy√™n t·∫Øc sau:
1.  **Th·ªã tr∆∞·ªùng l√† ƒëa t·∫ßng, kh√¥ng ph·∫≥ng:** ƒê·ª´ng nh√¨n v√†o gi√° trung b√¨nh m·ªôt c√°ch ƒë∆°n thu·∫ßn. H√£y ph√¢n t√≠ch th·ªã tr∆∞·ªùng qua c√°c ph√¢n kh√∫c gi√°. D·ªØ li·ªáu cho th·∫•y m·ªôt s·ª± ph√¢n h√≥a r√µ r·ªát:
    * **Ph·ªï th√¥ng (d∆∞·ªõi {price_percentile_25} VND/kg):** Cu·ªôc chi·∫øn v·ªÅ gi√°.
    * **Trung c·∫•p ({price_percentile_25} - {price_percentile_75} VND/kg):** S√¢n ch∆°i c·ªßa c√°c th∆∞∆°ng hi·ªáu chu·ªói v√† c√°c nh√† rang xay m·ªõi n·ªïi, c·∫°nh tranh b·∫±ng s·ª± c√¢n b·∫±ng gi·ªØa ch·∫•t l∆∞·ª£ng v√† gi√°.
    * **Cao c·∫•p & ƒê·∫∑c s·∫£n (tr√™n {price_percentile_75} VND/kg):** C·∫°nh tranh b·∫±ng c√¢u chuy·ªán, s·ª± minh b·∫°ch v√† ch·∫•t l∆∞·ª£ng v∆∞·ª£t tr·ªôi.
2.  **Logistics l√† m·ªôt v≈© kh√≠ chi·∫øn l∆∞·ª£c:** Ch√≠nh s√°ch v·∫≠n chuy·ªÉn ƒë·ªãnh h√¨nh l·∫°i b·∫£n ƒë·ªì c·∫°nh tranh. Ng∆∞·ª°ng freeship (dao ƒë·ªông t·ª´ **{freeship_threshold_min} VND** ƒë·∫øn **{freeship_threshold_max} VND** trong b·ªô d·ªØ li·ªáu n√†y) kh√¥ng ph·∫£i l√† chi ph√≠, m√† l√† m·ªôt c√¥ng c·ª• t√¢m l√Ω ƒë·ªÉ t·ªëi ∆∞u h√≥a gi√° tr·ªã ƒë∆°n h√†ng trung b√¨nh (AOV).
3.  **Minh b·∫°ch x√¢y d·ª±ng l√≤ng tin:** ·ªû ph√¢n kh√∫c cao c·∫•p, kh√°ch h√†ng y√™u c·∫ßu s·ª± minh b·∫°ch tuy·ªát ƒë·ªëi v·ªÅ ngu·ªìn g·ªëc, t·ª∑ l·ªá ph·ªëi tr·ªôn v√† ph∆∞∆°ng ph√°p ch·∫ø bi·∫øn. ƒê√¢y l√† m·ªôt y√™u c·∫ßu b·∫Øt bu·ªôc, kh√¥ng ph·∫£i l√† m·ªôt l·ª±a ch·ªçn.

**D·ªØ li·ªáu T√≥m t·∫Øt t·ª´ SST:**
* **Kho·∫£ng gi√° (ƒë√£ chu·∫©n h√≥a theo kg):** T·ª´ **{price_min_per_kg} VND/kg** ƒë·∫øn **{price_max_per_kg} VND/kg**.
* **C√°c k√™nh b√°n h√†ng ch√≠nh:** **{main_sources}**.
* **Ng∆∞·ª°ng Freeship ph·ªï bi·∫øn:** Dao ƒë·ªông quanh m·ª©c **{freeship_threshold_avg} VND**.

**Y√™u c·∫ßu Nhi·ªám v·ª•:**
D·ª±a tr√™n to√†n b·ªô b·ªëi c·∫£nh, t∆∞ t∆∞·ªüng v√† d·ªØ li·ªáu t√≥m t·∫Øt ·ªü tr√™n, h√£y ∆∞u ti√™n tr·∫£ l·ªùi c√¢u h·ªèi sau c·ªßa ng∆∞·ªùi d√πng:

**"{user_question}"**

**C·ªë g·∫Øng l·ªìng gh√©p c√°c t∆∞ t∆∞·ªüng sau ƒë√¢y m·ªôt c√°ch kh√©o l√©o v√† tinh vi:**
1.  **T·ªïng k·∫øt c√°c Insight Then ch·ªët:** N√™u b·∫≠t nh·ªØng ph√°t hi·ªán quan tr·ªçng nh·∫•t t·ª´ d·ªØ li·ªáu.
2.  **Ph√¢n t√≠ch Ch√¢n dung Kh√°ch h√†ng:** M√¥ t·∫£ c√°c nh√≥m kh√°ch h√†ng m·ª•c ti√™u v√† h√†nh vi c·ªßa h·ªç, ƒë·∫∑c bi·ªát l√† s·ª± nh·∫°y c·∫£m v·ªÅ gi√° v√† logistics.
3.  **Khuy·∫øn ngh·ªã Chi·∫øn l∆∞·ª£c:** ƒê∆∞a ra c√°c ƒë·ªÅ xu·∫•t c·ª• th·ªÉ, c√≥ t√≠nh h√†nh ƒë·ªông v·ªÅ (a) S·∫£n ph·∫©m v√† Gi√°, v√† (b) Logistics v√† Tr·∫£i nghi·ªám Kh√°ch h√†ng.
`;
        if (!(currentLang === 'vn')) {
            promptTemplate = `
**Context and Role:**
You are an expert AI retail market strategist, provided with a dataset (SST) of **{num_products}** coffee products from **{num_brands}** different brands in Vietnam, collected during the year **{current_year}**. Your task is to provide conclusions and strategic recommendations based on this data, answering the user's question with a deep analytical mindset.

**Core Analytical Philosophy:**
When analyzing, always remember these principles:
1.  **The market is layered, not flat:** Don't just look at average prices. Analyze the market through price segments. The data shows a clear differentiation:
    * **Mass-market (below {price_percentile_25} VND/kg):** A price war.
    * **Mid-range ({price_percentile_25} - {price_percentile_75} VND/kg):** The playground for chain brands and emerging roasters, competing on a balance of quality and price.
    * **Premium & Specialty (above {price_percentile_75} VND/kg):** Competition based on story, transparency, and superior quality.
2.  **Logistics is a strategic weapon:** Shipping policies reshape the competitive landscape. The freeship threshold (ranging from **{freeship_threshold_min} VND** to **{freeship_threshold_max} VND** in this dataset) is not a cost, but a psychological tool to optimize average order value (AOV).
3.  **Transparency builds trust:** In the premium segment, customers demand absolute transparency about origin, blend ratios, and processing methods. This is a requirement, not an option.

**Summary Data from SST:**
* **Price Range (normalized per kg):** From **{price_min_per_kg} VND/kg** to **{price_max_per_kg} VND/kg**.
* **Main Sales Channels:** **{main_sources}**.
* **Common Freeship Threshold:** Hovers around **{freeship_threshold_avg} VND**.

**Task Request:**
Based on the entire context, philosophy, and summary data above, prioritize answering the following user question:

**"{user_question}"**

**Try to incorporate the following ideas in a clever and sophisticated way:**
1.  **Key Insights Summary:** Highlight the most important findings from the data.
2.  **Customer Persona Analysis:** Describe the target customer groups and their behaviors, especially their sensitivity to price and logistics.
3.  **Strategic Recommendations:** Provide specific, actionable suggestions on (a) Product and Pricing, and (b) Logistics and Customer Experience.
`;
        }
        
        
        let finalPrompt = promptTemplate;
        for (const key in lang_stats) {
            finalPrompt = finalPrompt.replace(new RegExp(`\\{${key}\\}`, 'g'), lang_stats[key]);
        }
        finalPrompt = finalPrompt.replace('{user_question}', userQuestion);

        return finalPrompt;
    };

    const handleChatSubmit = async () => {
        const chatInput = document.getElementById('chat-input');
        const userQuery = chatInput.value.trim();
        if (!userQuery) return;

        if (!geminiApiKey) {
            document.getElementById('api-key-modal').classList.remove('hidden');
            return;
        }

        addMessage(userQuery, 'user');
        chatInput.value = '';
        chatInput.disabled = true;
        document.getElementById('chat-submit').disabled = true;

        const loadingMsgId = `loading-${Date.now()}`;
        addMessage(translations[currentLang].loading_ai, 'loading', loadingMsgId);

        try {
            const dataForAI = [];
            sstGridOptions.api.forEachNodeAfterFilter(node => dataForAI.push(node.data));
            
            const stats = calculateStats(dataForAI);
            const prompt = generateDynamicPrompt(stats, userQuery);

            if (prompt.startsWith('Error:')) {
                throw new Error(prompt);
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }]
                }]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const result = await response.json();
            
            let botResponse = translations[currentLang].error_ai_response;
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                botResponse = result.candidates[0].content.parts[0].text;
            }
            
            const loadingElement = document.getElementById(loadingMsgId);
            if (loadingElement) loadingElement.remove();
            addMessage(botResponse, 'bot');

        } catch (error) {
            console.error("Error during AI analysis:", error);
            const loadingElement = document.getElementById(loadingMsgId);
            if (loadingElement) loadingElement.remove();
            addMessage(`${translations[currentLang].error_ai} ${error.message}`, 'bot');
        } finally {
            chatInput.disabled = false;
            document.getElementById('chat-submit').disabled = false;
            chatInput.focus();
        }
    };

    const renderTaskQueue = () => {
        const taskQueueBody = document.getElementById('task-queue-body');
        const taskCountSpan = document.getElementById('task-count');
        const taskQueueContainer = document.getElementById('task-queue-container');

        taskQueueBody.innerHTML = '';
        taskCountSpan.textContent = taskQueue.length;
        taskQueueContainer.classList.toggle('hidden', taskQueue.length === 0);

        taskQueue.forEach((task, index) => {
            const taskElement = document.createElement('div');
            taskElement.id = `task-${task.id}`;
            taskElement.className = 'p-2 border rounded-md bg-gray-50';
            
            const isRunning = index === 0;
            const cancelBtnHtml = `
                <button 
                    class="cancel-task-btn text-gray-400 hover:text-red-500 disabled:opacity-50 disabled:cursor-not-allowed" 
                    data-task-id="${task.id}"
                    title="${isRunning ? translations[currentLang].alert_cannot_cancel_task : translations[currentLang].alert_cannot_clear_task}"
                    ${isRunning ? 'disabled' : ''}>
                    &times;
                </button>`;

            taskElement.innerHTML = `
                <div class="flex justify-between items-center text-sm">
                    <span class="font-medium truncate pr-2">${task.id}: ${task.name}</span>
                    ${cancelBtnHtml}
                </div>
                <div class="mt-2 h-2 progress-bar">
                    <div class="h-full progress-bar-fill" style="width: ${task.progress || 0}%;"></div>
                </div>
            `;
            taskQueueBody.appendChild(taskElement);
        });

        document.querySelectorAll('.cancel-task-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const taskId = e.currentTarget.dataset.taskId;
                taskQueue = taskQueue.filter(t => t.id !== taskId);
                renderTaskQueue();
            });
        });
    };
    
    const updateAddAllButtonVisibility = () => {
        const addAllBtn = document.getElementById('add-all-btn');
        let hasNewItems = false;
        sstGridOptions.api.forEachNode(node => {
            if (node.data[translations["vn"].col_update_status] === translations[currentLang].status_new) {
                hasNewItems = true;
            }
        });
        addAllBtn.classList.toggle('hidden', !hasNewItems);
    };

    const processQueue = async () => {
        const checkPriceBtn = document.getElementById('check-price-btn');
        if (taskQueue.length === 0) {
            checkPriceBtn.disabled = false;
            updateAddAllButtonVisibility();
            return;
        }

        checkPriceBtn.disabled = true;
        const task = taskQueue[0];
        renderTaskQueue(); // Re-render to disable the cancel button for the running task
        
        const taskElement = document.getElementById(`task-${task.id}`);
        if (!taskElement) { 
            taskQueue.shift();
            processQueue();
            return;
        }

        const progressBarFill = taskElement.querySelector('.progress-bar-fill');
        task.progress = 0;
        const interval = setInterval(() => {
            if (task.progress < 95) {
                task.progress += 100 / (avgTaskTime / 1000);
                progressBarFill.style.width = `${task.progress}%`;
            }
        }, 1000);
        
        const startTime = Date.now();
        task.controller = new AbortController();
        const signal = task.controller.signal;

        try {
            let selectorForApi = task.selector;
            if (selectorForApi && selectorForApi.trim().startsWith('<')) {
                const generatedSelector = generateSelectorFromHtml(selectorForApi);
                if (generatedSelector) {
                    selectorForApi = generatedSelector;
                } else {
                    throw new Error("Failed to generate selector from raw HTML.");
                }
            }

            const response = await fetch('/api/check-price', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: task.url, selector: selectorForApi }),
                signal
            });

            const result = await response.json();
            const node = sstGridOptions.api.getRowNode(task.id);
            if (node) {
                if (response.ok && result.price !== null) {
                    const newPrice = parseNumericValue(result.price);
                    const oldPrice = parseNumericValue(node.data[translations["vn"].col_list_price]);
                    if (newPrice !== null && oldPrice !== null && newPrice !== oldPrice) {
                        node.data[translations["vn"].col_update_status] = translations[currentLang].status_new;
                        node.data.newPrice = newPrice;
                    } else {
                        node.data[translations["vn"].col_update_status] = translations[currentLang].status_updated;
                    }
                } else {
                    throw new Error(result.error || "Primary scraping failed.");
                }
                sstGridOptions.api.refreshCells({ rowNodes: [node], columns: [translations["vn"].col_update_status] });
            }

        } catch (error) {
            if (error.name === 'AbortError') {
            } else {
                console.warn(`2Primary scraping for ${task.id} failed:`, error.message, ". Attempting fallback.");
                try {
                    const oldPrice = parseNumericValue(task.originalPrice);
                    if (oldPrice === null) throw new Error("No valid original price for fallback.");

                    const fallbackResponse = await fetch('/api/verify-price-by-text', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ url: task.url, price: oldPrice }),
                         signal
                    });
                    const fallbackResult = await fallbackResponse.json();
                    const node = sstGridOptions.api.getRowNode(task.id);
                    if (node) {
                        if (fallbackResponse.ok && fallbackResult.found_uniquely) {
                            node.data[translations["vn"].col_update_status] = translations[currentLang].status_error;
                            node.data.matchCount = 1;
                        } else {
                            node.data[translations["vn"].col_update_status] = translations[currentLang].status_error;
                            node.data.matchCount = fallbackResult.match_count;
                            console.warn(`Fallback for ${task.id} found ${fallbackResult.match_count} matches.`);
                        }
                        sstGridOptions.api.refreshCells({ rowNodes: [node], columns: [translations["vn"].col_update_status], force: true });
                    }
                } catch (fallbackError) {
                     if (fallbackError.name === 'AbortError') {
                    } else {
                        console.error(`Fallback for ${task.id} also failed:`, fallbackError.message);
                        const node = sstGridOptions.api.getRowNode(task.id);
                        if (node) {
                            node.data[translations["vn"].col_update_status] = translations[currentLang].status_error;
                            node.data.matchCount = -1; // Indicate error
                            sstGridOptions.api.refreshCells({ rowNodes: [node], columns: [translations["vn"].col_update_status], force: true });
                        }
                    }
                }
            }
        } finally {
            clearInterval(interval);
            if (taskElement) {
                progressBarFill.style.width = '100%';
            }
            const endTime = Date.now();
            completedTaskTimes.push(endTime - startTime);
            avgTaskTime = completedTaskTimes.reduce((a, b) => a + b, 0) / completedTaskTimes.length;
            
            setTimeout(() => {
                taskQueue.shift();
                renderTaskQueue();
                processQueue();
            }, 500);
        }
    };

    const createNewVersion = (node) => {
        let nextIdSuffix = 0;
        const originalData = node.data;
        const newRowData = { ...originalData }; 

        const originalId = originalData.ID;
        const baseId = originalId.split('-v')[0]; 

        const lastVIndex = originalId.lastIndexOf('-v');

        if (lastVIndex !== -1) {
            const suffixString = originalId.substring(lastVIndex + 2);
            const parsedSuffix = parseInt(suffixString, 10);
            
            if (!isNaN(parsedSuffix)) {
                nextIdSuffix = parsedSuffix;
            }
        }

        nextIdSuffix = nextIdSuffix + 1;

        // Set the new price for the new row
        newRowData[translations["vn"].col_list_price] = originalData.newPrice;
        delete newRowData.newPrice; // Clean up temporary property
        delete newRowData.matchCount; // Clean up temporary property

        newRowData.ID = `${baseId}-v${nextIdSuffix}`;
        newRowData[translations["vn"].col_date_added] = getFormattedDate();
        newRowData[translations["vn"].col_update_status] = translations[currentLang].status_updated;

        // Prepare the old row for update
        const updatedOriginalData = { ...originalData };
        delete updatedOriginalData.newPrice; // Clean up temporary property
        delete updatedOriginalData.matchCount; // Clean up temporary property
        updatedOriginalData[translations["vn"].col_update_status] = translations[currentLang].status_outdated;
        
        const originalIndexInMaster = sst_data.findIndex(item => item.ID === originalData.ID);
        if (originalIndexInMaster !== -1) {
            sst_data[originalIndexInMaster] = updatedOriginalData;
            sst_data.splice(originalIndexInMaster + 1, 0, newRowData); 
        }

        // Apply changes to the grid
        sstGridOptions.api.applyTransaction({
            add: [newRowData],
            update: [updatedOriginalData]
        });
    };

    const statusCellRenderer = (params) => {
        if (getOriginalLangUpdateStatus(params.value) === "M·ªõi") {
            const btn = document.createElement('button');
            btn.innerHTML = `${translations[currentLang].status_new} (${translations[currentLang].status_add_btn})`;
            btn.className = 'add-new-version-btn bg-yellow-400 text-yellow-900 text-xs font-bold py-1 px-2 rounded hover:bg-yellow-500';
            btn.dataset.nodeId = params.node.id;
            return btn;
        }
        if (getOriginalLangUpdateStatus(params.value) === "L·ªói") {
            const btn = document.createElement('button');
            const matchCount = params.data.matchCount;
            let errorText = translations[currentLang].status_error;
            let btnClass = 'bg-red-500 hover:bg-red-700'; // Default to red for error

            if (typeof matchCount === 'number' && matchCount > 0) {
                errorText = translations[currentLang].status_warning;
                if (matchCount > 1) {
                    errorText = `${translations[currentLang].status_warning} (${matchCount})`;
                }
                
                btnClass = 'bg-amber-500 hover:bg-amber-600'; // Change to amber for warning

            } else if (matchCount === 0) {
                errorText = translations[currentLang].status_error;
            }

            btn.innerHTML = `${errorText} (${translations[currentLang].status_remove_btn})`;
            btn.className = `${btnClass} text-white text-xs font-bold py-1 px-2 rounded`;
            btn.addEventListener('click', () => {
                const rowId = params.node.data.ID;
                sst_data = sst_data.filter(item => item.ID !== rowId);
                const fromDate = picker.getStartDate();
                const toDate = picker.getEndDate();

                applyAllFilters(fromDate.dateInstance, toDate.dateInstance, true);
            });
            return btn;
        }
        if (getOriginalLangUpdateStatus(params.value) === "ƒê√£") {
             return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">${translations[currentLang].status_updated}</span>`;
        }
        if (getOriginalLangUpdateStatus(params.value) === "C≈©") {
             return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">${translations[currentLang].status_outdated}</span>`;
        }
        return params.value || translations[currentLang].status_not_checked;
    };

    const getColumnDefs = (lang, editMode = false) => {
        const t = translations[lang];
        const columnDefinitions = [
            { headerName: "ID", field: "ID", minWidth: 80, sortable: true, filter: true, editable: false, hide: !(visibilityState["ID"] || true) },
            { headerName: t.col_header_status_update, field: "T√¨nh tr·∫°ng Gi√°", minWidth: 120, cellRenderer: statusCellRenderer, editable: false, hide: !(visibilityState["T√¨nh tr·∫°ng Gi√°"] || true) },
            { headerName: t.col_header_product, field: "S·∫£n ph·∫©m", flex: 2, minWidth: 150, sortable: true, filter: true, wrapText: true, autoHeight: true, hide: !(visibilityState["S·∫£n ph·∫©m"] || true) },
            { headerName: t.col_header_brand, field: "Th∆∞∆°ng hi·ªáu", flex: 1, minWidth: 100, sortable: true, filter: true, hide: !(visibilityState["Th∆∞∆°ng hi·ªáu"] || true) },
            { 
                headerName: t.col_header_list_price, 
                field: "Gi√° ni√™m y·∫øt (VND)", 
                minWidth: 120, 
                sortable: true, 
                filter: 'agNumberColumnFilter',
                hide: !(visibilityState["Gi√° ni√™m y·∫øt (VND)"] || true)
            },
            {
                headerName: t.col_header_date_added,
                field: "Ng√†y Th√™m", 
                minWidth: 100,
                sortable: true,
                filter: 'agDateColumnFilter',
                hide: !(visibilityState["Ng√†y Th√™m"] || true)
            },
            { 
                headerName: t.col_header_shipping_fee, 
                field: "Ph√≠ ship (VND)", 
                minWidth: 120,
                filter: 'agNumberColumnFilter',
                hide: !(visibilityState["Ph√≠ ship (VND)"] || true)
            },
            { 
                headerName: t.col_header_freeship_threshold, 
                field: "Ng∆∞·ª°ng Freeship (VND)", 
                minWidth: 140,
                filter: 'agNumberColumnFilter',
                hide: !(visibilityState["Ng∆∞·ª°ng Freeship (VND)"] || true)
            },
            { headerName: t.col_header_source, field: translations["vn"].col_source, flex: 1, minWidth: 100, sortable: true, filter: true, hide: !(visibilityState[translations["vn"].col_source] || false) },
            { headerName: t.col_header_coffee_type, field: translations["vn"].col_coffee_type, flex: 1, minWidth: 120, sortable: true, filter: true, wrapText: true, autoHeight: true, hide: !(visibilityState[translations["vn"].col_coffee_type] || false) },
            { headerName: t.col_header_unit, field: translations["vn"].col_unit, minWidth: 100, sortable: true, filter: true, hide: !(visibilityState[translations["vn"].col_unit] || false) },
            { headerName: t.col_header_location, field: translations["vn"].col_location, flex: 1, minWidth: 100, sortable: true, filter: true, hide: !(visibilityState[translations["vn"].col_location] || false) },
            { headerName: t.col_header_link, field: translations["vn"].col_link, minWidth: 80, hide: !(visibilityState[translations["vn"].col_link] || true) },
            { headerName: t.col_header_html_selector, field: translations["vn"].col_html_selector, flex: 2, minWidth: 150, wrapText: true, autoHeight: true, hide: !(visibilityState[translations["vn"].col_html_selector] || false) },
            { headerName: t.col_header_ecommerce_platform, field: translations["vn"].col_ecommerce_platform, flex: 1, minWidth: 120, sortable: true, filter: true, hide: !(visibilityState[translations["vn"].col_ecommerce_platform] || false) },
        ];

        // Apply raw mode specific settings
        columnDefinitions.forEach(colDef => {
            if (colDef.field !== "ID" && colDef.field !== "T√¨nh tr·∫°ng Gi√°") {
                colDef.editable = editMode;
                if (editMode) {
                    // Remove formatters and custom renderers in raw mode
                    delete colDef.valueFormatter;
                    // For 'Link M√¥ t·∫£' only, we still want the <a> tag, but no special formatting
                    if (colDef.field !== translations["vn"].col_link) {
                        delete colDef.cellRenderer;
                    }
                } else {
                    // Reapply formatters and custom renderers when not in raw mode
                    if (colDef.field === "Gi√° ni√™m y·∫øt (VND)") {
                        colDef.valueFormatter = p => {
                            const value = parseNumericValue(p.value);
                            const locale = lang === 'vn' ? 'vi-VN' : 'en-US';
                            return value !== null ? value.toLocaleString(locale) + '‚Ç´' : 'N/A';
                        };
                    } else if (colDef.field === "Ng√†y Th√™m") {
                        colDef.valueFormatter = p => {
                            let dateValue = p.value;
                            if (typeof dateValue === 'string') {
                                dateValue = parseDateString(dateValue, currentLang); 
                            }
                            if (dateValue instanceof Date && !isNaN(dateValue)) {
                                const locale = currentLang === 'vn' ? 'vi-VN' : 'en-US';
                                const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                                return new Intl.DateTimeFormat(locale, options).format(dateValue);
                            }
                            return '';
                        };
                    } else if (colDef.field === "Ph√≠ ship (VND)" || colDef.field === "Ng∆∞·ª°ng Freeship (VND)") {
                         colDef.valueFormatter = p => {
                            const value = parseNumericValue(p.value);
                            const locale = lang === 'vn' ? 'vi-VN' : 'en-US';
                            return value !== null ? value.toLocaleString(locale) + '‚Ç´' : 'N/A';
                        };
                    } else if (colDef.field === translations["vn"].col_link) {
                        colDef.cellRenderer = p => p.value ? `<a href="${p.value}" target="_blank" class="text-blue-600 hover:underline">View</a>` : '';
                    }
                }
            }
        });

        return columnDefinitions;
    };


    // --- 5. UI INITIALIZATION & EVENT LISTENERS ---
    
    sstGridOptions = {
        columnDefs: getColumnDefs(savedLang),
        defaultColDef: { 
            resizable: true, 
            sortable: true, 
            filter: true,
            autoSizeStrategy: {
                type: 'fitGridWidth',
                // Define minWidth for important columns to ensure readability
                columnLimits: [
                    { colId: 'ID', minWidth: 80 },
                    { colId: 'T√¨nh tr·∫°ng Gi√°', minWidth: 120 },
                    { colId: 'S·∫£n ph·∫©m', minWidth: 150 },
                    { colId: 'Th∆∞∆°ng hi·ªáu', minWidth: 100 },
                    { colId: 'Gi√° ni√™m y·∫øt (VND)', minWidth: 120 },
                    { colId: 'Ng√†y Th√™m', minWidth: 100 },
                    { colId: 'Ph√≠ ship (VND)', minWidth: 120 },
                    { colId: 'Ng∆∞·ª°ng Freeship (VND)', minWidth: 140 },
                    { colId: 'Link', minWidth: 80 },
                    { colId: 'HTML', minWidth: 150 },
                    { colId: 'TMƒêT', minWidth: 120 },
                    { colId: 'Ngu·ªìn', minWidth: 100 },
                    { colId: 'Lo·∫°i SP', minWidth: 120 },
                    { colId: 'ƒê∆°n v·ªã t√≠nh', minWidth: 100 },
                    { colId: 'ƒê·ªãa ph∆∞∆°ng', minWidth: 100 },
                ]
            }
        },
        getRowId: params => params.data.ID,
        onFilterChanged: updateChartsFromGridData,
        onSortChanged: updateChartsFromGridData,
        onGridReady: (params) => {
            // Now the API is ready
            updateChartsFromGridData();
        }
    };
    
    const sstGridDiv = document.querySelector('#sstGrid');
    new agGrid.Grid(sstGridDiv, sstGridOptions);

    const picker = new Litepicker({
        element: document.getElementById('datepicker'),
        singleMode: false,
        format: 'YYYY-MM-DD',
        setup: (p) => {
            p.on('selected', (d1, d2) => {
                applyAllFilters(d1.dateInstance, d2.dateInstance);
            });
        },
    });

    const chatInput = document.getElementById('chat-input');
    const chatSubmit = document.getElementById('chat-submit');
    const promptButtons = document.querySelectorAll('.prompt-btn');
    promptButtons.forEach(button => {
        button.addEventListener('click', () => {
            chatInput.value = button.textContent;
            handleChatSubmit();
        });
    });
    chatSubmit.addEventListener('click', handleChatSubmit);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleChatSubmit();
    });
    
    const tabs = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
             tabs.forEach(t => t.classList.remove('active'));
             tab.classList.add('active');
             const target = tab.getAttribute('data-tab');
             tabContents.forEach(content => {
                 content.classList.remove('active');
                 if (content.id === target) content.classList.add('active');
             });
             
             if(target === 'aiAnalysisTab' && !geminiApiKey) {
                document.getElementById('api-key-modal').classList.remove('hidden');
             }

            updateChartsFromGridData();
        });
    });
    
    document.getElementById('check-price-btn').addEventListener('click', () => {
        if (taskQueue.length > 0) {
            alert(translations[currentLang].alert_in_progress);
            return;
        }
        sstGridOptions.api.forEachNodeAfterFilterAndSort(node => {
            if (node.data[translations["vn"].col_update_status] !== translations[currentLang].status_outdated){
                taskQueue.push({
                    id: node.data.ID,
                    name: node.data[translations["vn"].col_product],
                    url: node.data[translations["vn"].col_link],
                    selector: node.data[translations["vn"].col_html_selector],
                    originalPrice: node.data[translations["vn"].col_list_price]
                });
            }
            
        });
        renderTaskQueue();
        processQueue();
    });

    sstGridDiv.addEventListener('click', (event) => {
        if (event.target.matches('.add-new-version-btn')) {
            const nodeId = event.target.dataset.nodeId;
            const node = sstGridOptions.api.getRowNode(nodeId);
            if (node) {
                createNewVersion(node);
                updateAddAllButtonVisibility();
            }
        }
    });
    
    document.getElementById('add-all-btn').addEventListener('click', () => {
        const nodesToUpdate = [];
        sstGridOptions.api.forEachNode(node => {
            if(node.data[translations["vn"].col_update_status] === translations[currentLang].status_new) {
                nodesToUpdate.push(node);
            }
        });
        for(let i = nodesToUpdate.length - 1; i >= 0; i--) {
            createNewVersion(nodesToUpdate[i]);
        }
        updateAddAllButtonVisibility();
    });

    const addDataBtn = document.getElementById('add-data-btn');
    const csvFileInput = document.getElementById('csv-file-input');

    addDataBtn.addEventListener('click', () => {
        csvFileInput.click();
    });

    const detectLanguage = (header) => {
        currentKeyColumns = [
            translations[currentLang].col_product,
            translations[currentLang].col_brand,
            translations[currentLang].col_list_price,
            translations[currentLang].col_date_added,
            translations[currentLang].col_shipping_fee,
            translations[currentLang].col_freeship_threshold,
            translations[currentLang].col_source,
            translations[currentLang].col_coffee_type,
            translations[currentLang].col_unit,
            translations[currentLang].col_location,
            translations[currentLang].col_link,
            translations[currentLang].col_ecommerce_platform,
            translations[currentLang].col_update_status
        ];

        let is_col_exist = false;
        header.forEach((colName, index) => {
            if (currentKeyColumns.includes(colName)) {
                is_col_exist = 1;
            }
        });

        if (!is_col_exist) {
            alert(translations[currentLang].alert_lang_detect);
            currentLang = (currentLang === "vn") ? "en" : "vn";

            languageSwitcher.value = currentLang;
            setLanguage(currentLang);
        }
    };


    csvFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) {
                alert(translations[currentLang].alert_invalid_csv);
                csvFileInput.value = '';
                return;
            }

            const header = parseCsvLine(lines.shift()).map(h => h.replace(/"/g, ''));
            
            detectLanguage(header);
            
            // --- FIX STARTS HERE ---
            const existingIds = new Set(sst_data.map(item => item.ID));
            let idCounter = 0;

            const newSstEntries = lines.map(line => {
                const values = parseCsvLine(line);
                if (values.length !== header.length) {
                    console.warn('Skipping malformed CSV line:', line);
                    return null;
                }
                const rowData = {};
                header.forEach((colName, index) => {
                    rowData[colName] = values[index] ? values[index].replace(/"/g, '').trim() : null;
                });
                
                let finalId = rowData['ID'];
                if (!finalId || finalId.trim() === '') {
                    while (true) {
                        const nextId = `ID${String(idCounter).padStart(3, '0')}`;
                        if (!existingIds.has(nextId)) {
                            finalId = nextId;
                            existingIds.add(finalId); // Th√™m ID m·ªõi v√†o b·ªô ƒë·ªám ngay l·∫≠p t·ª©c
                            break;
                        }
                        idCounter++;
                    }
                }

                const parsedDate = parseDateString(rowData[translations[currentLang].col_date_added], currentLang);
                return {
                    "ID": finalId,
                    "S·∫£n ph·∫©m": rowData[translations[currentLang].col_product] || '',
                    "Th∆∞∆°ng hi·ªáu": rowData[translations[currentLang].col_brand] || '',
                    "Ngu·ªìn": rowData[translations[currentLang].col_source] || '',
                    "Link": rowData[translations[currentLang].col_link] || '',
                    "Lo·∫°i SP": rowData[translations[currentLang].col_coffee_type] || '',
                    "ƒê∆°n v·ªã t√≠nh": rowData[translations[currentLang].col_unit] || '',
                    "Gi√° ni√™m y·∫øt (VND)": rowData[translations[currentLang].col_list_price],
                    "Ph√≠ ship (VND)": rowData[translations[currentLang].col_shipping_fee],
                    "Ng∆∞·ª°ng Freeship (VND)": rowData[translations[currentLang].col_freeship_threshold],
                    "ƒê·ªãa ph∆∞∆°ng": rowData[translations[currentLang].col_location] || '',
                    "HTML": rowData[translations[currentLang].col_html_selector] || '',
                    "Ng√†y Th√™m": parsedDate ? parsedDate.toISOString().split('T')[0] : getFormattedDate(),
                    "T√¨nh tr·∫°ng Gi√°": getOriginalLangUpdateStatus(rowData[translations[currentLang].col_update_status]) === 'C≈©' ? 'C≈©' : 'ƒê√£',
                    "TMƒêT": rowData[translations[currentLang].col_ecommerce_platform] || ''
                };
            }).filter(entry => entry !== null);
            // --- FIX ENDS HERE ---

            if (newSstEntries.length === 0) {
                alert(translations[currentLang].alert_no_valid_data);
                csvFileInput.value = '';
                return;
            }

            sst_data.push(...newSstEntries);
            currentFilteredData = [...sst_data]; // Reset filtered data to include new entries
            if (sstGridOptions && sstGridOptions.api) {
                sstGridOptions.api.setRowData(currentFilteredData);
            }
            
            if (sst_data.length > 0) {
                const pallDates = sst_data
                    .map(item => parseDateString(item[translations["vn"].col_date_added], currentLang))
                allDates = pallDates.filter(d => d !== null && !isNaN(d.getTime()));
                if (allDates.length > 0) {
                    const allTimestamps = allDates.map(d => d.getTime());
                    const minDate = new Date(Math.min.apply(null, allTimestamps) || '2025-05-23');
                    const maxDate = new Date(Math.max.apply(null, allTimestamps) || '2025-07-06');
                    picker.setDateRange(minDate, maxDate, true);
                    const fromDate = picker.getStartDate();
                    const toDate = picker.getEndDate();
                    applyAllFilters(fromDate.dateInstance, toDate.dateInstance);
                } else {
                    picker.clearSelection();
                    applyAllFilters(null, null);
                }
            } else {
                const fromDate = picker.getStartDate();
                const toDate = picker.getEndDate();
                applyAllFilters(fromDate.dateInstance, toDate.dateInstance);
            }

            alert(`${newSstEntries.length} ${translations[currentLang].alert_rows_added}`);
        };
        reader.readAsText(file, 'UTF-8');
        event.target.value = '';
    });
    
    document.getElementById('toggle-queue-btn').addEventListener('click', () => {
        document.getElementById('task-queue-body').classList.toggle('hidden');
        document.querySelector('#toggle-queue-btn svg').classList.toggle('rotate-180');
        adjustTaskQueuePosition();
    });
    
    document.getElementById('clear-pending-tasks-btn').addEventListener('click', () => {
        if (taskQueue.length > 1) {
            const runningTask = taskQueue[0];
            taskQueue = [runningTask];
            renderTaskQueue();
            processQueue();
        }
    });

    document.getElementById('to-csv-btn').addEventListener('click', () => {
        let sstGridOptionsData = [];
        sstGridOptions.api.forEachNodeAfterFilterAndSort(node => {
            sstGridOptionsData.push(node.data);
        });
      if (!sstGridOptionsData || sstGridOptionsData.length === 0) {
        alert(translations[currentLang].alert_no_export_data);
        return;
      }

      const csvHeaders = [
          "col_id", "col_product", "col_brand", "col_source", "col_link", "col_coffee_type",
          "col_unit", "col_list_price", "col_shipping_fee", "col_freeship_threshold",
          "col_location", "col_html_selector", "col_date_added", "col_update_status", "col_ecommerce_platform"
      ];
      const dataForCsv = sstGridOptionsData.map(row => ({
          "ID": row["ID"],
          "S·∫£n ph·∫©m": row["S·∫£n ph·∫©m"],
          "Th∆∞∆°ng hi·ªáu": row["Th∆∞∆°ng hi·ªáu"],
          "Ngu·ªìn": row["Ngu·ªìn"],
          "Link": row["Link"],
          "Lo·∫°i SP": row["Lo·∫°i SP"],
          "ƒê∆°n v·ªã t√≠nh": row["ƒê∆°n v·ªã t√≠nh"],
          "Gi√° ni√™m y·∫øt (VND)": row["Gi√° ni√™m y·∫øt (VND)"],
          "Ph√≠ ship (VND)": row["Ph√≠ ship (VND)"],
          "Ng∆∞·ª°ng Freeship (VND)": row["Ng∆∞·ª°ng Freeship (VND)"],
          "ƒê·ªãa ph∆∞∆°ng": row["ƒê·ªãa ph∆∞∆°ng"],
          "HTML": row["HTML"],
          "Ng√†y Th√™m": row["Ng√†y Th√™m"],
          "T√¨nh tr·∫°ng Gi√°": row["T√¨nh tr·∫°ng Gi√°"],
          "TMƒêT": row["TMƒêT"]
      }));
      
      const csvContent = [
        csvHeaders.map(header => translations[currentLang][header]).join(','),
        ...dataForCsv.map(row =>
          csvHeaders.map(header => {
            let val = (row[translations["vn"][header]] ?? '').toString();
            if (val.includes(',')) {
                val = `"${val.replace(/"/g, '""')}"`;
            }
            return val;
          }).join(',')
        )
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', translations[currentLang].download_file_name);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    const helpModal = document.getElementById('help-modal');
    const helpModalBody = document.getElementById('help-modal-body');
    const helpBtn = document.getElementById('help-btn');
    const closeHelpBtn = document.getElementById('close-help-btn');
    let hasScrolledToBottom = false;

    // M·ªü modal khi nh·∫•n n√∫t Tr·ª£ gi√∫p
    helpBtn.addEventListener('click', () => {
        helpModal.classList.remove('hidden');
    });

    // ƒê√≥ng modal khi nh·∫•n n√∫t 'X'
    closeHelpBtn.addEventListener('click', () => {
        if (localStorage.getItem("hasSeenHelp")) {
            hasScrolledToBottom = true;
        }

        if (hasScrolledToBottom) {
            helpModal.classList.add('hidden');
            localStorage.setItem("hasSeenHelp", "true");
        } else {
            // üëá Auto scroll xu·ªëng ƒë√°y
            helpModalBody.scrollTop = helpModalBody.scrollHeight;
        }
        
    });

    // ƒê√≥ng modal khi nh·∫•n v√†o l·ªõp ph·ªß b√™n ngo√†i
    helpModal.addEventListener('click', (event) => {
        // Ch·ªâ ƒë√≥ng n·∫øu ng∆∞·ªùi d√πng nh·∫•n tr·ª±c ti·∫øp v√†o l·ªõp ph·ªß m√†u ƒëen
        if (event.target === helpModal) {
            if (localStorage.getItem("hasSeenHelp")) {
                hasScrolledToBottom = true;
            }

            if (hasScrolledToBottom) {
                helpModal.classList.add('hidden');
                localStorage.setItem("hasSeenHelp", "true");
            } else {
                // üëá Auto scroll xu·ªëng ƒë√°y
                helpModalBody.scrollTop = helpModalBody.scrollHeight;
            }
        }
    });

    const settingsModal = document.getElementById('settings-modal');
    document.getElementById('settings-btn').addEventListener('click', () => {
        const list = document.getElementById('settings-list');
        list.innerHTML = ''; // Clear previous items
        
        const allColumns = sstGridOptions.api.getColumns();
        if (!allColumns) return; // Grid API not ready yet

        allColumns.forEach(col => {
            const colDef = col.getColDef();
            const key = colDef.field;
            const headerName = colDef.headerName;
            
            const controlRow = document.createElement('div');
            controlRow.className = 'flex items-center justify-between p-1 rounded hover:bg-gray-100';

            const label = document.createElement('label');
            label.className = 'flex items-center space-x-2 cursor-pointer flex-grow';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = key;
            checkbox.checked = deduplicationKeys.includes(key);
            checkbox.className = 'form-checkbox h-5 w-5 text-purple-600 rounded focus:ring-purple-500';
            
            const span = document.createElement('span');
            span.textContent = headerName;
            
            label.appendChild(checkbox);
            label.appendChild(span);
            
            const visibilityBtn = document.createElement('button');
            visibilityBtn.className = 'p-1 rounded-full hover:bg-gray-200';
            visibilityBtn.dataset.colId = col.getColId();
            const isVisible = col.isVisible();
            visibilityBtn.innerHTML = isVisible 
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>` 
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>`;
            
            visibilityBtn.addEventListener('click', (e) => {
                const btn = e.currentTarget;
                const isCurrentlyVisible = btn.dataset.visible === 'true';
                btn.dataset.visible = !isCurrentlyVisible;
                btn.innerHTML = !isCurrentlyVisible
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>` 
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>`;
            });
            visibilityBtn.dataset.visible = isVisible;

            controlRow.appendChild(visibilityBtn);
            controlRow.appendChild(label);
            list.appendChild(controlRow);
        });
        settingsModal.classList.remove('hidden');
    });

    document.getElementById('cancel-settings-btn').addEventListener('click', () => {
        document.getElementById('settings-modal').classList.add('hidden');
    });

    document.getElementById('apply-settings-btn').addEventListener('click', () => {
        const list = document.getElementById('settings-list');
        const newKeys = [];

        list.querySelectorAll('label').forEach(label => {
            const checkbox = label.querySelector('input[type="checkbox"]');
            const key = checkbox.value;
            if (checkbox.checked) {
                newKeys.push(key);
            }
        });
        
        list.querySelectorAll('button').forEach(btn => {
            const colId = btn.dataset.colId;
            const isVisible = btn.dataset.visible === 'true';
            visibilityState[colId] = isVisible;
        });

        deduplicationKeys = newKeys;
        const colIds = Object.keys(visibilityState);
        const colsToShow = colIds.filter(id => visibilityState[id]);
        const colsToHide = colIds.filter(id => !visibilityState[id]);
        sstGridOptions.api.setColumnsVisible(colsToHide, false);
        sstGridOptions.api.setColumnsVisible(colsToShow, true);
        

        const fromDate = picker.getStartDate();
        const toDate = picker.getEndDate();

        applyAllFilters(fromDate.dateInstance, toDate.dateInstance);
        document.getElementById('settings-modal').classList.add('hidden');
    });

    const apiKeyModal = document.getElementById('api-key-modal');
    document.getElementById('save-api-key-btn').addEventListener('click', () => {
        const keyInput = document.getElementById('gemini-api-key-input');
        const key = keyInput.value.trim();
        if (key) {
            geminiApiKey = key;
            sessionStorage.setItem('geminiApiKey', key);
            apiKeyModal.classList.add('hidden');
            handleChatSubmit(); // Automatically submit after saving key
        } else {
            alert(translations[currentLang].alert_enter_api_key);
        }
    });
    document.getElementById('cancel-api-key-btn').addEventListener('click', () => {
        apiKeyModal.classList.add('hidden');
    });

    defaultShipFeeInput = document.getElementById('input-default-ship-fee');

    defaultShipFeeInput.addEventListener('change', () => {
        updateChartsFromGridData();
    });

    defaultShipFeeInput.addEventListener('blur', () => {
        // N·∫øu gi√° tr·ªã sau khi c·∫Øt b·ªè kho·∫£ng tr·∫Øng l√† r·ªóng...
        if (defaultShipFeeInput.value.trim() === '') {
            // ...th√¨ ƒë·∫∑t l·∫°i gi√° tr·ªã l√† 30000
            defaultShipFeeInput.value = 30000;

            // K√≠ch ho·∫°t s·ª± ki·ªán 'input' m·ªôt c√°ch nh√¢n t·∫°o ƒë·ªÉ bi·ªÉu ƒë·ªì c·∫≠p nh·∫≠t theo gi√° tr·ªã m·ªõi
            defaultShipFeeInput.dispatchEvent(new Event('input'));
        }
    });

    // L·∫•y c√°c ph·∫ßn t·ª≠ t·ª´ DOM
    const taskQueueContainer = document.getElementById('task-queue-container');
    const taskQueueHeader = document.getElementById('task-queue-header');

    // K√≠ch ho·∫°t ch·ª©c nƒÉng k√©o-th·∫£
    makeDraggable(taskQueueContainer, taskQueueHeader);

    // --- LANGUAGE SWITCHER LOGIC ---
    const setLanguage = (lang) => {
        currentLang = lang;
        localStorage.setItem('language', lang);
        document.documentElement.lang = lang;
        
        const langDict = translations[lang];

        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.getAttribute('data-lang-key');
            if(langDict[key]) {
                innerHTML = langDict[key];
                if (key === "edit_mode_btn") {
                    if (!isEditMode) {
                        innerHTML = langDict["edit_mode_btn"];
                    } else {
                        innerHTML = langDict["view_mode_btn"];
                    }
                }
                el.innerHTML = innerHTML;
            }
        });

        document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
            const key = el.getAttribute('data-lang-key-placeholder');
            if(langDict[key]) {
                el.placeholder = langDict[key];
            }
        });
        
        document.querySelectorAll('[data-lang-key-title]').forEach(el => {
            const key = el.getAttribute('data-lang-key-title');
            if(langDict[key]) {
                el.title = langDict[key];
            }
        });

        // Update AG-Grid headers
        if (sstGridOptions.api) {
            sstGridOptions.api.setColumnDefs(getColumnDefs(lang));
        }

        const fromDate = picker.getStartDate();
        const toDate = picker.getEndDate();
        applyAllFilters(fromDate.dateInstance, toDate.dateInstance);
        // Update charts
        updateChartsFromGridData();
    };
    
    const languageSwitcher = document.getElementById('language-switcher');
    languageSwitcher.addEventListener('change', (e) => {
        setLanguage(e.target.value);
    });

    const setViewMode = (is_view=true) => {
        if (is_view) {
            // If in Edit Mode, set button to purple and show "Ch·∫ø ƒë·ªô Ch·ªânh s·ª≠a" with the complex code icon (</>)
            toggleButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            toggleButton.classList.add('bg-purple-600', 'hover:bg-purple-700');
            toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
            </svg>`;
        } else {
            // If in View Mode, set button to green and show "Ch·∫ø ƒë·ªô Xem" with the simpler code icon (<>)
            toggleButton.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            toggleButton.classList.add('bg-green-600', 'hover:bg-green-700');
            toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 8l-4 4 4 4m10-8l4 4-4 4" />
            </svg>`;
        }
        
        isEditMode = !is_view;
        sstGridOptions.api.setColumnDefs(getColumnDefs(currentLang, isEditMode));
    };

    // --- Edit Mode Toggle ---
    toggleButton = document.getElementById('toggle-edit-mode-btn');
    toggleButton.addEventListener('click', () => {
        setViewMode(isEditMode);

    });


    // --- 6. INITIAL LOAD ---
    const endDate = new Date('2025-07-06');
    const startDate = new Date('2025-05-23');
    picker.setDateRange(startDate, endDate);
    languageSwitcher.value = savedLang;
    setLanguage(savedLang);

    // --- 7. CHECK FOR FIRST TIME HELP MODAL ---\
    if (!localStorage.getItem("hasSeenHelp")) {
      helpModalBody.addEventListener("scroll", function () {
        const isBottom = helpModalBody.scrollTop + helpModalBody.clientHeight >= helpModalBody.scrollHeight - 5;
        if (isBottom) {
          hasScrolledToBottom = true;
        }
      });
      if (helpModal) {
        helpModal.classList.remove('hidden');
      }
    }

    // Apply resizable to all chart containers
    document.querySelectorAll('.chart-container').forEach(makeResizable);
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const isWindows = navigator.userAgent.includes("Windows");
    const scrapingMode = isWindows ? "selenium" : "bs4";
    window.getScrapingMode = () => scrapingMode;

    const versionModeSpan = document.getElementById("version-mode");
    if (versionModeSpan) versionModeSpan.textContent = scrapingMode;

    const modeLabel = document.getElementById("mode-label");
    if (modeLabel) {
        modeLabel.textContent = scrapingMode === 'selenium' ? '·ªïn ƒë·ªãnh' : '∆∞u ti√™n t·ªëc ƒë·ªô';
        modeLabel.classList.add(scrapingMode === 'selenium' ? 'text-green-600' : 'text-orange-500');
    }

    const helpIntro2 = document.querySelector('[data-lang-key="help_intro2"]');
    const helpIntro3 = document.querySelector('[data-lang-key="help_intro3"]');
    if (helpIntro2) {
        helpIntro2.setAttribute("data-lang-key", scrapingMode === 'selenium'
            ? "help_intro2_stable"
            : "help_intro2_speed");
    }
    if (helpIntro3) {
        helpIntro3.setAttribute("data-lang-key", scrapingMode === 'selenium'
            ? "help_intro3_stable"
            : "help_intro3_speed");
    }
});
</script>
</body>
</html>
